<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DroidShows.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">nl.asymmetrics.droidshows</a> &gt; <span class="el_source">DroidShows.java</span></div><h1>DroidShows.java</h1><pre class="source lang-java linenums">/*	AsyncInfo might have the same issue as updateAllSeries() had when show order is changed during iteration...
 * 	Get list of series in another way?
 */

package nl.asymmetrics.droidshows;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FilenameFilter;
import java.io.IOException;
import java.io.OutputStream;
import java.lang.reflect.Method;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.channels.FileChannel;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import org.apache.commons.io.FileUtils;
import nl.asymmetrics.droidshows.R;
import nl.asymmetrics.droidshows.thetvdb.TheTVDB;
import nl.asymmetrics.droidshows.thetvdb.model.Serie;
import nl.asymmetrics.droidshows.thetvdb.model.TVShowItem;
import nl.asymmetrics.droidshows.ui.AddSerie;
import nl.asymmetrics.droidshows.ui.BounceListView;
import nl.asymmetrics.droidshows.ui.IconView;
import nl.asymmetrics.droidshows.ui.SerieSeasons;
import nl.asymmetrics.droidshows.ui.ViewEpisode;
import nl.asymmetrics.droidshows.ui.ViewSerie;
import nl.asymmetrics.droidshows.utils.SQLiteStore;
import nl.asymmetrics.droidshows.utils.SwipeDetect;
import nl.asymmetrics.droidshows.utils.Update;
import nl.asymmetrics.droidshows.utils.Utils;
import nl.asymmetrics.droidshows.utils.SQLiteStore.NextEpisode;
import android.annotation.SuppressLint;
import android.app.ActionBar;
import android.app.AlertDialog;
import android.app.ListActivity;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.ProgressDialog;
import android.app.SearchManager;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager.NameNotFoundException;
import android.content.res.ColorStateList;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.os.Looper;
import android.os.Vibrator;
import android.text.Editable;
import android.text.InputType;
import android.text.TextWatcher;
import android.util.Log;
import android.view.ContextMenu;
import android.view.GestureDetector;
import android.view.GestureDetector.SimpleOnGestureListener;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.MotionEvent;
import android.view.View;
import android.view.View.OnTouchListener;
import android.view.ViewGroup;
import android.view.ContextMenu.ContextMenuInfo;
import android.view.inputmethod.InputMethodManager;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemSelectedListener;
import android.widget.ArrayAdapter;
import android.widget.CheckBox;
import android.widget.EditText;
import android.widget.Filter;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ScrollView;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.AdapterView.AdapterContextMenuInfo;
import android.widget.ToggleButton;

<span class="fc" id="L99">public class DroidShows extends ListActivity</span>
{
	/* Menu items */
	private static final int UNDO_MENU_ITEM = Menu.FIRST;
	private static final int FILTER_MENU_ITEM = UNDO_MENU_ITEM + 1;
	private static final int SEEN_MENU_ITEM = FILTER_MENU_ITEM + 1;
	private static final int SORT_MENU_ITEM = SEEN_MENU_ITEM + 1;
	private static final int TOGGLE_ARCHIVE_MENU_ITEM = SORT_MENU_ITEM + 1;
	private static final int LOG_MODE_ITEM = TOGGLE_ARCHIVE_MENU_ITEM + 1;
	private static final int SEARCH_MENU_ITEM = LOG_MODE_ITEM + 1;
	private static final int ADD_SERIE_MENU_ITEM = SEARCH_MENU_ITEM + 1;
	private static final int UPDATEALL_MENU_ITEM = ADD_SERIE_MENU_ITEM + 1;
	private static final int OPTIONS_MENU_ITEM = UPDATEALL_MENU_ITEM + 1;
	private static final int EXIT_MENU_ITEM = OPTIONS_MENU_ITEM + 1;
	/* Context Menus */
	private static final int VIEW_SEASONS_CONTEXT = Menu.FIRST;
	private static final int VIEW_SERIEDETAILS_CONTEXT = VIEW_SEASONS_CONTEXT + 1;
	private static final int VIEW_EPISODEDETAILS_CONTEXT = VIEW_SERIEDETAILS_CONTEXT + 1;
	private static final int EXT_RESOURCES_CONTEXT = VIEW_EPISODEDETAILS_CONTEXT + 1;
	private static final int MARK_NEXT_EPISODE_AS_SEEN_CONTEXT = EXT_RESOURCES_CONTEXT + 1;
	private static final int TOGGLE_ARCHIVED_CONTEXT = MARK_NEXT_EPISODE_AS_SEEN_CONTEXT + 1;
	private static final int PIN_CONTEXT = TOGGLE_ARCHIVED_CONTEXT + 1;
	private static final int UPDATE_CONTEXT = PIN_CONTEXT + 1;
	private static final int DVDORDER_CONTEXT = UPDATE_CONTEXT + 1;
	private static final int SYNOPSIS_LANGUAGE = DVDORDER_CONTEXT + 1; 
	private static final int DELETE_CONTEXT = SYNOPSIS_LANGUAGE + 1;
	private static AlertDialog m_AlertDlg;
<span class="fc" id="L126">	private static ProgressDialog m_ProgressDialog = null;</span>
<span class="fc" id="L127">	private static ProgressDialog updateAllSeriesPD = null;</span>
	public static SeriesAdapter seriesAdapter;
<span class="fc" id="L129">	private static BounceListView listView = null;</span>
	private static String backFromSeasonSerieId;
	private static TheTVDB theTVDB;
<span class="fc" id="L132">	private Utils utils = new Utils();</span>
	private Update updateDS;
	private static final String PREF_NAME = &quot;DroidShowsPref&quot;;
	private SharedPreferences sharedPrefs;
	private static final String AUTO_BACKUP_PREF_NAME = &quot;auto_backup&quot;;
	private static boolean autoBackup;
	private static final String BACKUP_FOLDER_PREF_NAME = &quot;backup_folder&quot;;
	private static String backupFolder;
	private static final String BACKUP_VERSIONING_PREF_NAME = &quot;backup_versioning&quot;;
	private static boolean backupVersioning;
	private static final String EXCLUDE_SEEN_PREF_NAME = &quot;exclude_seen&quot;;
	private static boolean excludeSeen;
	private static final String SORT_PREF_NAME = &quot;sort&quot;;
	private static final int SORT_BY_NAME = 0;
	private static final int SORT_BY_UNSEEN = 1;
	private static int sortOption;
	private static final String LATEST_SEASON_PREF_NAME = &quot;last_season&quot;;
	private static final int UPDATE_ALL_SEASONS = 0;
	private static final int UPDATE_LATEST_SEASON_ONLY = 1;
	private static int latestSeasonOption;
	private static final String INCLUDE_SPECIALS_NAME = &quot;include_specials&quot;;
	public static boolean includeSpecialsOption;
	private static final String FULL_LINE_CHECK_NAME = &quot;full_line&quot;;
	public static boolean fullLineCheckOption;
	private static final String SWITCH_SWIPE_DIRECTION = &quot;switch_swipe_direction&quot;;
	public static boolean switchSwipeDirection;
	private static final String LAST_STATS_UPDATE_NAME = &quot;last_stats_update&quot;;
	private static String lastStatsUpdateCurrent;
	private static final String LAST_STATS_UPDATE_ARCHIVE_NAME = &quot;last_stats_update_archive&quot;;
	private static String lastStatsUpdateArchive;
	private static final String LANGUAGE_CODE_NAME = &quot;language&quot;;
	private static final String SHOW_NEXT_AIRING = &quot;show_next_airing&quot;;
	public static boolean showNextAiring;
	private static final String MARK_FROM_LAST_WATCHED = &quot;mark_from_last_watched&quot;;
	public static boolean markFromLastWatched;
	private static final String USE_MIRROR = &quot;use_mirror&quot;;
	public static boolean useMirror;
	public static String langCode;
	private static final String PINNED_SHOWS_NAME = &quot;pinned_shows&quot;;
<span class="fc" id="L171">	private static List&lt;String&gt; pinnedShows = new ArrayList&lt;String&gt;();</span>
	private static final String FILTER_NETWORKS_NAME = &quot;filter_networks&quot;;
	private static boolean filterNetworks;
	private static final String NETWORKS_NAME = &quot;networks&quot;;
<span class="fc" id="L175">	private static List&lt;String&gt; networks = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L176">	public static Thread deleteTh = null;</span>
<span class="fc" id="L177">	public static Thread updateShowTh = null;</span>
<span class="fc" id="L178">	public static Thread updateAllShowsTh = null;</span>
	private String dialogMsg;
	public static SQLiteStore db;
	public static List&lt;TVShowItem&gt; series;
<span class="fc" id="L182">	private static List&lt;String[]&gt; undo = new ArrayList&lt;String[]&gt;();</span>
<span class="fc" id="L183">	private SwipeDetect swipeDetect = new SwipeDetect();</span>
	private static AsyncInfo asyncInfo;
	private static EditText searchV;
	private InputMethodManager keyboard;
	private int padding;
	public static int showArchive;
<span class="fc" id="L189">	private Vibrator vib = null;</span>
	private TVShowItem lastSerie;
	private static View main;
<span class="fc" id="L192">	public static boolean logMode = false;</span>
<span class="fc" id="L193">	public static String removeEpisodeFromLog = &quot;&quot;;</span>
	private File[] dirList;
	private String[] dirNamesList;
<span class="fc" id="L196">	private Spinner spinner = null;</span>

	@Override
	public void onCreate(Bundle savedInstanceState) {
<span class="fc" id="L200">		super.onCreate(savedInstanceState);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if (!isTaskRoot()) {	// Prevent multiple instances: https://stackoverflow.com/a/11042163</span>
<span class="nc" id="L202">			final Intent intent = getIntent();</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">			if (intent.hasCategory(Intent.CATEGORY_LAUNCHER) &amp;&amp; Intent.ACTION_MAIN.equals(intent.getAction())) {</span>
<span class="nc" id="L204">				finish();</span>
<span class="nc" id="L205">				return;</span>
			}
		}
<span class="fc" id="L208">		setContentView(R.layout.main);</span>
<span class="fc" id="L209">		main = findViewById(R.id.main);</span>
<span class="fc" id="L210">		db = SQLiteStore.getInstance(this);</span>

		// Preferences
<span class="fc" id="L213">		sharedPrefs = getSharedPreferences(PREF_NAME, 0);</span>
<span class="fc" id="L214">		autoBackup = sharedPrefs.getBoolean(AUTO_BACKUP_PREF_NAME, false);</span>
<span class="fc" id="L215">		backupFolder = sharedPrefs.getString(BACKUP_FOLDER_PREF_NAME, Environment.getExternalStorageDirectory() +&quot;/DroidShows&quot;);</span>
<span class="fc" id="L216">		backupVersioning = sharedPrefs.getBoolean(BACKUP_VERSIONING_PREF_NAME, true);</span>
<span class="fc" id="L217">		excludeSeen = sharedPrefs.getBoolean(EXCLUDE_SEEN_PREF_NAME, false);</span>
<span class="fc" id="L218">		sortOption = sharedPrefs.getInt(SORT_PREF_NAME, SORT_BY_NAME);</span>
<span class="fc" id="L219">		latestSeasonOption = sharedPrefs.getInt(LATEST_SEASON_PREF_NAME, UPDATE_LATEST_SEASON_ONLY);</span>
<span class="fc" id="L220">		includeSpecialsOption = sharedPrefs.getBoolean(INCLUDE_SPECIALS_NAME, false);</span>
<span class="fc" id="L221">		fullLineCheckOption = sharedPrefs.getBoolean(FULL_LINE_CHECK_NAME, false);</span>
<span class="fc" id="L222">		switchSwipeDirection = sharedPrefs.getBoolean(SWITCH_SWIPE_DIRECTION, false);</span>
<span class="fc" id="L223">		lastStatsUpdateCurrent = sharedPrefs.getString(LAST_STATS_UPDATE_NAME, &quot;&quot;);</span>
<span class="fc" id="L224">		lastStatsUpdateArchive = sharedPrefs.getString(LAST_STATS_UPDATE_ARCHIVE_NAME, &quot;&quot;);</span>
<span class="fc" id="L225">		langCode = sharedPrefs.getString(LANGUAGE_CODE_NAME, getString(R.string.lang_code));</span>
<span class="fc" id="L226">		showNextAiring = sharedPrefs.getBoolean(SHOW_NEXT_AIRING, false);</span>
<span class="fc" id="L227">		markFromLastWatched = sharedPrefs.getBoolean(MARK_FROM_LAST_WATCHED, false);</span>
<span class="fc" id="L228">		useMirror = sharedPrefs.getBoolean(USE_MIRROR, false);</span>
<span class="fc" id="L229">		String pinnedShowsStr = sharedPrefs.getString(PINNED_SHOWS_NAME, &quot;&quot;);</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (!pinnedShowsStr.isEmpty())</span>
<span class="fc" id="L231">			pinnedShows = new ArrayList&lt;String&gt;(Arrays.asList(pinnedShowsStr.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).split(&quot;, &quot;)));</span>
<span class="fc" id="L232">		filterNetworks = sharedPrefs.getBoolean(FILTER_NETWORKS_NAME, false);</span>
<span class="fc" id="L233">		String networksStr = sharedPrefs.getString(NETWORKS_NAME, &quot;&quot;);</span>

<span class="fc" id="L235">		updateDatabase();</span>

<span class="pc bpc" id="L237" title="1 of 2 branches missed.">		if (!networksStr.isEmpty())</span>
<span class="fc" id="L238">			networks = new ArrayList&lt;String&gt;(Arrays.asList(networksStr.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).split(&quot;, &quot;)));</span>
<span class="fc" id="L239">		series = new ArrayList&lt;TVShowItem&gt;();</span>
<span class="fc" id="L240">		seriesAdapter = new SeriesAdapter(this, R.layout.row, series);</span>
<span class="fc" id="L241">		setListAdapter(seriesAdapter);</span>
<span class="fc" id="L242">		listView = (BounceListView) getListView();</span>
<span class="fc" id="L243">		listView.setDivider(null);</span>
<span class="fc" id="L244">		listView.setOverscrollHeader(getResources().getDrawable(R.drawable.shape_gradient_ring));</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">		if (savedInstanceState != null) {</span>
<span class="nc" id="L246">			showArchive = savedInstanceState.getInt(&quot;showArchive&quot;);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			getSeries((savedInstanceState.getBoolean(&quot;searching&quot;) ? 2 : showArchive));</span>
		} else {
<span class="fc" id="L249">			getSeries();</span>
		}
<span class="fc" id="L251">		registerForContextMenu(listView);</span>
<span class="fc" id="L252">		listView.setOnTouchListener(swipeDetect);</span>
<span class="fc" id="L253">		searchV = (EditText) findViewById(R.id.search_text);</span>
<span class="fc" id="L254">		searchV.setFocusable(true);</span>
<span class="fc" id="L255">		searchV.setFocusableInTouchMode(true);</span>
<span class="fc" id="L256">		searchV.addTextChangedListener(new TextWatcher() {</span>
			public void onTextChanged(CharSequence s, int start, int before, int count) {
<span class="nc" id="L258">				seriesAdapter.getFilter().filter(s);</span>
<span class="nc" id="L259">			}</span>
<span class="nc" id="L260">			public void beforeTextChanged(CharSequence s, int start, int count, int after) {}</span>
<span class="nc" id="L261">			public void afterTextChanged(Editable s) {}</span>
		});
<span class="fc" id="L263">		keyboard = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</span>
<span class="fc" id="L264">		padding = (int) (6 * (getApplicationContext().getResources().getDisplayMetrics().densityDpi / 160f));</span>
<span class="fc" id="L265">		vib = (Vibrator) getSystemService(Context.VIBRATOR_SERVICE);</span>
<span class="fc" id="L266">	}</span>
	
	private void updateDatabase() {
<span class="fc" id="L269">		updateDS = new Update(db);</span>
<span class="fc" id="L270">		Log.d(SQLiteStore.TAG, &quot;Database update routine&quot;);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">		if (updateDS.needsUpdate()) {</span>
<span class="nc" id="L272">			Log.d(SQLiteStore.TAG, &quot;Database needs update&quot;);</span>
<span class="nc" id="L273">			backup(false, backupFolder);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			if (updateDS.updateDroidShows()) {</span>
<span class="nc" id="L275">				db.updateShowStats();</span>
<span class="nc" id="L276">				Log.d(SQLiteStore.TAG, &quot;Database updated&quot;);</span>
			} else {
<span class="nc" id="L278">				String error = getString(R.string.messages_error_dbupdate);</span>
<span class="nc" id="L279">				Log.e(SQLiteStore.TAG, error);</span>
<span class="nc" id="L280">				Toast.makeText(getApplicationContext(), error, Toast.LENGTH_LONG).show();</span>
			}
		}
<span class="fc" id="L283">	}</span>

	private void setFastScroll() {
<span class="fc" id="L286">		listView.setOverScrollMode(View.OVER_SCROLL_ALWAYS);</span>
<span class="pc bpc" id="L287" title="3 of 4 branches missed.">		listView.setVerticalScrollBarEnabled(!excludeSeen || logMode);</span>
/*		listView.setFastScrollEnabled(!excludeSeen || logMode);
		if (!excludeSeen || logMode) {
			if (seriesAdapter.getCount() &gt; 20) {
				try {	// https://stackoverflow.com/a/26447004
					java.lang.reflect.Field fieldFastScroller = AbsListView.class.getDeclaredField(
						Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP ? &quot;mFastScroll&quot; : &quot;mFastScroller&quot;);
					fieldFastScroller.setAccessible(true);
					Object thisFastScroller = fieldFastScroller.get(listView);
					Drawable thumb = getResources().getDrawable(R.drawable.thumb);
					java.lang.reflect.Field i;

					if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) {
						i = fieldFastScroller.getType().getDeclaredField(&quot;mThumbImage&quot;);
						i.setAccessible(true);
						ImageView iv = (ImageView) i.get(thisFastScroller);
						iv.setImageDrawable(thumb);

						i = fieldFastScroller.getType().getDeclaredField(&quot;mThumbWidth&quot;);
						i.setAccessible(true);
						i.setInt(thisFastScroller, thumb.getIntrinsicWidth());

						i = fieldFastScroller.getType().getDeclaredField(&quot;mTrackImage&quot;);
						i.setAccessible(true);
						i.set(thisFastScroller, null);
					} else {
						i = fieldFastScroller.getType().getDeclaredField(&quot;mThumbDrawable&quot;);
						i.setAccessible(true);
						i.set(thisFastScroller, thumb);

						i = fieldFastScroller.getType().getDeclaredField(&quot;mThumbW&quot;);
						i.setAccessible(true);
						i.setInt(thisFastScroller, thumb.getIntrinsicWidth());

						if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) {
							i = fieldFastScroller.getType().getDeclaredField(&quot;mTrackDrawable&quot;);
							i.setAccessible(true);
							i.set(thisFastScroller, null);
						}
					}
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}
<span class="fc" id="L332">*/	}</span>

	/* Options Menu */
	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
<span class="fc" id="L337">		menu.add(0, UNDO_MENU_ITEM, 0, getString(R.string.menu_undo)).setIcon(android.R.drawable.ic_menu_revert);</span>
<span class="fc" id="L338">		menu.add(0, FILTER_MENU_ITEM, 0, getString(R.string.menu_filter)).setIcon(android.R.drawable.ic_menu_view);</span>
<span class="fc" id="L339">		menu.add(0, SEEN_MENU_ITEM, 0, &quot;&quot;).setIcon(android.R.drawable.ic_menu_myplaces);</span>
<span class="fc" id="L340">		menu.add(0, SORT_MENU_ITEM, 0, &quot;&quot;);</span>
<span class="fc" id="L341">		menu.add(0, TOGGLE_ARCHIVE_MENU_ITEM, 0, &quot;&quot;);</span>
<span class="fc" id="L342">		menu.add(0, LOG_MODE_ITEM, 0, getString(R.string.menu_log)).setIcon(android.R.drawable.ic_menu_agenda);</span>
<span class="fc" id="L343">		menu.add(0, SEARCH_MENU_ITEM, 0, getString(R.string.menu_search)).setIcon(android.R.drawable.ic_menu_search);</span>
<span class="fc" id="L344">		menu.add(0, ADD_SERIE_MENU_ITEM, 0, getString(R.string.menu_add_serie)).setIcon(android.R.drawable.ic_menu_add);</span>
<span class="fc" id="L345">		menu.add(0, UPDATEALL_MENU_ITEM, 0, getString(R.string.menu_update)).setIcon(android.R.drawable.ic_menu_upload);</span>
<span class="fc" id="L346">		menu.add(0, OPTIONS_MENU_ITEM, 0, getString(R.string.menu_about)).setIcon(android.R.drawable.ic_menu_manage);</span>
<span class="fc" id="L347">		menu.add(0, EXIT_MENU_ITEM, 0, getString(R.string.menu_exit)).setIcon(android.R.drawable.ic_menu_close_clear_cancel);</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">		if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB)</span>
<span class="fc" id="L349">			arrangeActionBar(menu);</span>
<span class="fc" id="L350">		return super.onCreateOptionsMenu(menu);</span>
	}

	@SuppressLint(&quot;NewApi&quot;)
	private void arrangeActionBar(Menu menu) {
<span class="fc" id="L355">		menu.findItem(TOGGLE_ARCHIVE_MENU_ITEM).setVisible(false);</span>
<span class="fc" id="L356">		menu.findItem(LOG_MODE_ITEM).setVisible(false);</span>
<span class="fc" id="L357">		menu.findItem(SEARCH_MENU_ITEM).setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS);</span>
<span class="fc" id="L358">		spinner = new Spinner(this);</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">		if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN)</span>
<span class="fc" id="L360">			spinner.setPopupBackgroundResource(R.drawable.menu_dropdown_panel);</span>
<span class="fc" id="L361">		spinner.setAdapter(new ArrayAdapter&lt;String&gt;(getApplicationContext(), android.R.layout.simple_list_item_1,</span>
			new String[] {
<span class="fc" id="L363">				getString(R.string.layout_app_name),</span>
<span class="fc" id="L364">				getString(R.string.archive),</span>
<span class="fc" id="L365">				getString(R.string.menu_log),</span>
			}));
<span class="fc" id="L367">		listView.postDelayed(new Runnable() {</span>
			public void run() {
<span class="fc" id="L369">				spinner.setOnItemSelectedListener(new OnItemSelectedListener() {</span>
					public void onItemSelected(AdapterView&lt;?&gt; parent, View v, int position, long id) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">						logMode = position == 2;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">						showArchive = (position == 2 ? showArchive : position);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">						if (logMode)</span>
<span class="nc" id="L374">							clearFilter(null);</span>
<span class="nc" id="L375">						getSeries();</span>
<span class="nc" id="L376">					}</span>
					public void onNothingSelected(AdapterView&lt;?&gt; arg0) {
<span class="nc" id="L378">					}</span>
				});
<span class="fc" id="L380">			}</span>
		}, 1000);
<span class="fc" id="L382">		ActionBar actionBar = getActionBar();</span>
<span class="fc" id="L383">		actionBar.setDisplayOptions(ActionBar.DISPLAY_SHOW_CUSTOM | ActionBar.DISPLAY_SHOW_HOME);</span>
<span class="fc" id="L384">		actionBar.setCustomView(spinner);</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">		if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP)</span>
<span class="fc" id="L386">			actionBar.setIcon(R.drawable.actionbar);</span>
<span class="fc" id="L387">	}</span>

	@Override
	public boolean onPrepareOptionsMenu(Menu menu) {
<span class="fc" id="L391">		menu.findItem(UNDO_MENU_ITEM)</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">			.setVisible(undo.size() &gt; 0);</span>
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">		menu.findItem(FILTER_MENU_ITEM)</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">			.setEnabled(!logMode &amp;&amp; !searching());</span>
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">		menu.findItem(SEEN_MENU_ITEM)</span>
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">			.setEnabled(!logMode &amp;&amp; !searching());</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		menu.findItem(SORT_MENU_ITEM)</span>
<span class="fc" id="L398">			.setEnabled(!logMode);</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">		menu.findItem(TOGGLE_ARCHIVE_MENU_ITEM)</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">			.setEnabled(!logMode &amp;&amp; !searching());</span>
<span class="fc" id="L401">		menu.findItem(LOG_MODE_ITEM)</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">			.setEnabled(!searching())</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">			.setTitle((!logMode ? R.string.menu_log : R.string.menu_close_log));</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">		menu.findItem(UPDATEALL_MENU_ITEM)</span>
<span class="fc" id="L405">			.setEnabled(!logMode);</span>

<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		if (showArchive == 1) {</span>
<span class="nc" id="L408">			menu.findItem(TOGGLE_ARCHIVE_MENU_ITEM)</span>
<span class="nc" id="L409">				.setIcon(android.R.drawable.ic_menu_today)</span>
<span class="nc" id="L410">				.setTitle(R.string.menu_show_current);</span>
		} else {
<span class="fc" id="L412">			menu.findItem(TOGGLE_ARCHIVE_MENU_ITEM)</span>
<span class="fc" id="L413">				.setIcon(android.R.drawable.ic_menu_recent_history)</span>
<span class="fc" id="L414">				.setTitle(R.string.menu_show_archive);</span>
		}
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">		menu.findItem(SEEN_MENU_ITEM).setTitle(excludeSeen ? R.string.menu_include_seen : R.string.menu_exclude_seen);</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">		if (sortOption == SORT_BY_UNSEEN) {</span>
<span class="nc" id="L418">			menu.findItem(SORT_MENU_ITEM)</span>
<span class="nc" id="L419">				.setIcon(android.R.drawable.ic_menu_sort_alphabetically)</span>
<span class="nc" id="L420">				.setTitle(R.string.menu_sort_by_name);</span>
		} else {
<span class="fc" id="L422">			menu.findItem(SORT_MENU_ITEM)</span>
<span class="fc" id="L423">				.setIcon(android.R.drawable.ic_menu_sort_by_size)</span>
<span class="fc" id="L424">				.setTitle(R.string.menu_sort_by_unseen);</span>
		}
<span class="fc" id="L426">		return super.onPrepareOptionsMenu(menu);</span>
	}

	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
<span class="nc bnc" id="L431" title="All 12 branches missed.">		switch (item.getItemId()) {</span>
			case ADD_SERIE_MENU_ITEM :
<span class="nc" id="L433">				super.onSearchRequested();</span>
<span class="nc" id="L434">				break;</span>
			case SEARCH_MENU_ITEM :
<span class="nc" id="L436">				onSearchRequested();</span>
<span class="nc" id="L437">				break;</span>
			case TOGGLE_ARCHIVE_MENU_ITEM :
<span class="nc" id="L439">				toggleArchive();</span>
<span class="nc" id="L440">				break;</span>
			case SEEN_MENU_ITEM :
<span class="nc" id="L442">				toggleSeen();</span>
<span class="nc" id="L443">				break;</span>
			case SORT_MENU_ITEM :
<span class="nc" id="L445">				toggleSort();</span>
<span class="nc" id="L446">				break;</span>
			case FILTER_MENU_ITEM :
<span class="nc" id="L448">				filterDialog();</span>
<span class="nc" id="L449">				break;</span>
			case UPDATEALL_MENU_ITEM :
<span class="nc" id="L451">				updateAllSeriesDialog();</span>
<span class="nc" id="L452">				break;</span>
			case OPTIONS_MENU_ITEM :
<span class="nc" id="L454">				aboutDialog();</span>
<span class="nc" id="L455">				break;</span>
			case UNDO_MENU_ITEM :
<span class="nc" id="L457">				markLastEpUnseen();</span>
<span class="nc" id="L458">				break;</span>
			case LOG_MODE_ITEM :
<span class="nc" id="L460">				toggleLogMode();</span>
<span class="nc" id="L461">				break;</span>
			case EXIT_MENU_ITEM :
<span class="nc" id="L463">				onPause();	// save options</span>
<span class="nc" id="L464">				backup(true);</span>
<span class="nc" id="L465">				db.close();</span>
<span class="nc" id="L466">				this.finish();</span>
<span class="nc" id="L467">				System.gc();</span>
<span class="nc" id="L468">				System.exit(0);	// kill process</span>
		}
<span class="nc" id="L470">		return super.onOptionsItemSelected(item);</span>
	}

	private void toggleArchive() {
<span class="nc" id="L474">		showArchive = (showArchive + 1) % 2;</span>
<span class="nc" id="L475">		getSeries();</span>
<span class="nc" id="L476">		listView.setSelection(0);</span>
<span class="nc" id="L477">	}</span>

	private void toggleSeen() {
<span class="nc" id="L480">		excludeSeen ^= true;</span>
<span class="nc" id="L481">		listView.post(updateListView);</span>
<span class="nc" id="L482">	}</span>

	private void toggleSort() {
<span class="nc" id="L485">		sortOption ^= 1;</span>
<span class="nc" id="L486">		listView.post(updateListView);</span>
<span class="nc" id="L487">	}</span>

	private void toggleLogMode() {
<span class="nc" id="L490">		logMode ^= true;</span>
<span class="nc" id="L491">		getSeries();</span>
<span class="nc" id="L492">		removeEpisodeFromLog = &quot;&quot;;</span>
<span class="nc" id="L493">		listView.setSelection(0);</span>
<span class="nc" id="L494">	}</span>

	private void filterDialog() {
<span class="nc bnc" id="L497" title="All 2 branches missed.">		if (m_AlertDlg != null) {</span>
<span class="nc" id="L498">			m_AlertDlg.dismiss();</span>
		}
<span class="nc" id="L500">		final View filterV = View.inflate(this, R.layout.alert_filter, null);</span>
<span class="nc" id="L501">		((CheckBox) filterV.findViewById(R.id.exclude_seen)).setChecked(excludeSeen);</span>
<span class="nc" id="L502">		List&lt;String&gt; allNetworks = db.getNetworks();</span>
<span class="nc" id="L503">		final LinearLayout networksFilterV = (LinearLayout) filterV.findViewById(R.id.networks_filter);</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">		for (String network : allNetworks) {</span>
<span class="nc" id="L505">			CheckBox networkCheckBox = new CheckBox(this);</span>
<span class="nc" id="L506">			networkCheckBox.setText(network);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">			if (!networks.isEmpty())</span>
<span class="nc" id="L508">				networkCheckBox.setChecked(networks.contains(network));</span>
<span class="nc" id="L509">			networksFilterV.addView(networkCheckBox);</span>
<span class="nc" id="L510">		}</span>
<span class="nc" id="L511">		ToggleButton networksFilter = (ToggleButton) filterV.findViewById(R.id.toggle_networks_filter);</span>
<span class="nc" id="L512">		networksFilter.setChecked(filterNetworks);</span>
<span class="nc" id="L513">		toggleNetworksFilter(networksFilter);</span>
<span class="nc" id="L514">		m_AlertDlg = new AlertDialog.Builder(this)</span>
<span class="nc" id="L515">			.setView(filterV)</span>
<span class="nc" id="L516">			.setTitle(R.string.menu_filter)</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">			.setIcon(Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP ? R.drawable.icon : 0)</span>
<span class="nc" id="L518">			.setPositiveButton(getString(R.string.dialog_ok), new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int id) {
<span class="nc" id="L520">					applyFilters((ScrollView) filterV, networksFilterV);</span>
<span class="nc" id="L521">				}</span>
			})
<span class="nc" id="L523">			.setNegativeButton(getString(R.string.dialog_cancel), new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int id) {
<span class="nc" id="L525">					m_AlertDlg.dismiss();</span>
<span class="nc" id="L526">				}</span>
			})
<span class="nc" id="L528">			.show();</span>
<span class="nc" id="L529">	}</span>

	public void toggleNetworksFilter(View v) {
<span class="nc" id="L532">		boolean enabled = (((ToggleButton) v).isChecked());</span>
<span class="nc" id="L533">		LinearLayout networksFilterV = (LinearLayout) ((View) v.getParent().getParent()).findViewById(R.id.networks_filter);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">		for (int i = 0; i &lt; networksFilterV.getChildCount(); i++) {</span>
<span class="nc" id="L535">			networksFilterV.getChildAt(i).setEnabled(enabled);</span>
		}
<span class="nc" id="L537">	}</span>

	private void applyFilters(ScrollView filterV, LinearLayout networksFilterV) {
<span class="nc bnc" id="L540" title="All 2 branches missed.">		excludeSeen = (((CheckBox) filterV.findViewById(R.id.exclude_seen)).isChecked() ? true : false);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">		filterNetworks = (((ToggleButton) filterV.findViewById(R.id.toggle_networks_filter)).isChecked() == true);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">		for (int i = 0; i &lt; networksFilterV.getChildCount(); i++) {</span>
<span class="nc" id="L543">			CheckBox networkCheckBox = (CheckBox) networksFilterV.getChildAt(i);</span>
<span class="nc" id="L544">			String network = (String) networkCheckBox.getText();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">			if (networkCheckBox.isChecked()) {</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">				if (!networks.contains(network))</span>
<span class="nc" id="L547">					networks.add(network);</span>
			} else {
<span class="nc bnc" id="L549" title="All 2 branches missed.">				if (networks.contains(network))</span>
<span class="nc" id="L550">					networks.remove(network);</span>
			}
		}
<span class="nc" id="L553">		getSeries();</span>
<span class="nc" id="L554">	}</span>

	private void aboutDialog() {
<span class="nc bnc" id="L557" title="All 2 branches missed.">		if (m_AlertDlg != null) {</span>
<span class="nc" id="L558">			m_AlertDlg.dismiss();</span>
		}
<span class="nc" id="L560">		View about = View.inflate(this, R.layout.alert_about, null);</span>
<span class="nc" id="L561">		TextView changelog = (TextView) about.findViewById(R.id.copyright);</span>
		try {
<span class="nc" id="L563">			changelog.setText(getString(R.string.copyright)</span>
<span class="nc" id="L564">				.replace(&quot;{v}&quot;, getPackageManager().getPackageInfo(getPackageName(), 0).versionName)</span>
<span class="nc" id="L565">				.replace(&quot;{y}&quot;, Calendar.getInstance().get(Calendar.YEAR) +&quot;&quot;));</span>
<span class="nc" id="L566">			changelog.setTextColor(changelog.getTextColors().getDefaultColor());</span>
<span class="nc" id="L567">		} catch (NameNotFoundException e) {</span>
<span class="nc" id="L568">			e.printStackTrace();</span>
<span class="nc" id="L569">		}</span>
<span class="nc" id="L570">		((TextView) about.findViewById(R.id.change_language)).setText(getString(R.string.dialog_change_language) +&quot; (&quot;+ langCode +&quot;)&quot;);</span>
<span class="nc" id="L571">		((CheckBox) about.findViewById(R.id.auto_backup)).setChecked(autoBackup);</span>
<span class="nc" id="L572">		((CheckBox) about.findViewById(R.id.backup_versioning)).setChecked(backupVersioning);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">		((CheckBox) about.findViewById(R.id.latest_season)).setChecked(latestSeasonOption == UPDATE_LATEST_SEASON_ONLY);</span>
<span class="nc" id="L574">		((CheckBox) about.findViewById(R.id.include_specials)).setChecked(includeSpecialsOption);</span>
<span class="nc" id="L575">		((CheckBox) about.findViewById(R.id.full_line_check)).setChecked(fullLineCheckOption);</span>
<span class="nc" id="L576">		((CheckBox) about.findViewById(R.id.switch_swipe_direction)).setChecked(switchSwipeDirection);</span>
<span class="nc" id="L577">		((CheckBox) about.findViewById(R.id.show_next_airing)).setChecked(showNextAiring);</span>
<span class="nc" id="L578">		((CheckBox) about.findViewById(R.id.mark_from_last_watched)).setChecked(markFromLastWatched);</span>
<span class="nc" id="L579">		((CheckBox) about.findViewById(R.id.use_mirror)).setChecked(useMirror);</span>
<span class="nc" id="L580">		m_AlertDlg = new AlertDialog.Builder(this)</span>
<span class="nc" id="L581">			.setView(about)</span>
<span class="nc" id="L582">			.setTitle(R.string.menu_about)</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">			.setIcon(Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP ? R.drawable.icon : 0)</span>
<span class="nc" id="L584">			.setPositiveButton(getString(R.string.dialog_ok), new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int id) {
<span class="nc" id="L586">					m_AlertDlg.dismiss();</span>
<span class="nc" id="L587">				}</span>
			})
<span class="nc" id="L589">			.show();</span>
<span class="nc" id="L590">	}</span>

	public void dialogOptions(View v) {
<span class="nc bnc" id="L593" title="All 13 branches missed.">		switch(v.getId()) {</span>
			case R.id.backup:
<span class="nc" id="L595">				m_AlertDlg.dismiss();</span>
<span class="nc" id="L596">				backup(false);</span>
<span class="nc" id="L597">				break;</span>
			case R.id.restore:
<span class="nc" id="L599">				m_AlertDlg.dismiss();</span>
<span class="nc" id="L600">				restore();</span>
<span class="nc" id="L601">				break;</span>
			case R.id.auto_backup:
<span class="nc" id="L603">				autoBackup ^= true;</span>
<span class="nc" id="L604">				break;</span>
			case R.id.backup_versioning:
<span class="nc" id="L606">				backupVersioning ^= true;</span>
<span class="nc" id="L607">				break;</span>
			case R.id.latest_season:
<span class="nc" id="L609">				latestSeasonOption ^= 1;</span>
<span class="nc" id="L610">				break;</span>
			case R.id.include_specials:
<span class="nc" id="L612">				includeSpecialsOption ^= true;</span>
<span class="nc" id="L613">				updateShowStats();</span>
<span class="nc" id="L614">				break;</span>
			case R.id.full_line_check:
<span class="nc" id="L616">				fullLineCheckOption ^= true;</span>
<span class="nc" id="L617">				break;</span>
			case R.id.switch_swipe_direction:
<span class="nc" id="L619">				switchSwipeDirection ^= true;</span>
<span class="nc" id="L620">				break;</span>
			case R.id.show_next_airing:
<span class="nc" id="L622">				showNextAiring ^= true;</span>
<span class="nc" id="L623">				updateShowStats();</span>
<span class="nc" id="L624">				break;</span>
			case R.id.mark_from_last_watched:
<span class="nc" id="L626">				markFromLastWatched ^= true;</span>
<span class="nc" id="L627">				updateShowStats();</span>
<span class="nc" id="L628">				break;</span>
			case R.id.use_mirror:
<span class="nc" id="L630">				useMirror ^= true;</span>
<span class="nc" id="L631">				break;</span>
			case R.id.change_language:
<span class="nc" id="L633">				AlertDialog.Builder changeLang = new AlertDialog.Builder(this);</span>
<span class="nc" id="L634">				changeLang.setTitle(R.string.dialog_change_language)</span>
<span class="nc" id="L635">					.setItems(R.array.languages, new DialogInterface.OnClickListener() {</span>
						public void onClick(DialogInterface dialog, int item) {
<span class="nc" id="L637">							langCode = getResources().getStringArray(R.array.langcodes)[item];</span>
<span class="nc" id="L638">							TextView changeLangB = (TextView) m_AlertDlg.findViewById(R.id.change_language);</span>
<span class="nc" id="L639">							changeLangB.setText(getString(R.string.dialog_change_language) +&quot; (&quot;+ langCode +&quot;)&quot;);</span>
<span class="nc" id="L640">						}</span>
					})
<span class="nc" id="L642">					.show();</span>
			break;
		}
<span class="nc" id="L645">	}</span>

	private void updateShowStats() {
<span class="nc" id="L648">		Runnable updateShowStats = new Runnable() {</span>
			public void run() {
<span class="nc" id="L650">				db.updateShowStats();</span>
<span class="nc" id="L651">				listView.post(new Runnable() {</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">					public void run() {getSeries((searching() ? 2 : showArchive));}</span>
				});
<span class="nc" id="L654">			}</span>
		};
<span class="nc" id="L656">		Thread updateShowStatsTh = new Thread(updateShowStats);</span>
<span class="nc" id="L657">		updateShowStatsTh.start();</span>
<span class="nc" id="L658">	}</span>

	private void backup(boolean auto) {
<span class="nc bnc" id="L661" title="All 2 branches missed.">		if (auto) {</span>
<span class="nc" id="L662">			backup(auto, backupFolder);</span>
		} else {
<span class="nc" id="L664">			File folder = new File(backupFolder);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">			if (!folder.isDirectory())</span>
<span class="nc" id="L666">				folder.mkdir();</span>
<span class="nc" id="L667">			filePicker(backupFolder, false);</span>
		}
<span class="nc" id="L669">	}</span>

	private void restore() {
<span class="nc" id="L672">		filePicker(backupFolder, true);</span>
<span class="nc" id="L673">	}</span>

	private void filePicker(final String folderString, final boolean restoring) {
<span class="nc" id="L676">		File folder = new File(folderString);</span>
<span class="nc" id="L677">		File[] tempDirList = dirContents(folder, restoring);</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">		int showParent = (folderString.equals(Environment.getExternalStorageDirectory().getPath()) ? 0 : 1);</span>
<span class="nc" id="L679">		dirList = new File[tempDirList.length + showParent];</span>
<span class="nc" id="L680">		dirNamesList = new String[tempDirList.length + showParent];</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">		if (showParent == 1) {</span>
<span class="nc" id="L682">			dirList[0] = folder.getParentFile();</span>
<span class="nc" id="L683">			dirNamesList[0] = &quot;..&quot;;</span>
		}
<span class="nc bnc" id="L685" title="All 2 branches missed.">		for(int i = 0; i &lt; tempDirList.length; i++) {</span>
<span class="nc" id="L686">			dirList[i + showParent] = tempDirList[i];</span>
<span class="nc" id="L687">			dirNamesList[i + showParent] = tempDirList[i].getName();</span>
<span class="nc bnc" id="L688" title="All 4 branches missed.">			if (restoring &amp;&amp; tempDirList[i].isFile())</span>
<span class="nc" id="L689">				dirNamesList[i + showParent] += &quot; (&quot;+ SimpleDateFormat.getDateTimeInstance(SimpleDateFormat.DEFAULT, SimpleDateFormat.SHORT).format(tempDirList[i].lastModified()) +&quot;)&quot;;</span>
		}
<span class="nc" id="L691">		AlertDialog.Builder filePicker = new AlertDialog.Builder(this)</span>
<span class="nc" id="L692">			.setTitle(folder.toString())</span>
<span class="nc" id="L693">			.setItems(dirNamesList, new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L695">					File chosenFile = dirList[which];</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">					if (chosenFile.isDirectory()) {</span>
<span class="nc" id="L697">						filePicker(chosenFile.toString(), restoring);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">					} else if (restoring) {</span>
<span class="nc" id="L699">						confirmRestore(chosenFile.toString());</span>
					}
<span class="nc" id="L701">				}</span>
			})
<span class="nc" id="L703">			.setNegativeButton(R.string.dialog_cancel, new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L705">					dialog.dismiss();</span>
<span class="nc" id="L706">				}</span>
			});

<span class="nc bnc" id="L709" title="All 2 branches missed.">		if (!restoring)</span>
<span class="nc" id="L710">			filePicker.setPositiveButton(R.string.dialog_backup, new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L712">					backup(false, folderString);</span>
<span class="nc" id="L713">				}</span>
			});
<span class="nc" id="L715">		filePicker.show();</span>
<span class="nc" id="L716">	}</span>

	private File[] dirContents(File folder, final boolean showFiles)  {
<span class="nc bnc" id="L719" title="All 2 branches missed.">		if (folder.exists()) {</span>
<span class="nc" id="L720">			FilenameFilter filter = new FilenameFilter() {</span>
				public boolean accept(File dir, String filename) {
<span class="nc" id="L722">					File file = new File(dir.getAbsolutePath() + File.separator + filename);</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">					if (showFiles)</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">						return file.isDirectory()</span>
<span class="nc bnc" id="L725" title="All 4 branches missed.">							|| file.isFile() &amp;&amp; file.getName().toLowerCase().indexOf(&quot;droidshows.db&quot;) == 0;</span>
					else
<span class="nc" id="L727">						return file.isDirectory();</span>
				}
			};
<span class="nc" id="L730">			File[] list = folder.listFiles(filter);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">			if (list != null)</span>
<span class="nc" id="L732">				Arrays.sort(list, filesComperator);</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">			return list == null ? new File[0] : list;</span>
		} else {
<span class="nc" id="L735">			return new File[0];</span>
		}
	}

<span class="fc" id="L739">	private static Comparator&lt;File&gt; filesComperator = new Comparator&lt;File&gt;() {</span>
		public int compare(File f1, File f2) {
<span class="nc bnc" id="L741" title="All 4 branches missed.">			if (f1.isDirectory() &amp;&amp; !f2.isDirectory())</span>
<span class="nc" id="L742">				return 1;</span>
<span class="nc bnc" id="L743" title="All 4 branches missed.">			if (f2.isDirectory() &amp;&amp; !f1.isDirectory())</span>
<span class="nc" id="L744">				return -1;</span>
<span class="nc" id="L745">			return f1.getName().compareToIgnoreCase(f2.getName());</span>
		}
	};

	private void backup(boolean auto, final String backupFolder) {
<span class="nc" id="L750">		File source = new File(getApplicationInfo().dataDir +&quot;/databases/DroidShows.db&quot;);</span>
<span class="nc" id="L751">		File destination = new File(backupFolder, &quot;DroidShows.db&quot;);</span>
<span class="nc bnc" id="L752" title="All 4 branches missed.">		if (auto &amp;&amp; (!autoBackup ||</span>
				new SimpleDateFormat(&quot;yyyy-MM-dd&quot;)
<span class="nc bnc" id="L754" title="All 2 branches missed.">					.format(destination.lastModified()).equals(lastStatsUpdateCurrent) ||</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">				source.lastModified() == destination.lastModified()))</span>
<span class="nc" id="L756">			return;</span>
<span class="nc bnc" id="L757" title="All 4 branches missed.">		if (backupVersioning &amp;&amp; destination.exists()) {</span>
<span class="nc" id="L758">			File previous0 = new File(backupFolder, &quot;DroidShows.db0&quot;);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">			if (previous0.exists()) {</span>
<span class="nc" id="L760">				File previous1 = new File(backupFolder, &quot;DroidShows.db1&quot;);</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">				if (previous1.exists())</span>
<span class="nc" id="L762">					previous1.delete();</span>
<span class="nc" id="L763">				previous0.renameTo(previous1);</span>
			}
<span class="nc" id="L765">			destination.renameTo(previous0);</span>
<span class="nc" id="L766">		} else</span>
<span class="nc" id="L767">			destination.delete();</span>
<span class="nc" id="L768">		File folder = new File(backupFolder);</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">		if (!folder.isDirectory())</span>
<span class="nc" id="L770">			folder.mkdir();</span>
<span class="nc" id="L771">		int toastTxt = R.string.dialog_backup_done;</span>
		try {
<span class="nc" id="L773">			copy(source, destination);</span>
<span class="nc" id="L774">		} catch (IOException e) {</span>
<span class="nc" id="L775">			toastTxt = R.string.dialog_backup_failed;</span>
<span class="nc" id="L776">			e.printStackTrace();</span>
<span class="nc" id="L777">		}</span>
<span class="nc bnc" id="L778" title="All 6 branches missed.">		if (!auto &amp;&amp; toastTxt == R.string.dialog_backup_done &amp;&amp; !backupFolder.equals(DroidShows.backupFolder)) {</span>
<span class="nc" id="L779">			final CharSequence[] backupFolders = {backupFolder, DroidShows.backupFolder};</span>
<span class="nc" id="L780">			new AlertDialog.Builder(DroidShows.this)</span>
<span class="nc" id="L781">				.setTitle(toastTxt)</span>
<span class="nc" id="L782">				.setSingleChoiceItems(backupFolders, 1, new DialogInterface.OnClickListener() {</span>
					public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L784">						DroidShows.backupFolder = backupFolders[which].toString();</span>
<span class="nc" id="L785">					}</span>
				})
<span class="nc" id="L787">				.setPositiveButton(R.string.dialog_backup_usefolder, null)</span>
<span class="nc" id="L788">				.show();</span>
		}
<span class="nc bnc" id="L790" title="All 4 branches missed.">		if (!auto &amp;&amp; listView != null) {</span>
<span class="nc" id="L791">			Toast.makeText(getApplicationContext(), getString(toastTxt) + &quot; (&quot;+ backupFolder +&quot;)&quot;, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L792">			asyncInfo = new AsyncInfo();</span>
<span class="nc" id="L793">			asyncInfo.execute();</span>
		}
<span class="nc" id="L795">	}</span>

	private void confirmRestore(final String backupFile) {
<span class="nc" id="L798">		new AlertDialog.Builder(DroidShows.this)</span>
<span class="nc" id="L799">			.setTitle(R.string.dialog_restore)</span>
<span class="nc" id="L800">			.setMessage(R.string.dialog_restore_now)</span>
<span class="nc" id="L801">			.setPositiveButton(R.string.dialog_ok, new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int id) {
<span class="nc" id="L803">					restore(backupFile);</span>
<span class="nc" id="L804">					}</span>
				})
<span class="nc" id="L806">			.setNegativeButton(R.string.dialog_cancel, null)</span>
<span class="nc" id="L807">			.show();</span>
<span class="nc" id="L808">	}</span>

	private void restore(String backupFile) {
<span class="nc" id="L811">		String toastTxt = getString(R.string.dialog_restore_done);</span>
<span class="nc" id="L812">		File source = new File(backupFile);</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">		if (source.exists()) {</span>
<span class="nc" id="L814">			File destination = new File(getApplicationInfo().dataDir +&quot;/databases&quot;, &quot;DroidShows.db&quot;);</span>
			try {
<span class="nc" id="L816">				copy(source, destination);</span>
<span class="nc" id="L817">				updateDatabase();</span>
<span class="nc" id="L818">				File thumbs[] = new File(getApplicationContext().getFilesDir().getAbsolutePath() +&quot;/thumbs/banners/posters&quot;).listFiles();</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">				if (thumbs != null)</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">					for (File thumb : thumbs)</span>
<span class="nc" id="L821">						thumb.delete();</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">				for (File file : new File(getApplicationInfo().dataDir +&quot;/databases&quot;).listFiles())</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">				    if (!file.getName().equalsIgnoreCase(&quot;DroidShows.db&quot;)) file.delete();</span>
<span class="nc" id="L824">				updateAllSeries(2);	// 2 = update archive and current shows</span>
<span class="nc" id="L825">				undo.clear();</span>
<span class="nc" id="L826">				toastTxt += &quot; (&quot;+ source.getPath() +&quot;)&quot;;</span>
<span class="nc" id="L827">			} catch (IOException e) {</span>
<span class="nc" id="L828">				toastTxt = getString(R.string.dialog_restore_failed);</span>
<span class="nc" id="L829">				e.printStackTrace();</span>
<span class="nc" id="L830">			}</span>
<span class="nc" id="L831">		} else {</span>
<span class="nc" id="L832">			toastTxt = getString(R.string.dialog_restore_notfound);</span>
		}
<span class="nc" id="L834">		Toast.makeText(getApplicationContext(), toastTxt, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L835">	}</span>

	private void copy(File source, File destination) throws IOException {
<span class="nc bnc" id="L838" title="All 2 branches missed.">		if (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState())) {</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">			if (asyncInfo != null)</span>
<span class="nc" id="L840">				asyncInfo.cancel(true);</span>
<span class="nc" id="L841">			db.close();</span>
<span class="nc" id="L842">			FileChannel sourceCh = null, destinationCh = null;</span>
			try {
<span class="nc" id="L844">				sourceCh = new FileInputStream(source).getChannel();</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">				if (destination.exists()) destination.delete();</span>
<span class="nc" id="L846">				destination.createNewFile();</span>
<span class="nc" id="L847">				destinationCh = new FileOutputStream(destination).getChannel();</span>
<span class="nc" id="L848">				destinationCh.transferFrom(sourceCh, 0, sourceCh.size());</span>
<span class="nc" id="L849">				destination.setLastModified(source.lastModified());</span>
			} finally {
<span class="nc bnc" id="L851" title="All 2 branches missed.">				if (sourceCh != null) {</span>
<span class="nc" id="L852">					sourceCh.close();</span>
				}
<span class="nc bnc" id="L854" title="All 2 branches missed.">				if (destinationCh != null) {</span>
<span class="nc" id="L855">					destinationCh.close();</span>
				}
			}
<span class="nc" id="L858">			db.openDataBase();</span>
		}
<span class="nc" id="L860">	}</span>

	/* context menu */
	public void onCreateContextMenu(ContextMenu menu, View v, ContextMenuInfo menuInfo) {
<span class="fc" id="L864">		super.onCreateContextMenu(menu, v, menuInfo);</span>
<span class="fc" id="L865">		AdapterContextMenuInfo info = (AdapterContextMenuInfo) menuInfo;</span>
<span class="fc" id="L866">		TVShowItem serie = seriesAdapter.getItem(info.position);</span>
<span class="pc bpc" id="L867" title="1 of 2 branches missed.">		if (logMode)</span>
<span class="nc" id="L868">			menu.add(0, VIEW_SEASONS_CONTEXT, VIEW_SEASONS_CONTEXT, getString(R.string.messages_seasons));</span>
<span class="fc" id="L869">		menu.add(0, VIEW_SERIEDETAILS_CONTEXT, VIEW_SERIEDETAILS_CONTEXT, getString(R.string.menu_context_view_serie_details));</span>
<span class="pc bpc" id="L870" title="2 of 4 branches missed.">		if (!logMode &amp;&amp; serie.getUnwatched() &gt; 0)</span>
<span class="fc" id="L871">			menu.add(0, VIEW_EPISODEDETAILS_CONTEXT, VIEW_EPISODEDETAILS_CONTEXT, getString(R.string.messsages_view_ep_details));</span>
<span class="fc" id="L872">		menu.add(0, EXT_RESOURCES_CONTEXT, EXT_RESOURCES_CONTEXT, getString(R.string.menu_context_ext_resources));</span>
<span class="pc bpc" id="L873" title="2 of 4 branches missed.">		if (!logMode &amp;&amp; serie.getUnwatchedAired() &gt; 0)</span>
<span class="fc" id="L874">			menu.add(0, MARK_NEXT_EPISODE_AS_SEEN_CONTEXT, MARK_NEXT_EPISODE_AS_SEEN_CONTEXT, getString(R.string.menu_context_mark_next_episode_as_seen));</span>
<span class="pc bpc" id="L875" title="1 of 2 branches missed.">		if (!logMode) {</span>
<span class="fc" id="L876">			menu.add(0, TOGGLE_ARCHIVED_CONTEXT, TOGGLE_ARCHIVED_CONTEXT, getString(R.string.menu_archive));</span>
<span class="fc" id="L877">			menu.add(0, PIN_CONTEXT, PIN_CONTEXT, getString(R.string.menu_context_pin));</span>
<span class="fc" id="L878">			menu.add(0, DELETE_CONTEXT, DELETE_CONTEXT, getString(R.string.menu_context_delete));</span>
<span class="fc" id="L879">			menu.add(0, UPDATE_CONTEXT, UPDATE_CONTEXT, getString(R.string.menu_context_update));</span>
<span class="fc" id="L880">			menu.add(0, DVDORDER_CONTEXT, DVDORDER_CONTEXT, getString(R.string.menu_context_dvdorder));</span>
<span class="fc" id="L881">			menu.add(0, SYNOPSIS_LANGUAGE, SYNOPSIS_LANGUAGE, getString(R.string.dialog_change_language) +&quot; (&quot;+ serie.getLanguage() +&quot;)&quot;);</span>
<span class="pc bpc" id="L882" title="1 of 2 branches missed.">		    if (serie.getPassiveStatus())</span>
<span class="nc" id="L883">		    	menu.findItem(TOGGLE_ARCHIVED_CONTEXT).setTitle(R.string.menu_unarchive);</span>
<span class="pc bpc" id="L884" title="1 of 2 branches missed.">		    if (pinnedShows.contains(serie.getSerieId()))</span>
<span class="nc" id="L885">		    	menu.findItem(PIN_CONTEXT).setTitle(R.string.menu_context_unpin);</span>
<span class="pc bpc" id="L886" title="1 of 2 branches missed.">		    if (serie.getDvdOrder())</span>
<span class="nc" id="L887">		    	menu.findItem(DVDORDER_CONTEXT).setTitle(R.string.menu_context_airedorder);</span>
		}
<span class="pc bpc" id="L889" title="1 of 2 branches missed.">		menu.setHeaderTitle(!logMode ? serie.getName() : serie.getEpisodeName());</span>
<span class="fc" id="L890">	}</span>

	public boolean onContextItemSelected(MenuItem item) {
<span class="fc" id="L893">		final AdapterContextMenuInfo info = (AdapterContextMenuInfo) item.getMenuInfo();</span>
<span class="fc" id="L894">		final TVShowItem serie = seriesAdapter.getItem(info.position);</span>
<span class="pc bpc" id="L895" title="11 of 12 branches missed.">		switch(item.getItemId()) {</span>
			case MARK_NEXT_EPISODE_AS_SEEN_CONTEXT :
<span class="nc" id="L897">				markNextEpSeen(info.position);</span>
<span class="nc" id="L898">				return true;</span>
			case VIEW_SEASONS_CONTEXT :
<span class="nc" id="L900">				serieSeasons(info.position);</span>
<span class="nc" id="L901">				return true;</span>
			case VIEW_SERIEDETAILS_CONTEXT :
<span class="nc" id="L903">				showDetails(serie.getSerieId());</span>
<span class="nc" id="L904">				return true;</span>
			case VIEW_EPISODEDETAILS_CONTEXT :
<span class="nc" id="L906">				episodeDetails(info.position);</span>
<span class="nc" id="L907">				return true;</span>
			case EXT_RESOURCES_CONTEXT :
<span class="nc" id="L909">				extResources(serie.getExtResources(), info.position);</span>
<span class="nc" id="L910">				return true;</span>
			case UPDATE_CONTEXT :
<span class="nc" id="L912">				updateSerie(serie, info.position);</span>
<span class="nc" id="L913">				return true;</span>
			case DVDORDER_CONTEXT :
<span class="nc bnc" id="L915" title="All 2 branches missed.">				db.setDvdOrder(serie.getSerieId(), !serie.getDvdOrder());</span>
<span class="nc" id="L916">				updateShowView(serie);</span>
<span class="nc" id="L917">				return true;</span>
			case SYNOPSIS_LANGUAGE :
<span class="nc" id="L919">				CharSequence[] langList = Arrays.copyOfRange(getResources().getStringArray(R.array.languages), 1, getResources().getStringArray(R.array.languages).length);</span>
<span class="nc" id="L920">				AlertDialog.Builder changeLang = new AlertDialog.Builder(this);</span>
<span class="nc" id="L921">				changeLang.setTitle(R.string.dialog_change_language)</span>
<span class="nc" id="L922">					.setItems(langList, new DialogInterface.OnClickListener() {</span>
						public void onClick(DialogInterface dialog, int item) {
<span class="nc" id="L924">							String langCode = getResources().getStringArray(R.array.langcodes)[item + 1];</span>
<span class="nc" id="L925">							updateSerie(serie, langCode, info.position);</span>
<span class="nc" id="L926">						}</span>
					})
<span class="nc" id="L928">					.show();</span>
<span class="nc" id="L929">				return true;</span>
			case TOGGLE_ARCHIVED_CONTEXT :
<span class="nc" id="L931">				asyncInfo.cancel(true);</span>
<span class="nc" id="L932">				boolean passiveStatus = serie.getPassiveStatus();</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">				db.updateSerieStatus(serie.getSerieId(), (passiveStatus ? 0 : 1));</span>
<span class="nc" id="L934">				String message = serie.getName() +&quot; &quot;+</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">					(passiveStatus ? getString(R.string.messages_context_unarchived) : getString(R.string.messages_context_archived));</span>
<span class="nc" id="L936">				Toast.makeText(getApplicationContext(), message, Toast.LENGTH_SHORT).show();</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">				if (!searching())</span>
<span class="nc" id="L938">					series.remove(serie);</span>
				else
<span class="nc bnc" id="L940" title="All 2 branches missed.">					serie.setPassiveStatus(!passiveStatus);</span>
<span class="nc" id="L941">				listView.post(updateListView);</span>
<span class="nc" id="L942">				asyncInfo = new AsyncInfo();</span>
<span class="nc" id="L943">				asyncInfo.execute();</span>
<span class="nc" id="L944">				return true;</span>
			case PIN_CONTEXT :
<span class="nc" id="L946">				String serieId = serie.getSerieId();</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">				if (pinnedShows.contains(serieId))</span>
<span class="nc" id="L948">					pinnedShows.remove(serieId);</span>
				else
<span class="nc" id="L950">					pinnedShows.add(serieId);</span>
<span class="nc" id="L951">				listView.post(updateListView);</span>
<span class="nc" id="L952">				return true;</span>
			case DELETE_CONTEXT :
<span class="fc" id="L954">				asyncInfo.cancel(true);</span>
<span class="fc" id="L955">				final int position = info.position;</span>
<span class="fc" id="L956">				final Runnable deleteserie = new Runnable() {</span>
					public void run() {
<span class="fc" id="L958">						TVShowItem serie = seriesAdapter.getItem(position);</span>
<span class="fc" id="L959">						String sname = serie.getName();</span>
<span class="fc" id="L960">						String toastMsg = getString(R.string.messages_deleted);</span>
<span class="pc bpc" id="L961" title="1 of 2 branches missed.">						if (!db.deleteSerie(serie.getSerieId()))</span>
<span class="nc" id="L962">							toastMsg = &quot;Database error while deleting show&quot;;</span>
<span class="fc" id="L963">						series.remove(series.indexOf(serie));</span>
<span class="fc" id="L964">						listView.post(updateListView);</span>
<span class="fc" id="L965">						Looper.prepare();	// Threads don't have a message loop</span>
<span class="fc" id="L966">							Toast.makeText(getApplicationContext(), sname +&quot; &quot;+ toastMsg, Toast.LENGTH_LONG).show();</span>
<span class="fc" id="L967">							asyncInfo = new AsyncInfo();</span>
<span class="fc" id="L968">							asyncInfo.execute();</span>
<span class="nc" id="L969">						Looper.loop();</span>
<span class="nc" id="L970">					}</span>
				};
<span class="fc" id="L972">				AlertDialog.Builder alertDialog = new AlertDialog.Builder(this)</span>
<span class="fc" id="L973">					.setTitle(R.string.dialog_title_delete)</span>
<span class="fc" id="L974">					.setMessage(String.format(getString(R.string.dialog_delete), serie.getName()))</span>
<span class="fc" id="L975">					.setIcon(android.R.drawable.ic_dialog_alert)</span>
<span class="fc" id="L976">					.setCancelable(false)</span>
<span class="fc" id="L977">					.setPositiveButton(getString(R.string.dialog_ok), new DialogInterface.OnClickListener() {</span>
						public void onClick(DialogInterface dialog, int which) {
<span class="fc" id="L979">							deleteTh = new Thread(deleteserie);</span>
<span class="fc" id="L980">							deleteTh.start();</span>
<span class="fc" id="L981">							return;</span>
						}
					})
<span class="fc" id="L984">					.setNegativeButton(getString(R.string.dialog_cancel), new DialogInterface.OnClickListener() {</span>
						public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L986">							return;</span>
						}
					});
<span class="fc" id="L989">				alertDialog.show();</span>
<span class="fc" id="L990">				return true;</span>
			default :
<span class="nc" id="L992">				return super.onContextItemSelected(item);</span>
		}
	}

	@SuppressLint(&quot;NewApi&quot;)
	public void openContext(View v) {
<span class="pc bpc" id="L998" title="1 of 2 branches missed.">		if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N)</span>
<span class="fc" id="L999">			listView.showContextMenuForChild(v, v.getX(), v.getY());</span>
		else
<span class="nc" id="L1001">			openContextMenu(v);</span>
<span class="fc" id="L1002">	}</span>

	@Override
	protected void onListItemClick(ListView l, View v, int position, long id) {
<span class="fc" id="L1006">		keyboard.hideSoftInputFromWindow(searchV.getWindowToken(), 0);</span>
<span class="pc bpc" id="L1007" title="3 of 4 branches missed.">		if (swipeDetect.value == 1 &amp;&amp; (seriesAdapter.getItem(position).getUnwatchedAired() &gt; 0 ||</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">				 seriesAdapter.getItem(position).getNextAir() != null &amp;&amp;</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">				!seriesAdapter.getItem(position).getNextAir().after(Calendar.getInstance().getTime()))) {</span>
<span class="nc" id="L1010">			vib.vibrate(150);</span>
<span class="nc" id="L1011">			markNextEpSeen(position);</span>
<span class="pc bpc" id="L1012" title="1 of 2 branches missed.">		} else if (swipeDetect.value == 0) {</span>
<span class="pc bpc" id="L1013" title="1 of 2 branches missed.">			if (!logMode) {</span>
<span class="fc" id="L1014">				serieSeasons(position);</span>
			} else {
<span class="nc" id="L1016">				episodeDetails(position);</span>
			}
		}
<span class="fc" id="L1019">	}</span>

	private void markNextEpSeen(int position) {
<span class="nc" id="L1022">		TVShowItem serie = seriesAdapter.getItem(position);</span>
<span class="nc" id="L1023">		String serieId = serie.getSerieId();</span>
<span class="nc" id="L1024">		String nextEpisode = db.getNextEpisodeId(serieId, true);</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">		if (!nextEpisode.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L1026">			String episodeMarked = db.updateUnwatchedEpisode(serieId, nextEpisode);</span>
<span class="nc" id="L1027">			Toast.makeText(getApplicationContext(), serie.getName() +&quot; &quot;+ episodeMarked +&quot; &quot;+ getString(R.string.messages_marked_seen), Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1028">			undo.add(new String[] {serieId, nextEpisode, serie.getName()});</span>
<span class="nc" id="L1029">			updateShowView(serie);</span>
		}
<span class="nc" id="L1031">	}</span>

	private void markLastEpUnseen() {
<span class="nc" id="L1034">		String[] episodeInfo = undo.get(undo.size()-1);</span>
<span class="nc" id="L1035">		String serieId = episodeInfo[0];</span>
<span class="nc" id="L1036">		String episodeId = episodeInfo[1];</span>
<span class="nc" id="L1037">		String serieName = episodeInfo[2];</span>
<span class="nc" id="L1038">		String episodeMarked = db.updateUnwatchedEpisode(serieId, episodeId);</span>
<span class="nc" id="L1039">		undo.remove(undo.size()-1);</span>
<span class="nc" id="L1040">		Toast.makeText(getApplicationContext(), serieName +&quot; &quot;+ episodeMarked +&quot; &quot;+ getString(R.string.messages_marked_unseen), Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1041">		listView.post(updateShowView(serieId));</span>
<span class="nc" id="L1042">	}</span>

	private void serieSeasons(int position) {
<span class="fc" id="L1045">		backFromSeasonSerieId = seriesAdapter.getItem(position).getSerieId();</span>
<span class="fc" id="L1046">		Intent serieSeasons = new Intent(DroidShows.this, SerieSeasons.class);</span>
<span class="fc" id="L1047">		serieSeasons.putExtra(&quot;serieId&quot;, backFromSeasonSerieId);</span>
<span class="pc bpc" id="L1048" title="1 of 2 branches missed.">		serieSeasons.putExtra(&quot;nextEpisode&quot;, seriesAdapter.getItem(position).getUnwatched() &gt; 0);</span>
<span class="fc" id="L1049">		serieSeasons.putExtra(&quot;dvdOrder&quot;, seriesAdapter.getItem(position).getDvdOrder());</span>
<span class="fc" id="L1050">		startActivity(serieSeasons);</span>
<span class="fc" id="L1051">	}</span>

	private Runnable updateShowView(final String serieId) {
<span class="fc" id="L1054">		Runnable updateView = new Runnable(){</span>
			public void run() {
<span class="fc bfc" id="L1056" title="All 2 branches covered.">				for (TVShowItem serie : series) {</span>
<span class="fc bfc" id="L1057" title="All 2 branches covered.">					if (serie.getSerieId().equals(serieId)) {</span>
<span class="fc" id="L1058">						updateShowView(serie);</span>
<span class="fc" id="L1059">						break;</span>
					}
<span class="fc" id="L1061">				}</span>
<span class="fc" id="L1062">			}</span>
		};
<span class="fc" id="L1064">		return updateView;</span>
	}

	private void updateShowView(final TVShowItem serie) {
<span class="fc" id="L1068">		final int position = seriesAdapter.getPosition(serie);</span>
<span class="fc" id="L1069">		final TVShowItem newSerie = db.createTVShowItem(serie.getSerieId());</span>
<span class="fc" id="L1070">		lastSerie = newSerie;</span>
<span class="fc" id="L1071">		series.set(series.indexOf(serie), newSerie);</span>
<span class="fc" id="L1072">		listView.post(updateListView);</span>
<span class="fc" id="L1073">		listView.post(new Runnable() {</span>
			public void run() {
<span class="fc" id="L1075">				int newPosition = seriesAdapter.getPosition(newSerie);</span>
<span class="pc bpc" id="L1076" title="1 of 2 branches missed.">				if (newPosition != position) {</span>
<span class="nc" id="L1077">					listView.setSelection(newPosition);</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">					if (listView.getLastVisiblePosition() &gt; newPosition)</span>
<span class="nc" id="L1079">						listView.smoothScrollBy(-padding, 400);</span>
				}
<span class="fc" id="L1081">			}</span>
		});
<span class="fc" id="L1083">	}</span>

	private void showDetails(String serieId) {
<span class="nc" id="L1086">		Intent viewSerie = new Intent(DroidShows.this, ViewSerie.class);</span>
<span class="nc" id="L1087">		viewSerie.putExtra(&quot;serieId&quot;, serieId);</span>
<span class="nc" id="L1088">		startActivity(viewSerie);</span>
<span class="nc" id="L1089">	}</span>

	private void episodeDetails(int position) {
<span class="nc" id="L1092">		String serieId = seriesAdapter.getItem(position).getSerieId();</span>
<span class="nc" id="L1093">		boolean dvdOrder = seriesAdapter.getItem(position).getDvdOrder();</span>
<span class="nc" id="L1094">		String episodeId = &quot;-1&quot;;</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">		if (!logMode)</span>
<span class="nc" id="L1096">			episodeId = db.getNextEpisodeId(serieId, dvdOrder);</span>
		else
<span class="nc" id="L1098">			episodeId = seriesAdapter.getItem(position).getEpisodeId();</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">		if (!episodeId.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L1100">			backFromSeasonSerieId = serieId;</span>
<span class="nc" id="L1101">			Intent viewEpisode = new Intent(DroidShows.this, ViewEpisode.class);</span>
<span class="nc" id="L1102">			viewEpisode.putExtra(&quot;serieName&quot;, seriesAdapter.getItem(position).getName());</span>
<span class="nc" id="L1103">			viewEpisode.putExtra(&quot;serieId&quot;, serieId);</span>
<span class="nc" id="L1104">			viewEpisode.putExtra(&quot;episodeId&quot;, episodeId);</span>
<span class="nc" id="L1105">			startActivity(viewEpisode);</span>
		}
<span class="nc" id="L1107">	}</span>

	private void Search(String url, String serieName) {
<span class="nc" id="L1110">		serieName = serieName.replaceAll(&quot; \\(....\\)&quot;, &quot;&quot;);</span>
<span class="nc" id="L1111">		Intent rt = new Intent(Intent.ACTION_VIEW, Uri.parse(url + Uri.encode(serieName)));</span>
<span class="nc" id="L1112">		rt.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L1113">		startActivity(rt);</span>
<span class="nc" id="L1114">	}</span>

	private void WikiDetails(String serieName) {
<span class="nc" id="L1117">		serieName = serieName.replaceAll(&quot; \\(....\\)&quot;, &quot;&quot;);</span>
		Intent wiki;
<span class="nc" id="L1119">		String wikiApp = null;</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">	    if (getApplicationContext().getPackageManager().getLaunchIntentForPackage(&quot;org.wikipedia&quot;) != null)</span>
<span class="nc" id="L1121">	    	wikiApp = &quot;org.wikipedia&quot;;</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">	    else if (getApplicationContext().getPackageManager().getLaunchIntentForPackage(&quot;org.wikipedia.beta&quot;) != null)</span>
<span class="nc" id="L1123">	    	wikiApp = &quot;org.wikipedia.beta&quot;;</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">	    if (wikiApp == null) {</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">	    	String uri = &quot;https://&quot;+ (langCode.equals(&quot;all&quot;) ? &quot;&quot; : langCode +&quot;.&quot;) +&quot;m.wikipedia.org/wiki/index.php?search=&quot;</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">	    		+ Uri.encode(serieName + (langCode.equals(&quot;en&quot;) ? &quot; (TV series)&quot; : &quot;&quot;));</span>
<span class="nc" id="L1127">	    	wiki = new Intent(Intent.ACTION_VIEW, Uri.parse(uri));</span>
<span class="nc" id="L1128">	    } else {</span>
<span class="nc" id="L1129">	    	wiki = new Intent(Intent.ACTION_SEND)</span>
<span class="nc" id="L1130">	    		.putExtra(Intent.EXTRA_TEXT, serieName)</span>
<span class="nc" id="L1131">	    		.setType(&quot;text/plain&quot;)</span>
<span class="nc" id="L1132">	    		.setPackage(wikiApp);</span>
	    }
<span class="nc" id="L1134">	    wiki.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L1135">	    startActivity(wiki);</span>
<span class="nc" id="L1136">	}</span>

	private void IMDbDetails(String serieId, String serieName, String episode) {
		String query;
<span class="nc bnc" id="L1140" title="All 2 branches missed.">		if (episode != null)</span>
<span class="nc" id="L1141">			query = &quot;SELECT imdbId, episodeName FROM episodes WHERE id = '&quot;+ episode +&quot;' AND serieId='&quot;+ serieId +&quot;'&quot;;</span>
		else
<span class="nc" id="L1143">			query = &quot;SELECT imdbId, serieName FROM series WHERE id = '&quot; + serieId + &quot;'&quot;;</span>
<span class="nc" id="L1144">		Cursor c = db.Query(query);</span>
<span class="nc" id="L1145">		c.moveToFirst();</span>
<span class="nc bnc" id="L1146" title="All 4 branches missed.">		if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="nc" id="L1147">			String imdbId = c.getString(0);</span>
<span class="nc bnc" id="L1148" title="All 4 branches missed.">			if (episode != null &amp;&amp; imdbId.equals(db.getSerieIMDbId(serieId)))	// Sometimes the given episode's IMDb id is that of the show's</span>
<span class="nc" id="L1149">				imdbId = &quot;&quot;;	// So we want to search for the episode instead of go to the show's page</span>
<span class="nc" id="L1150">			String name = c.getString(1);</span>
<span class="nc" id="L1151">			c.close();</span>
<span class="nc" id="L1152">			String uri = &quot;imdb:///&quot;;</span>
<span class="nc" id="L1153">			Intent testForApp = new Intent(Intent.ACTION_VIEW, Uri.parse(&quot;imdb:///find&quot;));</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">			if (getApplicationContext().getPackageManager().resolveActivity(testForApp, 0) == null)</span>
<span class="nc" id="L1155">				uri = &quot;https://m.imdb.com/&quot;;</span>
<span class="nc bnc" id="L1156" title="All 2 branches missed.">			if (imdbId.startsWith(&quot;tt&quot;))</span>
<span class="nc" id="L1157">				uri += &quot;title/&quot;+ imdbId;</span>
			else
<span class="nc bnc" id="L1159" title="All 2 branches missed.">				uri += &quot;find?q=&quot;+ Uri.encode((episode != null ? serieName.replaceAll(&quot; \\(....\\)&quot;, &quot;&quot;) +&quot; &quot; : &quot;&quot;) + name);</span>
<span class="nc" id="L1160">			Intent imdb = new Intent(Intent.ACTION_VIEW, Uri.parse(uri));</span>
<span class="nc" id="L1161">			imdb.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L1162">			startActivity(imdb);</span>
		}
<span class="nc" id="L1164">	}</span>

	private void extResources(String extResourcesString, final int position) {
<span class="nc bnc" id="L1167" title="All 2 branches missed.">		if (extResourcesString.length() &gt; 0) {</span>
<span class="nc" id="L1168">			String[] tmpResources = extResourcesString.trim().split(&quot;\\n&quot;);</span>
<span class="nc" id="L1169">			extResourcesString = &quot;&quot;;</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">			for (int i = 0; i &lt; tmpResources.length; i++) {</span>
<span class="nc" id="L1171">				String url = tmpResources[i].trim();</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">				if (url.length() &gt; 0)</span>
<span class="nc" id="L1173">					extResourcesString += url +&quot;\n&quot;;</span>
			}
		}
<span class="nc" id="L1176">		final String[] extResources = (</span>
<span class="nc" id="L1177">				getString(R.string.menu_context_view_imdb) +&quot;\n&quot;+</span>
<span class="nc" id="L1178">				getString(R.string.menu_context_view_ep_imdb) +&quot;\n&quot;+</span>
<span class="nc" id="L1179">				getString(R.string.menu_context_search_on) +&quot; FANDOM (Wikia)\n&quot;+</span>
<span class="nc" id="L1180">				getString(R.string.menu_context_search_on) +&quot; Rotten Tomatoes\n&quot;+</span>
<span class="nc" id="L1181">				getString(R.string.menu_context_search_on) +&quot; Wikipedia\n&quot;+</span>
				extResourcesString
<span class="nc" id="L1183">				+&quot;\u2026&quot;).split(&quot;\\n&quot;);</span>
<span class="nc" id="L1184">		final EditText input = new EditText(this);</span>
<span class="nc" id="L1185">		final String extResourcesInput = extResourcesString;</span>
<span class="nc" id="L1186">		final TVShowItem serie = seriesAdapter.getItem(position);</span>
<span class="nc" id="L1187">		input.setInputType(InputType.TYPE_CLASS_TEXT|InputType.TYPE_TEXT_FLAG_MULTI_LINE|InputType.TYPE_TEXT_VARIATION_URI);</span>
<span class="nc" id="L1188">		new AlertDialog.Builder(this)</span>
<span class="nc" id="L1189">			.setTitle(serie.getName())</span>
<span class="nc" id="L1190">			.setItems(extResources, new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int item) {
<span class="nc bnc" id="L1192" title="All 6 branches missed.">					switch(item) {</span>
						case 0 :
<span class="nc" id="L1194">							IMDbDetails(serie.getSerieId(), serie.getName(), null);</span>
<span class="nc" id="L1195">							break;</span>
						case 1 :
<span class="nc bnc" id="L1197" title="All 2 branches missed.">							IMDbDetails(serie.getSerieId(), serie.getName(), logMode ? serie.getEpisodeId() : db.getNextEpisodeId(serie.getSerieId(), serie.getDvdOrder()));</span>
<span class="nc" id="L1198">							break;</span>
						case 2 :
<span class="nc" id="L1200">							Search(&quot;https://www.fandom.com/?s=&quot;, serie.getName());</span>
<span class="nc" id="L1201">							break;</span>
						case 3 :
<span class="nc" id="L1203">							Search(&quot;https://www.rottentomatoes.com/search/?search=&quot;, serie.getName());</span>
<span class="nc" id="L1204">							break;</span>
						case 4 :
<span class="nc" id="L1206">							WikiDetails(serie.getName());</span>
<span class="nc" id="L1207">							break;</span>
						default :
<span class="nc bnc" id="L1209" title="All 2 branches missed.">							if (item == extResources.length-1) {</span>
<span class="nc" id="L1210">								input.setText(extResourcesInput);</span>
<span class="nc" id="L1211">								new AlertDialog.Builder(DroidShows.this)</span>
<span class="nc" id="L1212">									.setTitle(serie.getName())</span>
<span class="nc" id="L1213">									.setView(input)</span>
<span class="nc" id="L1214">									.setPositiveButton(R.string.dialog_ok, new DialogInterface.OnClickListener() {</span>
										public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L1216">											keyboard.hideSoftInputFromWindow(input.getWindowToken(), 0);</span>
<span class="nc" id="L1217">											String resources = input.getText().toString().trim();</span>
<span class="nc" id="L1218">											serie.setExtResources(resources);</span>
<span class="nc" id="L1219">											db.updateExtResources(serie.getSerieId(), resources);</span>
<span class="nc" id="L1220">											return;</span>
										}
									})
<span class="nc" id="L1223">									.setNegativeButton(R.string.dialog_cancel, new DialogInterface.OnClickListener() {</span>
										public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L1225">											keyboard.hideSoftInputFromWindow(input.getWindowToken(), 0);</span>
<span class="nc" id="L1226">											return;</span>
										}
									})
<span class="nc" id="L1229">									.show();</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">								if (extResourcesInput.length() == 0) {</span>
<span class="nc" id="L1231">									input.setText(&quot;Examples:\ntvshow.wikia.com\n*tvshow.blogspot.com\nLong-press show poster to directly open the starred url&quot;);</span>
<span class="nc" id="L1232">									input.selectAll();</span>
								}
<span class="nc" id="L1234">								input.requestFocus();</span>
<span class="nc" id="L1235">								keyboard.toggleSoftInput(InputMethodManager.SHOW_FORCED, InputMethodManager.HIDE_NOT_ALWAYS);</span>
							} else {
<span class="nc" id="L1237">								browseExtResource(extResources[item]);</span>
							}
					}
<span class="nc" id="L1240">				}</span>
			})
<span class="nc" id="L1242">			.show();</span>
<span class="nc" id="L1243">	}</span>

	private void browseExtResource(String url) {
<span class="nc" id="L1246">		url = url.trim();</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">		if (url.startsWith(&quot;*&quot;))</span>
<span class="nc" id="L1248">			url = url.substring(1).trim();</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">		if (!url.startsWith(&quot;http&quot;))</span>
<span class="nc" id="L1250">			url = &quot;https://&quot;+ url;</span>
<span class="nc" id="L1251">		Intent browse = new Intent(Intent.ACTION_VIEW, Uri.parse(url));</span>
<span class="nc" id="L1252">		browse.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L1253">		startActivity(browse);</span>
<span class="nc" id="L1254">	}</span>

	private void updateSerie(final TVShowItem serie, int position) {
<span class="nc" id="L1257">		updateSerie(serie, null, position);</span>
<span class="nc" id="L1258">	}</span>

	private void updateSerie(TVShowItem serie, final String langCode, int position) {
<span class="nc bnc" id="L1261" title="All 2 branches missed.">		if (!utils.isNetworkAvailable(DroidShows.this)) {</span>
<span class="nc" id="L1262">			Toast.makeText(getApplicationContext(), R.string.messages_no_internet, Toast.LENGTH_LONG).show();</span>
		} else {
<span class="nc" id="L1264">			final String serieId = serie.getSerieId();</span>
<span class="nc" id="L1265">			final String serieName = serie.getName();</span>
<span class="nc" id="L1266">			final String currentLang = serie.getLanguage();</span>
<span class="nc" id="L1267">			Runnable updateserierun = new Runnable() {</span>
				public void run() {
<span class="nc bnc" id="L1269" title="All 2 branches missed.">					if (theTVDB == null)</span>
<span class="nc" id="L1270">						theTVDB = new TheTVDB(&quot;8AC675886350B3C3&quot;, useMirror);</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">					Serie sToUpdate = theTVDB.getSerie(serieId, langCode == null ? currentLang : langCode);</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">					if (sToUpdate == null) {</span>
<span class="nc" id="L1273">						errorNotify(serieName);</span>
<span class="nc" id="L1274">						m_ProgressDialog.dismiss();</span>
					} else {
<span class="nc" id="L1276">						dialogMsg = getString(R.string.messages_title_updating_db) + &quot; - &quot; + serieName;</span>
<span class="nc" id="L1277">						runOnUiThread(changeMessage);</span>
<span class="nc" id="L1278">						String toastMsg = getString(R.string.menu_context_updated);</span>
<span class="nc bnc" id="L1279" title="All 6 branches missed.">						if (!db.updateSerie(sToUpdate, langCode == null ? latestSeasonOption == UPDATE_LATEST_SEASON_ONLY : false))</span>
<span class="nc" id="L1280">							toastMsg = &quot;Database error while updating show&quot;;</span>
<span class="nc" id="L1281">						updatePosterThumb(serieId, sToUpdate);</span>
<span class="nc" id="L1282">						m_ProgressDialog.dismiss();</span>
<span class="nc" id="L1283">						Looper.prepare();</span>
<span class="nc" id="L1284">							Toast.makeText(getApplicationContext(),</span>
<span class="nc" id="L1285">								sToUpdate.getSerieName() +&quot; &quot;+ toastMsg,</span>
<span class="nc" id="L1286">								Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L1287">							listView.post(updateShowView(serieId));</span>
<span class="nc" id="L1288">						Looper.loop();</span>
					}
<span class="nc" id="L1290">					theTVDB = null;</span>
<span class="nc" id="L1291">				}</span>
			};
<span class="nc" id="L1293">			m_ProgressDialog = ProgressDialog.show(DroidShows.this, serie.getName(), getString(R.string.messages_update_serie), true, false);</span>
<span class="nc" id="L1294">			updateShowTh = new Thread(updateserierun);</span>
<span class="nc" id="L1295">			updateShowTh.start();</span>
		}
<span class="nc" id="L1297">	}</span>

	@SuppressWarnings(&quot;deprecation&quot;)
	public void updatePosterThumb(String serieId, Serie sToUpdate) {
<span class="nc" id="L1301">		Cursor c = DroidShows.db.Query(&quot;SELECT posterInCache, poster, posterThumb FROM series WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
<span class="nc" id="L1302">		c.moveToFirst();</span>
<span class="nc bnc" id="L1303" title="All 4 branches missed.">		if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="nc" id="L1304">			String posterInCache = c.getString(0);</span>
<span class="nc" id="L1305">			String poster = c.getString(1);</span>
<span class="nc" id="L1306">			String posterThumbPath = c.getString(2);</span>
<span class="nc" id="L1307">			URL posterURL = null;</span>
<span class="nc bnc" id="L1308" title="All 4 branches missed.">			if (!posterInCache.equals(&quot;true&quot;) || !(new File(posterThumbPath).exists())) {</span>
<span class="nc" id="L1309">				poster = sToUpdate.getPoster();</span>
				try {
<span class="nc" id="L1311">					posterURL = new URL(poster);</span>
<span class="nc" id="L1312">					new File(posterThumbPath).delete();</span>
<span class="nc" id="L1313">					posterThumbPath = getApplicationContext().getFilesDir().getAbsolutePath() +&quot;/thumbs&quot;+ posterURL.getFile().toString();</span>
<span class="nc" id="L1314">				} catch (MalformedURLException e) {</span>
<span class="nc" id="L1315">					Log.e(SQLiteStore.TAG, sToUpdate.getSerieName() +&quot; doesn't have a poster URL&quot;);</span>
<span class="nc" id="L1316">					e.printStackTrace();</span>
<span class="nc" id="L1317">					return;</span>
<span class="nc" id="L1318">				}</span>
<span class="nc" id="L1319">				File posterThumbFile = null;</span>
				try {
<span class="nc" id="L1321">					posterThumbFile = new File(posterThumbPath);</span>
<span class="nc" id="L1322">					FileUtils.copyURLToFile(posterURL, posterThumbFile);</span>
<span class="nc" id="L1323">				} catch (IOException e) {</span>
<span class="nc" id="L1324">					Log.e(SQLiteStore.TAG, &quot;Could not download poster: &quot;+ posterURL);</span>
<span class="nc" id="L1325">					e.printStackTrace();</span>
<span class="nc" id="L1326">					return;</span>
<span class="nc" id="L1327">				}</span>
<span class="nc" id="L1328">				Bitmap posterThumb = BitmapFactory.decodeFile(posterThumbPath);</span>
<span class="nc bnc" id="L1329" title="All 2 branches missed.">				if (posterThumb == null) {</span>
<span class="nc" id="L1330">					Log.e(SQLiteStore.TAG, &quot;Corrupt or unknown poster file type: &quot;+ posterThumbPath);</span>
<span class="nc" id="L1331">					return;</span>
				}
<span class="nc" id="L1333">				int width = getWindowManager().getDefaultDisplay().getWidth();</span>
<span class="nc" id="L1334">				int height = getWindowManager().getDefaultDisplay().getHeight();</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">				int newHeight = (int) ((height &gt; width ? height : width) * 0.265);</span>
<span class="nc" id="L1336">				int newWidth = (int) (1.0 * posterThumb.getWidth() / posterThumb.getHeight() * newHeight);</span>
<span class="nc" id="L1337">				Bitmap resizedBitmap = Bitmap.createScaledBitmap(posterThumb, newWidth, newHeight, true);</span>
<span class="nc" id="L1338">				OutputStream fOut = null;</span>
				try {
<span class="nc" id="L1340">					fOut = new FileOutputStream(posterThumbFile, false);</span>
<span class="nc" id="L1341">					resizedBitmap.compress(Bitmap.CompressFormat.JPEG, 90, fOut);</span>
<span class="nc" id="L1342">					fOut.flush();</span>
<span class="nc" id="L1343">					fOut.close();</span>
<span class="nc" id="L1344">					db.execQuery(&quot;UPDATE series SET posterInCache='true', poster='&quot;+ poster</span>
						+&quot;', posterThumb='&quot;+ posterThumbPath +&quot;' WHERE id='&quot;+ serieId +&quot;'&quot;);
<span class="nc" id="L1346">					Log.d(SQLiteStore.TAG, &quot;Updated poster thumb for &quot;+ sToUpdate.getSerieName());</span>
<span class="nc" id="L1347">				} catch (FileNotFoundException e) {</span>
<span class="nc" id="L1348">					Log.e(SQLiteStore.TAG, &quot;File not found:&quot;+ posterThumbFile);</span>
<span class="nc" id="L1349">					e.printStackTrace();</span>
<span class="nc" id="L1350">				} catch (IOException e) {</span>
<span class="nc" id="L1351">					e.printStackTrace();</span>
<span class="nc" id="L1352">				}</span>
<span class="nc" id="L1353">				posterThumb.recycle();</span>
<span class="nc" id="L1354">				resizedBitmap.recycle();</span>
<span class="nc" id="L1355">				System.gc();</span>
<span class="nc" id="L1356">				posterThumb = null;</span>
<span class="nc" id="L1357">				resizedBitmap = null;</span>
			}
		}
<span class="nc" id="L1360">		c.close();</span>
<span class="nc" id="L1361">	}</span>

<span class="fc" id="L1363">	private Runnable changeMessage = new Runnable() {</span>
		public void run() {
<span class="nc" id="L1365">			m_ProgressDialog.setMessage(dialogMsg);</span>
<span class="nc" id="L1366">		}</span>
	};

	public void clearFilter(View v) {
<span class="nc" id="L1370">		main.setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L1371">		keyboard.hideSoftInputFromWindow(searchV.getWindowToken(), 0);</span>
<span class="nc" id="L1372">		searchV.setText(&quot;&quot;);</span>
<span class="nc" id="L1373">		findViewById(R.id.search).setVisibility(View.GONE);</span>
<span class="nc" id="L1374">		getSeries();</span>
<span class="nc" id="L1375">	}</span>

	public void searchForShow(View v) {
<span class="fc" id="L1378">		keyboard.hideSoftInputFromWindow(searchV.getWindowToken(), 0);</span>
<span class="fc" id="L1379">		Intent startSearch = new Intent(DroidShows.this, AddSerie.class);</span>
<span class="fc" id="L1380">		startSearch.putExtra(SearchManager.QUERY, searchV.getText().toString());</span>
<span class="fc" id="L1381">		startSearch.setAction(Intent.ACTION_SEARCH);</span>
<span class="fc" id="L1382">		startActivity(startSearch);</span>
<span class="fc" id="L1383">	}</span>

	public void updateAllSeriesDialog() {
<span class="nc bnc" id="L1386" title="All 2 branches missed.">		String updateMessageAD = getString(R.string.dialog_update_series) + (latestSeasonOption == UPDATE_ALL_SEASONS ? getString(R.string.dialog_update_speedup) : &quot;&quot;);</span>
<span class="nc" id="L1387">		AlertDialog.Builder alertDialog = new AlertDialog.Builder(this)</span>
<span class="nc" id="L1388">			.setTitle(R.string.messages_title_update_series)</span>
<span class="nc" id="L1389">			.setMessage(updateMessageAD)</span>
<span class="nc" id="L1390">			.setIcon(android.R.drawable.ic_dialog_alert)</span>
<span class="nc" id="L1391">			.setCancelable(false)</span>
<span class="nc" id="L1392">			.setPositiveButton(getString(R.string.dialog_ok), new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L1394">					updateAllSeries(showArchive);</span>
<span class="nc" id="L1395">					return;</span>
				}
			})
<span class="nc" id="L1398">			.setNegativeButton(getString(R.string.dialog_cancel), new DialogInterface.OnClickListener() {</span>
				public void onClick(DialogInterface dialog, int which) {
<span class="nc" id="L1400">					return;</span>
				}
			});
<span class="nc" id="L1403">		alertDialog.show();</span>
<span class="nc" id="L1404">	}</span>

	public void updateAllSeries(final int showArchive) {
<span class="nc bnc" id="L1407" title="All 2 branches missed.">		if (!utils.isNetworkAvailable(DroidShows.this)) {</span>
<span class="nc" id="L1408">			Toast.makeText(getApplicationContext(), R.string.messages_no_internet, Toast.LENGTH_LONG).show();</span>
<span class="nc bnc" id="L1409" title="All 4 branches missed.">		} else if (updateAllSeriesPD == null || !updateAllSeriesPD.isShowing()) {</span>
<span class="nc" id="L1410">			final List&lt;TVShowItem&gt; seriesToUpdate = new ArrayList&lt;TVShowItem&gt;();</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">			List&lt;String&gt; ids = db.getSeries(searching() ? 2 : showArchive, false, null);</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">			for (String id : ids)</span>
<span class="nc" id="L1413">				seriesToUpdate.add(db.createTVShowItem(id));</span>
<span class="nc" id="L1414">			final Runnable updateMessage = new Runnable() {</span>
				public void run() {
<span class="nc" id="L1416">					updateAllSeriesPD.setMessage(dialogMsg);</span>
<span class="nc" id="L1417">					updateAllSeriesPD.show();</span>
<span class="nc" id="L1418">				}</span>
			};
<span class="nc" id="L1420">			final Runnable updateallseries = new Runnable() {</span>
				public void run() {
<span class="nc bnc" id="L1422" title="All 2 branches missed.">					if (theTVDB == null)</span>
<span class="nc" id="L1423">						theTVDB = new TheTVDB(&quot;8AC675886350B3C3&quot;, useMirror);</span>
<span class="nc" id="L1424">					String updatesFailed = &quot;&quot;;</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">					for (int i = 0; i &lt; seriesToUpdate.size(); i++) {</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">						Log.d(SQLiteStore.TAG, &quot;Getting updated info from TheTVDB &quot;+ (useMirror ? &quot;MIRROR &quot; : &quot;&quot;)</span>
<span class="nc" id="L1427">							+&quot;for TV show &quot; + seriesToUpdate.get(i).getName() +&quot; [&quot;+ (i+1) +&quot;/&quot;+ (seriesToUpdate.size()) +&quot;]&quot;);</span>
<span class="nc" id="L1428">						dialogMsg = seriesToUpdate.get(i).getName() + &quot;\u2026&quot;;</span>
<span class="nc" id="L1429">						updateAllSeriesPD.incrementProgressBy(1);</span>
<span class="nc" id="L1430">						runOnUiThread(updateMessage);</span>
<span class="nc" id="L1431">						Serie sToUpdate = theTVDB.getSerie(seriesToUpdate.get(i).getSerieId(), seriesToUpdate.get(i).getLanguage());</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">						if (sToUpdate == null) {</span>
<span class="nc" id="L1433">							updatesFailed += dialogMsg +&quot; &quot;;</span>
						} else {
							try {
<span class="nc bnc" id="L1436" title="All 4 branches missed.">								if (!db.updateSerie(sToUpdate, latestSeasonOption == UPDATE_LATEST_SEASON_ONLY)) {</span>
<span class="nc" id="L1437">									Looper.prepare();	// Threads don't have a message loop</span>
<span class="nc" id="L1438">									String error = getString(R.string.messages_error_dbupdate) +&quot; &quot;+ sToUpdate.getSerieName();</span>
<span class="nc" id="L1439">									Log.e(SQLiteStore.TAG, error);</span>
<span class="nc" id="L1440">									Toast.makeText(getApplicationContext(), error, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L1441">									Looper.loop();</span>
								}
<span class="nc" id="L1443">								updatePosterThumb(seriesToUpdate.get(i).getSerieId(), sToUpdate);</span>
<span class="nc" id="L1444">							} catch (Exception e) {</span>
<span class="nc" id="L1445">								e.printStackTrace();</span>
<span class="nc" id="L1446">							}</span>
						}
					}
<span class="nc bnc" id="L1449" title="All 2 branches missed.">					if (updatesFailed.length() &gt; 0) {</span>
<span class="nc" id="L1450">						final String updatesFailedResult = updatesFailed;</span>
<span class="nc" id="L1451">						runOnUiThread(new Runnable() {</span>
<span class="nc" id="L1452">							public void run() {errorNotify(updatesFailedResult);}</span>
						});
					}
<span class="nc" id="L1455">					updateShowStats();</span>
<span class="nc" id="L1456">					updateAllSeriesPD.dismiss();</span>
<span class="nc" id="L1457">					theTVDB = null;</span>
<span class="nc" id="L1458">				}</span>
			};
<span class="nc" id="L1460">			updateAllSeriesPD = new ProgressDialog(this);</span>
<span class="nc" id="L1461">			updateAllSeriesPD.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);</span>
<span class="nc" id="L1462">			updateAllSeriesPD.setTitle(R.string.messages_title_updating_series);</span>
<span class="nc" id="L1463">			updateAllSeriesPD.setMessage(getString(R.string.messages_update_series));</span>
<span class="nc" id="L1464">			updateAllSeriesPD.setCancelable(false);</span>
<span class="nc" id="L1465">			updateAllSeriesPD.setMax(seriesToUpdate.size());</span>
<span class="nc" id="L1466">			updateAllSeriesPD.setProgress(0);</span>
<span class="nc" id="L1467">			updateAllSeriesPD.show();</span>
<span class="nc" id="L1468">			updateAllShowsTh = new Thread(updateallseries);</span>
<span class="nc" id="L1469">			updateAllShowsTh.start();</span>
		}
<span class="nc" id="L1471">	}</span>

	@SuppressLint(&quot;NewApi&quot;)
	@SuppressWarnings(&quot;deprecation&quot;)
	private void errorNotify(String error) {
<span class="nc" id="L1476">		NotificationManager mNotificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span>
<span class="nc" id="L1477">		PendingIntent appIntent = PendingIntent.getActivity(DroidShows.this, 0, new Intent(), 0);</span>

<span class="nc" id="L1479">		Notification notification = null;</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">		if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB) {</span>
<span class="nc" id="L1481">			notification = new Notification(R.drawable.noposter,</span>
<span class="nc" id="L1482">					getString(R.string.messages_thetvdb_con_error), System.currentTimeMillis());</span>
			try {
<span class="nc" id="L1484">				Method deprecatedMethod = notification.getClass().getMethod(&quot;setLatestEventInfo&quot;, Context.class, CharSequence.class, CharSequence.class, PendingIntent.class);</span>
<span class="nc" id="L1485">				deprecatedMethod.invoke(notification, getApplicationContext(), getString(R.string.messages_thetvdb_con_error), error, appIntent);</span>
<span class="nc" id="L1486">			} catch (Exception e) {</span>
<span class="nc" id="L1487">				Log.e(SQLiteStore.TAG, &quot;Method setLatestEventInfo not found&quot;, e);</span>
<span class="nc" id="L1488">			}</span>
		} else {
<span class="nc" id="L1490">			Notification.Builder builder = new Notification.Builder(getApplicationContext())</span>
<span class="nc" id="L1491">				.setContentIntent(appIntent)</span>
<span class="nc" id="L1492">				.setSmallIcon(R.drawable.noposter)</span>
<span class="nc" id="L1493">				.setContentTitle(getString(R.string.messages_thetvdb_con_error))</span>
<span class="nc" id="L1494">				.setContentText(error);</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">			if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN)</span>
<span class="nc" id="L1496">			    notification = builder.getNotification();</span>
			else
<span class="nc" id="L1498">			    notification = builder.build();</span>
		}

<span class="nc" id="L1501">		notification.flags |= Notification.FLAG_AUTO_CANCEL;</span>
<span class="nc" id="L1502">		mNotificationManager.notify(0, notification);</span>
<span class="nc" id="L1503">	}</span>

	private void getSeries() {
<span class="fc" id="L1506">		getSeries(showArchive, filterNetworks);</span>
<span class="fc" id="L1507">	}</span>

	private void getSeries(int showArchive) {
<span class="nc" id="L1510">		getSeries(showArchive, filterNetworks);</span>
<span class="nc" id="L1511">	}</span>

	private void getSeries(int showArchive, boolean filterNetworks) {
<span class="fc" id="L1514">		main.setVisibility(View.INVISIBLE);</span>
<span class="fc bfc" id="L1515" title="All 2 branches covered.">		if (asyncInfo != null)</span>
<span class="fc" id="L1516">			asyncInfo.cancel(true);</span>
		try {
<span class="pc bpc" id="L1518" title="1 of 2 branches missed.">			if (!logMode) {</span>
<span class="fc" id="L1519">				List&lt;String&gt; ids = db.getSeries(showArchive, filterNetworks, networks);</span>
<span class="fc" id="L1520">				series.clear();</span>
<span class="fc" id="L1521">				seriesAdapter.notifyDataSetChanged();</span>
<span class="pc bpc" id="L1522" title="1 of 2 branches missed.">				for (int i = 0; i &lt; ids.size(); i++)</span>
<span class="nc" id="L1523">					series.add(db.createTVShowItem(ids.get(i)));</span>
<span class="fc" id="L1524">			} else {</span>
<span class="nc" id="L1525">				List&lt;TVShowItem&gt; episodes = db.getLog();</span>
<span class="nc" id="L1526">				series.clear();</span>
<span class="nc" id="L1527">				seriesAdapter.notifyDataSetChanged();</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">				for (int i = 0; i &lt; episodes.size(); i++)</span>
<span class="nc" id="L1529">					series.add(episodes.get(i));</span>
			}
<span class="fc" id="L1531">			setTitle(getString(R.string.layout_app_name)</span>
<span class="pc bpc" id="L1532" title="2 of 4 branches missed.">					+ (!logMode ? (showArchive == 1 ? &quot; - &quot;+ getString(R.string.archive) : &quot;&quot;) :</span>
<span class="pc" id="L1533">						&quot; - &quot;+ getString(R.string.menu_log)));</span>
<span class="fc" id="L1534">			runOnUiThread(updateListView);</span>
<span class="nc" id="L1535">		} catch (Exception e) {</span>
<span class="nc" id="L1536">			Log.e(SQLiteStore.TAG, &quot;Error populating TVShowItems or no shows added yet&quot;);</span>
<span class="nc" id="L1537">			e.printStackTrace();</span>
<span class="fc" id="L1538">		}</span>
<span class="fc" id="L1539">		setFastScroll();</span>
<span class="pc bpc" id="L1540" title="1 of 2 branches missed.">		findViewById(R.id.add_show).setVisibility(!logMode ? View.VISIBLE : View.GONE);</span>
<span class="fc" id="L1541">		main.setVisibility(View.VISIBLE);</span>
<span class="fc" id="L1542">		asyncInfo = new AsyncInfo();</span>
<span class="fc" id="L1543">		asyncInfo.execute();</span>
<span class="fc" id="L1544">	}</span>

	public void getNextLogged() {
<span class="nc" id="L1547">		List&lt;TVShowItem&gt; episodes = db.getLog(series.size());</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">		for (int i = 0; i &lt; episodes.size(); i++)</span>
<span class="nc" id="L1549">			series.add(episodes.get(i));</span>
<span class="nc" id="L1550">		seriesAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L1551">		listView.gettingNextLogged = false;</span>
<span class="nc" id="L1552">	}</span>

<span class="fc" id="L1554">	public static Runnable updateListView = new Runnable() {</span>
		public void run() {
<span class="fc" id="L1556">			seriesAdapter.notifyDataSetChanged();</span>
<span class="pc bpc" id="L1557" title="1 of 2 branches missed.">			if (!logMode) seriesAdapter.sort(showsComperator);</span>
<span class="pc bpc" id="L1558" title="1 of 2 branches missed.">			if (seriesAdapter.isFiltered)</span>
<span class="nc" id="L1559">				seriesAdapter.getFilter().filter(searchV.getText());</span>
<span class="fc" id="L1560">		}</span>
	};

<span class="fc" id="L1563">	private static Comparator&lt;TVShowItem&gt; showsComperator = new Comparator&lt;TVShowItem&gt;() {</span>
		public int compare(TVShowItem object1, TVShowItem object2) {
<span class="nc bnc" id="L1565" title="All 4 branches missed.">			if (pinnedShows.contains(object1.getSerieId()) &amp;&amp; !pinnedShows.contains(object2.getSerieId()))</span>
<span class="nc" id="L1566">				return -1;</span>
<span class="nc bnc" id="L1567" title="All 4 branches missed.">			else if (pinnedShows.contains(object2.getSerieId()) &amp;&amp; !pinnedShows.contains(object1.getSerieId()))</span>
<span class="nc" id="L1568">				return 1;</span>

<span class="nc bnc" id="L1570" title="All 2 branches missed.">			if (sortOption == SORT_BY_UNSEEN) {</span>
<span class="nc" id="L1571">				int unwatchedAired1 = object1.getUnwatchedAired();</span>
<span class="nc" id="L1572">				int unwatchedAired2 = object2.getUnwatchedAired();</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">				if (unwatchedAired1 == unwatchedAired2) {</span>
<span class="nc" id="L1574">					Date nextAir1 = object1.getNextAir();</span>
<span class="nc" id="L1575">					Date nextAir2 = object2.getNextAir();</span>
<span class="nc bnc" id="L1576" title="All 4 branches missed.">					if (nextAir1 == null &amp;&amp; nextAir2 == null)</span>
<span class="nc" id="L1577">						return object1.getName().compareToIgnoreCase(object2.getName());</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">					if (nextAir1 == null)</span>
<span class="nc" id="L1579">						return 1;</span>
<span class="nc bnc" id="L1580" title="All 2 branches missed.">					if (nextAir2 == null)</span>
<span class="nc" id="L1581">						return -1;</span>
<span class="nc" id="L1582">					return nextAir1.compareTo(nextAir2);</span>
				}
<span class="nc bnc" id="L1584" title="All 2 branches missed.">				if (unwatchedAired1 == 0)</span>
<span class="nc" id="L1585">					return 1;</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">				if (unwatchedAired2 == 0)</span>
<span class="nc" id="L1587">					return -1;</span>
<span class="nc" id="L1588">				return ((Integer) unwatchedAired2).compareTo(unwatchedAired1);</span>
			} else {
<span class="nc" id="L1590">				return object1.getName().compareToIgnoreCase(object2.getName());</span>
			}
		}
	};

	@Override
	public void onPause() {
<span class="fc" id="L1597">		super.onPause();</span>
<span class="fc" id="L1598">		SharedPreferences.Editor ed = sharedPrefs.edit();</span>
<span class="fc" id="L1599">		ed.putBoolean(AUTO_BACKUP_PREF_NAME, autoBackup);</span>
<span class="fc" id="L1600">		ed.putString(BACKUP_FOLDER_PREF_NAME, backupFolder);</span>
<span class="fc" id="L1601">		ed.putBoolean(BACKUP_VERSIONING_PREF_NAME, backupVersioning);</span>
<span class="fc" id="L1602">		ed.putInt(SORT_PREF_NAME, sortOption);</span>
<span class="fc" id="L1603">		ed.putBoolean(EXCLUDE_SEEN_PREF_NAME, excludeSeen);</span>
<span class="fc" id="L1604">		ed.putInt(LATEST_SEASON_PREF_NAME, latestSeasonOption);</span>
<span class="fc" id="L1605">		ed.putBoolean(INCLUDE_SPECIALS_NAME, includeSpecialsOption);</span>
<span class="fc" id="L1606">		ed.putBoolean(FULL_LINE_CHECK_NAME, fullLineCheckOption);</span>
<span class="fc" id="L1607">		ed.putBoolean(SWITCH_SWIPE_DIRECTION, switchSwipeDirection);</span>
<span class="fc" id="L1608">		ed.putString(LAST_STATS_UPDATE_NAME, lastStatsUpdateCurrent);</span>
<span class="fc" id="L1609">		ed.putString(LAST_STATS_UPDATE_ARCHIVE_NAME, lastStatsUpdateArchive);</span>
<span class="fc" id="L1610">		ed.putString(LANGUAGE_CODE_NAME, langCode);</span>
<span class="fc" id="L1611">		ed.putBoolean(SHOW_NEXT_AIRING, showNextAiring);</span>
<span class="fc" id="L1612">		ed.putBoolean(MARK_FROM_LAST_WATCHED, markFromLastWatched);</span>
<span class="fc" id="L1613">		ed.putBoolean(USE_MIRROR, useMirror);</span>
<span class="fc" id="L1614">		ed.putString(PINNED_SHOWS_NAME, pinnedShows.toString());</span>
<span class="fc" id="L1615">		ed.putBoolean(FILTER_NETWORKS_NAME, filterNetworks);</span>
<span class="fc" id="L1616">		ed.putString(NETWORKS_NAME, networks.toString());</span>
<span class="fc" id="L1617">		ed.commit();</span>
<span class="fc" id="L1618">	}</span>

	@Override
	protected void onDestroy() {
<span class="pc bpc" id="L1622" title="5 of 6 branches missed.">		if (autoBackup &amp;&amp; theTVDB == null &amp;&amp; asyncInfo.getStatus() != AsyncTask.Status.RUNNING)	// not updating</span>
<span class="nc" id="L1623">			backup(true);</span>
<span class="fc" id="L1624">		super.onDestroy();</span>
<span class="fc" id="L1625">	}</span>

	@Override
	public void onRestart() {
<span class="fc" id="L1629">		super.onRestart();</span>
<span class="pc bpc" id="L1630" title="1 of 2 branches missed.">		if (!logMode) {</span>
<span class="fc" id="L1631">			listView.post(updateShowView(backFromSeasonSerieId));</span>
<span class="fc" id="L1632">			backFromSeasonSerieId = null;</span>
		} else {
<span class="nc bnc" id="L1634" title="All 2 branches missed.">			if (!removeEpisodeFromLog.isEmpty()) {</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">				for (int i = 0; i &lt; series.size(); i++)</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">					if (series.get(i).getEpisodeId().equals(removeEpisodeFromLog)) {</span>
<span class="nc" id="L1637">						series.remove(i);</span>
<span class="nc" id="L1638">						listView.post(updateListView);</span>
					}
<span class="nc" id="L1640">				removeEpisodeFromLog = &quot;&quot;;</span>
			}
		}
<span class="fc" id="L1643">	}</span>

	@Override
	public void onResume() {
<span class="fc" id="L1647">		super.onResume();</span>
<span class="pc bpc" id="L1648" title="1 of 2 branches missed.">		if (searchV.getText().length() &gt; 0) {</span>
<span class="nc" id="L1649">			findViewById(R.id.search).setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1650">			listView.requestFocus();</span>
		}
<span class="pc bpc" id="L1652" title="2 of 6 branches missed.">		if (!logMode &amp;&amp; (asyncInfo == null || asyncInfo.getStatus() != AsyncTask.Status.RUNNING)) {</span>
<span class="fc" id="L1653">			asyncInfo = new AsyncInfo();</span>
<span class="fc" id="L1654">			asyncInfo.execute();</span>
		}
<span class="fc" id="L1656">	}</span>

	private static class AsyncInfo extends AsyncTask&lt;Void, Void, Void&gt; {
		@Override
		protected Void doInBackground(Void... params) {
//			Log.d(SQLiteStore.TAG, &quot;AsyncInfo Initializing&quot;);
			try {
<span class="fc" id="L1663">				int showArchiveTmp = showArchive;</span>
<span class="fc" id="L1664">				String newToday = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).format(Calendar.getInstance().getTime());	// thread needs own SimpleDateFormat to prevent collisions in formatting of other dates</span>
<span class="pc bpc" id="L1665" title="1 of 2 branches missed.">				String lastStatsUpdate = (showArchiveTmp == 0 ? lastStatsUpdateCurrent : lastStatsUpdateArchive);</span>
<span class="pc bpc" id="L1666" title="1 of 2 branches missed.">				if (!lastStatsUpdate.equals(newToday)) {</span>
<span class="nc" id="L1667">					db.updateToday(newToday);</span>
//					Log.d(SQLiteStore.TAG, &quot;AsyncInfo RUNNING | Today = &quot;+ newToday);
<span class="nc bnc" id="L1669" title="All 2 branches missed.">					for (int i = 0; i &lt; series.size(); i++) {</span>
<span class="nc" id="L1670">						TVShowItem serie = series.get(i);</span>
<span class="nc bnc" id="L1671" title="All 2 branches missed.">						if (isCancelled()) return null;</span>
<span class="nc" id="L1672">						String serieId = serie.getSerieId();</span>
<span class="nc" id="L1673">						boolean dvdOrder = serie.getDvdOrder();</span>
<span class="nc" id="L1674">						int unwatched = db.getEpsUnwatched(serieId, dvdOrder);</span>
<span class="nc" id="L1675">						int unwatchedAired = db.getEpsUnwatchedAired(serieId, dvdOrder);</span>
<span class="nc bnc" id="L1676" title="All 4 branches missed.">						if (unwatched != serie.getUnwatched() || unwatchedAired != serie.getUnwatchedAired()) {</span>
<span class="nc bnc" id="L1677" title="All 2 branches missed.">							if (isCancelled()) return null;</span>
<span class="nc" id="L1678">							serie.setUnwatched(unwatched);</span>
<span class="nc" id="L1679">							serie.setUnwatchedAired(unwatchedAired);</span>
<span class="nc bnc" id="L1680" title="All 4 branches missed.">							if (showNextAiring &amp;&amp; unwatchedAired &gt; 0) {</span>
<span class="nc" id="L1681">								NextEpisode nextEpisode = db.getNextEpisode(serieId, dvdOrder);</span>
<span class="nc" id="L1682">								String nextEpisodeString = db.getNextEpisodeString(nextEpisode, true);</span>
<span class="nc" id="L1683">								serie.setNextEpisode(nextEpisodeString);</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">								if (isCancelled()) return null;</span>
<span class="nc" id="L1685">								db.execQuery(&quot;UPDATE series SET unwatched=&quot;+ unwatched +&quot;, unwatchedAired=&quot;+ unwatchedAired +&quot;, nextEpisode='&quot;+ nextEpisodeString +&quot;' WHERE id=&quot;+ serieId);</span>
<span class="nc" id="L1686">							} else {</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">								if (isCancelled()) return null;</span>
<span class="nc" id="L1688">								db.execQuery(&quot;UPDATE series SET unwatched=&quot;+ unwatched +&quot;, unwatchedAired=&quot;+ unwatchedAired +&quot; WHERE id=&quot;+ serieId);</span>
							}
						}
					}
<span class="nc bnc" id="L1692" title="All 2 branches missed.">					if (isCancelled()) return null;</span>
<span class="nc" id="L1693">					listView.post(updateListView);</span>
<span class="nc bnc" id="L1694" title="All 4 branches missed.">					if (showArchiveTmp == 0 || showArchiveTmp == 2)</span>
<span class="nc" id="L1695">						lastStatsUpdateCurrent = newToday;</span>
<span class="nc bnc" id="L1696" title="All 2 branches missed.">					if (showArchiveTmp &gt; 0)</span>
<span class="nc" id="L1697">						lastStatsUpdateArchive = newToday;</span>
//				Log.d(SQLiteStore.TAG, &quot;Updated show stats for &quot;+ (showArchiveTmp == 0 ? &quot;current&quot; : &quot;archive&quot;) +&quot; on &quot;+ newToday);
				}
<span class="nc" id="L1700">			} catch (Exception e) {</span>
<span class="nc" id="L1701">				e.printStackTrace();</span>
<span class="fc" id="L1702">			}</span>
<span class="fc" id="L1703">			return null;</span>
		}
	}

	@Override
	public boolean onSearchRequested() {
<span class="nc bnc" id="L1709" title="All 2 branches missed.">		if (logMode)</span>
<span class="nc" id="L1710">			return false;</span>
<span class="nc bnc" id="L1711" title="All 2 branches missed.">		if (findViewById(R.id.search).getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L1712">			findViewById(R.id.search).setVisibility(View.VISIBLE);</span>
<span class="nc" id="L1713">			getSeries(2, false);	// 2 = archive and current shows, false = don't filter networks</span>
		}
<span class="nc" id="L1715">		searchV.requestFocus();</span>
<span class="nc" id="L1716">		searchV.selectAll();</span>
<span class="nc" id="L1717">		keyboard.showSoftInput(searchV, 0);</span>
//		keyboard.toggleSoftInput(InputMethodManager.SHOW_FORCED, InputMethodManager.HIDE_NOT_ALWAYS);
<span class="nc" id="L1719">		return true;</span>
	}

	@Override
	public void onBackPressed() {
<span class="nc bnc" id="L1724" title="All 2 branches missed.">		if (searching())</span>
<span class="nc" id="L1725">			clearFilter(null);</span>
		else {
<span class="nc bnc" id="L1727" title="All 2 branches missed.">			if (logMode)</span>
<span class="nc" id="L1728">				toggleLogMode();</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">			else if (showArchive == 1)</span>
<span class="nc" id="L1730">				toggleArchive();</span>
			else
<span class="nc" id="L1732">				super.onBackPressed();</span>
<span class="nc bnc" id="L1733" title="All 2 branches missed.">			if (spinner != null)</span>
<span class="nc" id="L1734">				spinner.setSelection(showArchive);</span>
		}
<span class="nc" id="L1736">	}</span>

	@Override
	protected void onSaveInstanceState(Bundle outState) {
<span class="fc" id="L1740">		outState.putBoolean(&quot;searching&quot;, searching());</span>
<span class="fc" id="L1741">		outState.putInt(&quot;showArchive&quot;, showArchive);</span>
<span class="pc bpc" id="L1742" title="1 of 2 branches missed.">		if (m_ProgressDialog != null)</span>
<span class="nc" id="L1743">			m_ProgressDialog.dismiss();</span>
<span class="fc" id="L1744">		super.onSaveInstanceState(outState);</span>
<span class="fc" id="L1745">	}</span>

	public String translateStatus(String statusValue) {
<span class="nc bnc" id="L1748" title="All 2 branches missed.">		if (statusValue.equalsIgnoreCase(&quot;Continuing&quot;)) {</span>
<span class="nc" id="L1749">			return getString(R.string.showstatus_continuing);</span>
<span class="nc bnc" id="L1750" title="All 2 branches missed.">		} else if (statusValue.equalsIgnoreCase(&quot;Ended&quot;)) {</span>
<span class="nc" id="L1751">			return getString(R.string.showstatus_ended);</span>
		} else {
<span class="nc" id="L1753">			return statusValue.toLowerCase();</span>
		}
	}

	private boolean searching() {
<span class="pc bpc" id="L1758" title="2 of 4 branches missed.">		return (seriesAdapter.isFiltered || findViewById(R.id.search).getVisibility() == View.VISIBLE);</span>
	}

	public class SeriesAdapter extends ArrayAdapter&lt;TVShowItem&gt; {
		private List&lt;TVShowItem&gt; items;
		private ShowsFilter filter;
		private boolean isFiltered;
<span class="fc" id="L1765">		private LayoutInflater vi = (LayoutInflater) getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span>
		private int iconListPosition;
<span class="fc" id="L1767">		private ColorStateList textViewColors = new TextView(getContext()).getTextColors();</span>

<span class="fc" id="L1769">		private final String strEpAired = getString(R.string.messages_ep_aired);</span>
<span class="fc" id="L1770">		private final String strNewEp = getString(R.string.messages_new_episode);</span>
<span class="fc" id="L1771">		private final String strNewEps = getString(R.string.messages_new_episodes);</span>
<span class="fc" id="L1772">		private final String strNextAiring = getString(R.string.messages_next_airing);</span>
<span class="fc" id="L1773">		private final String strNextEp = getString(R.string.messages_next_episode);</span>
<span class="fc" id="L1774">		private final String strNoNewEps = getString(R.string.messages_no_new_eps);</span>
<span class="fc" id="L1775">		private final String strOf = getString(R.string.messages_of);</span>
<span class="fc" id="L1776">		private final String strOn = getString(R.string.messages_on);</span>
<span class="fc" id="L1777">		private final String strSeason = getString(R.string.messages_season);</span>
<span class="fc" id="L1778">		private final String strSeasons = getString(R.string.messages_seasons);</span>
<span class="fc" id="L1779">		private final String strToBeAired = getString(R.string.messages_to_be_aired);</span>
<span class="fc" id="L1780">		private final String strToBeAiredPl = getString(R.string.messages_to_be_aired_pl);</span>

<span class="fc" id="L1782">		public SeriesAdapter(Context context, int textViewResourceId, List&lt;TVShowItem&gt; series) {</span>
<span class="fc" id="L1783">			super(context, textViewResourceId, series);</span>
<span class="fc" id="L1784">			items = series;</span>
<span class="fc" id="L1785">			isFiltered = false;</span>
<span class="fc" id="L1786">		}</span>

		@Override
		public int getCount() {
<span class="fc" id="L1790">			return items.size();</span>
		}

		@Override
		public Filter getFilter() {
<span class="nc bnc" id="L1795" title="All 2 branches missed.">			if (filter == null)</span>
<span class="nc" id="L1796">				filter = new ShowsFilter();</span>
<span class="nc" id="L1797">			return filter;</span>
		}

		@Override
		public TVShowItem getItem(int position) {
<span class="fc" id="L1802">			return items.get(position);</span>
		}

		public void setItem(int location, TVShowItem serie) {
<span class="nc" id="L1806">			items.set(location, serie);</span>
<span class="nc" id="L1807">			notifyDataSetChanged();</span>
<span class="nc" id="L1808">		}</span>

<span class="nc" id="L1810">		private class ShowsFilter extends Filter {</span>
			@SuppressLint(&quot;DefaultLocale&quot;)
			@Override
			protected FilterResults performFiltering(CharSequence constraint) {
<span class="nc" id="L1814">				FilterResults results = new FilterResults();</span>
<span class="nc bnc" id="L1815" title="All 4 branches missed.">				if (constraint == null || constraint.length() == 0) {</span>
<span class="nc" id="L1816">					results.count = series.size();</span>
<span class="nc" id="L1817">					results.values = series;</span>
<span class="nc" id="L1818">					isFiltered = false;</span>
				} else {
<span class="nc" id="L1820">					constraint = constraint.toString().toLowerCase();</span>
<span class="nc" id="L1821">					ArrayList&lt;TVShowItem&gt; filteredSeries = new ArrayList&lt;TVShowItem&gt;();</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">					for (TVShowItem serie : series) {</span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">						if (serie.getName().toLowerCase().contains(constraint))</span>
<span class="nc" id="L1824">							filteredSeries.add(serie);</span>
<span class="nc" id="L1825">					}</span>
<span class="nc" id="L1826">					results.count = filteredSeries.size();</span>
<span class="nc" id="L1827">					results.values = filteredSeries;</span>
<span class="nc" id="L1828">					isFiltered = true;</span>
				}
<span class="nc" id="L1830">				return results;</span>
			}

			@SuppressWarnings(&quot;unchecked&quot;)
			@Override
			protected void publishResults(CharSequence constraint, FilterResults results) {
<span class="nc" id="L1836">				items = (List&lt;TVShowItem&gt;) results.values;</span>
<span class="nc" id="L1837">				notifyDataSetChanged();</span>
<span class="nc" id="L1838">			}</span>
		}

		public View getView(final int position, View convertView, ViewGroup parent) {
<span class="fc" id="L1842">			TVShowItem serie = items.get(position);</span>
			ViewHolder holder;
<span class="pc bpc" id="L1844" title="12 of 14 branches missed.">			if (!logMode &amp;&amp;  excludeSeen &amp;&amp; !isFiltered &amp;&amp; serie != lastSerie &amp;&amp; serie.getUnwatchedAired() == 0 &amp;&amp; (serie.getNextAir() == null || serie.getNextAir().after(Calendar.getInstance().getTime()))) {</span>
<span class="nc bnc" id="L1845" title="All 4 branches missed.">				if (convertView == null || convertView.isEnabled()) {</span>
<span class="nc" id="L1846">					convertView = vi.inflate(R.layout.row_excluded, parent, false);</span>
<span class="nc" id="L1847">					convertView.setEnabled(false);</span>
				}
<span class="nc" id="L1849">				return convertView;</span>
<span class="pc bpc" id="L1850" title="1 of 4 branches missed.">			} else if (convertView == null || !convertView.isEnabled()) {</span>
<span class="fc" id="L1851">				convertView = vi.inflate(R.layout.row, parent, false);</span>
<span class="fc" id="L1852">				holder = new ViewHolder();</span>
<span class="fc" id="L1853">				holder.sn = (TextView) convertView.findViewById(R.id.seriename);</span>
<span class="fc" id="L1854">				holder.si = (TextView) convertView.findViewById(R.id.serieinfo);</span>
<span class="fc" id="L1855">				holder.sne = (TextView) convertView.findViewById(R.id.serienextepisode);</span>
<span class="fc" id="L1856">				holder.icon = (IconView) convertView.findViewById(R.id.serieicon);</span>
<span class="fc" id="L1857">				holder.context = (ImageView) convertView.findViewById(R.id.seriecontext);</span>
<span class="pc bpc" id="L1858" title="1 of 2 branches missed.">				if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP)</span>
<span class="fc" id="L1859">					holder.context.setImageResource(R.drawable.context_material);</span>
<span class="fc" id="L1860">				convertView.setEnabled(true);</span>
<span class="fc" id="L1861">				convertView.setTag(holder);</span>
<span class="fc" id="L1862">				holder.icon.setOnTouchListener(iconTouchListener);</span>
			} else {
<span class="fc" id="L1864">				holder = (ViewHolder) convertView.getTag();</span>
<span class="fc" id="L1865">				holder.icon.setOnClickListener(null);</span>
			}
<span class="pc bpc" id="L1867" title="1 of 2 branches missed.">			if (!logMode) {</span>
<span class="fc" id="L1868">				int nunwatched = serie.getUnwatched();</span>
<span class="fc" id="L1869">				int nunwatchedAired = serie.getUnwatchedAired();</span>
<span class="pc bpc" id="L1870" title="1 of 2 branches missed.">				String ended = (serie.getShowStatus().equalsIgnoreCase(&quot;Ended&quot;) ? &quot; \u2020&quot; : &quot;&quot;);</span>
<span class="pc bpc" id="L1871" title="1 of 2 branches missed.">				if (holder.sn != null) {</span>
<span class="pc bpc" id="L1872" title="1 of 2 branches missed.">					holder.sn.setText((pinnedShows.contains(serie.getSerieId()) ? &quot;\u2022 &quot; : &quot;&quot;) + serie.getName() + ended);</span>
<span class="pc bpc" id="L1873" title="3 of 4 branches missed.">					holder.sn.setEnabled(!searching() || !serie.getPassiveStatus());</span>
				}
<span class="pc bpc" id="L1875" title="1 of 2 branches missed.">				if (holder.si != null) {</span>
<span class="fc" id="L1876">					String siText = &quot;&quot;;</span>
<span class="fc" id="L1877">					int sNumber = serie.getSNumber();</span>
<span class="pc bpc" id="L1878" title="1 of 2 branches missed.">					if (sNumber == 1) {</span>
<span class="nc" id="L1879">						siText = sNumber +&quot; &quot;+ strSeason;</span>
					} else {
<span class="fc" id="L1881">						siText = sNumber +&quot; &quot;+ strSeasons;</span>
					}
<span class="fc" id="L1883">					String unwatched = &quot;&quot;;</span>
<span class="pc bpc" id="L1884" title="1 of 2 branches missed.">					if (nunwatched == 0) {</span>
<span class="nc" id="L1885">						unwatched = strNoNewEps;</span>
<span class="nc bnc" id="L1886" title="All 2 branches missed.">						if (!serie.getShowStatus().equalsIgnoreCase(&quot;null&quot;))</span>
<span class="nc" id="L1887">							unwatched += &quot; (&quot;+ translateStatus(serie.getShowStatus()) +&quot;)&quot;;</span>
<span class="nc" id="L1888">						holder.si.setEnabled(false);</span>
					} else {
<span class="pc bpc" id="L1890" title="1 of 2 branches missed.">						unwatched = nunwatched +&quot; &quot;+ (nunwatched &gt; 1 ? strNewEps : strNewEp) +&quot; &quot;;</span>
<span class="pc bpc" id="L1891" title="1 of 2 branches missed.">						if (nunwatchedAired &gt; 0) {</span>
<span class="pc bpc" id="L1892" title="4 of 6 branches missed.">							unwatched = (nunwatchedAired == nunwatched ? &quot;&quot; : nunwatchedAired +&quot; &quot;+ strOf +&quot; &quot;) + unwatched + strEpAired + (nunwatchedAired == nunwatched &amp;&amp; ended.isEmpty() ? &quot; \u00b7&quot; : &quot;&quot;);</span>
<span class="fc" id="L1893">							holder.si.setEnabled(true);</span>
						} else {
<span class="nc bnc" id="L1895" title="All 2 branches missed.">							unwatched += (nunwatched &gt; 1 ? strToBeAiredPl : strToBeAired);</span>
<span class="nc" id="L1896">							holder.si.setEnabled(false);</span>
						}
					}
<span class="fc" id="L1899">					holder.si.setText(siText +&quot; | &quot;+ unwatched);</span>
				}
<span class="pc bpc" id="L1901" title="1 of 2 branches missed.">				if (holder.sne != null) {</span>
<span class="pc bpc" id="L1902" title="2 of 4 branches missed.">					if (nunwatched &gt; 0 &amp;&amp; !serie.getNextEpisode().isEmpty()) {</span>
<span class="pc bpc" id="L1903" title="1 of 2 branches missed.">						holder.sne.setText(serie.getNextEpisode() == null ? &quot;&quot; : serie.getNextEpisode()</span>
<span class="fc" id="L1904">							.replace(&quot;[ne]&quot;, strNextEp)</span>
<span class="fc" id="L1905">							.replace(&quot;[na]&quot;, strNextAiring)</span>
<span class="fc" id="L1906">							.replace(&quot;[on]&quot;, strOn));</span>
<span class="pc bpc" id="L1907" title="2 of 4 branches missed.">						holder.sne.setEnabled(serie.getNextAir() != null &amp;&amp; serie.getNextAir().compareTo(Calendar.getInstance().getTime()) &lt;= 0);</span>
					} else {
<span class="nc" id="L1909">						holder.sne.setText(&quot;&quot;);</span>
					}
				}
<span class="pc bpc" id="L1912" title="1 of 2 branches missed.">				if (holder.icon != null) {</span>
<span class="fc" id="L1913">					Drawable icon = serie.getDIcon();</span>
<span class="pc bpc" id="L1914" title="1 of 4 branches missed.">					if (icon == null &amp;&amp; !serie.getIcon().equals(&quot;&quot;))</span>
<span class="fc" id="L1915">						icon = Drawable.createFromPath(serie.getIcon());</span>
<span class="pc bpc" id="L1916" title="1 of 2 branches missed.">					if (icon == null) {</span>
<span class="nc" id="L1917">						holder.icon.setImageResource(R.drawable.noposter);</span>
					} else {
<span class="fc" id="L1919">						holder.icon.setImageDrawable(icon);</span>
<span class="fc" id="L1920">						serie.setDIcon(icon);</span>
					}
				}
<span class="fc" id="L1923">			} else {</span>
<span class="nc bnc" id="L1924" title="All 2 branches missed.">				if (holder.sn != null) {</span>
<span class="nc" id="L1925">					holder.sn.setText(serie.getName());</span>
<span class="nc" id="L1926">					holder.sn.setTextColor(textViewColors);</span>
				}
<span class="nc bnc" id="L1928" title="All 2 branches missed.">				if (holder.si != null) {</span>
<span class="nc" id="L1929">					holder.si.setEnabled(true);</span>
<span class="nc" id="L1930">					holder.si.setText(serie.getEpisodeName());</span>
				}
<span class="nc bnc" id="L1932" title="All 2 branches missed.">				if (holder.sne != null) {</span>
<span class="nc" id="L1933">					holder.sne.setEnabled(true);</span>
<span class="nc" id="L1934">					holder.sne.setText(serie.getEpisodeSeen());</span>
				}
<span class="nc bnc" id="L1936" title="All 2 branches missed.">				if (holder.icon != null) {</span>
<span class="nc" id="L1937">					Drawable icon = serie.getDIcon();</span>
<span class="nc bnc" id="L1938" title="All 4 branches missed.">					if (icon == null &amp;&amp; !serie.getIcon().equals(&quot;&quot;))</span>
<span class="nc" id="L1939">						icon = Drawable.createFromPath(serie.getIcon());</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">					if (icon == null) {</span>
<span class="nc" id="L1941">						holder.icon.setImageResource(R.drawable.noposter);</span>
					} else {
<span class="nc" id="L1943">						holder.icon.setImageDrawable(icon);</span>
<span class="nc" id="L1944">						serie.setDIcon(icon);</span>
					}
				}
			}
<span class="fc" id="L1948">			return convertView;</span>
		}

<span class="fc" id="L1951">		private OnTouchListener iconTouchListener = new OnTouchListener() {</span>
			public boolean onTouch(View v, MotionEvent event) {
<span class="nc" id="L1953">				iconListPosition = listView.getPositionForView(v);</span>
<span class="nc" id="L1954">				iconGestureDetector.onTouchEvent(event);</span>
<span class="nc" id="L1955">				return true;</span>
			}
		};

<span class="fc" id="L1959">		private final SimpleOnGestureListener iconGestureListener = new SimpleOnGestureListener() {</span>
			@Override
			public boolean onSingleTapConfirmed(MotionEvent e) {
<span class="nc" id="L1962">				keyboard.hideSoftInputFromWindow(searchV.getWindowToken(), 0);</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">				if (!logMode)</span>
<span class="nc" id="L1964">					episodeDetails(iconListPosition);</span>
				else
<span class="nc" id="L1966">					serieSeasons(iconListPosition);</span>
<span class="nc" id="L1967">				return true;</span>
			}

			@Override
			public boolean onDoubleTap(MotionEvent e) {
<span class="nc" id="L1972">				keyboard.hideSoftInputFromWindow(searchV.getWindowToken(), 0);</span>
<span class="nc" id="L1973">				showDetails(seriesAdapter.getItem(iconListPosition).getSerieId());</span>
<span class="nc" id="L1974">				return true;</span>
			}

			@Override
			public void onLongPress(MotionEvent e) {
<span class="nc" id="L1979">				keyboard.hideSoftInputFromWindow(searchV.getWindowToken(), 0);</span>
<span class="nc" id="L1980">				String[] extResources = seriesAdapter.getItem(iconListPosition).getExtResources().trim().split(&quot;\\n&quot;);</span>
<span class="nc" id="L1981">				boolean foundResources = false;</span>
<span class="nc bnc" id="L1982" title="All 2 branches missed.">				for (int i = 0; i &lt; extResources.length; i++) {</span>
<span class="nc bnc" id="L1983" title="All 2 branches missed.">					if (extResources[i].startsWith(&quot;*&quot;)) {</span>
<span class="nc" id="L1984">						browseExtResource(extResources[i]);</span>
<span class="nc" id="L1985">						foundResources = true;</span>
					}
				}
<span class="nc bnc" id="L1988" title="All 2 branches missed.">				if (!foundResources)</span>
<span class="nc" id="L1989">					extResources(seriesAdapter.getItem(iconListPosition).getExtResources(), iconListPosition);</span>
<span class="nc" id="L1990">			}</span>
		};

<span class="fc" id="L1993">		private GestureDetector iconGestureDetector = new GestureDetector(getApplicationContext(), iconGestureListener);</span>
	}

<span class="fc" id="L1996">	static class ViewHolder</span>
	{
		TextView sn;
		TextView si;
		TextView sne;
		IconView icon;
		ImageView context;
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>Generated by the Android Gradle plugin 7.3.0</div></body></html>