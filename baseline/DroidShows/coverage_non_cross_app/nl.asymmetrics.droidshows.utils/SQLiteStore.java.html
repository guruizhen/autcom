<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLiteStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">nl.asymmetrics.droidshows.utils</a> &gt; <span class="el_source">SQLiteStore.java</span></div><h1>SQLiteStore.java</h1><pre class="source lang-java linenums">package nl.asymmetrics.droidshows.utils;

import java.io.File;
import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.List;

import nl.asymmetrics.droidshows.DroidShows;
import nl.asymmetrics.droidshows.thetvdb.model.Episode;
import nl.asymmetrics.droidshows.thetvdb.model.Serie;
import nl.asymmetrics.droidshows.thetvdb.model.TVShowItem;
import android.annotation.SuppressLint;
import android.content.Context;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import android.database.sqlite.SQLiteOpenHelper;
import android.os.Build;
import android.database.Cursor;
import android.database.DatabaseUtils;
import android.database.SQLException;
import android.text.TextUtils;
import android.util.Log;

public class SQLiteStore extends SQLiteOpenHelper
{
<span class="fc" id="L31">	public static final SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="fc" id="L32">	public static final SimpleDateFormat dateFormatSeen = new SimpleDateFormat(&quot;yyyyMMdd&quot;);</span>
	public static final String TAG = &quot;DroidShows&quot;;
<span class="fc" id="L34">	private static SQLiteStore instance = null;</span>
<span class="fc" id="L35">	private static String DB_PATH = &quot;&quot;;</span>
<span class="fc" id="L36">	private static String DB_NAME = &quot;DroidShows.db&quot;;</span>
	private SQLiteDatabase db;
<span class="fc" id="L38">	private static String today = dateFormat.format(Calendar.getInstance().getTime());	// Get today's date;</span>

	public static SQLiteStore getInstance(Context context) {
<span class="fc bfc" id="L41" title="All 2 branches covered.">		if (instance == null)</span>
<span class="fc" id="L42">			instance = new SQLiteStore(context.getApplicationContext());</span>
<span class="fc" id="L43">		return instance;</span>
	}
	
	private SQLiteStore(Context context) {
<span class="fc" id="L47">		super(context, DB_NAME, null, 1);</span>
<span class="fc" id="L48">		DB_PATH = context.getApplicationInfo().dataDir +&quot;/databases/&quot;;</span>
		try {
<span class="fc" id="L50">			openDataBase();</span>
<span class="nc" id="L51">		} catch (SQLException sqle) {</span>
			try {
<span class="nc" id="L53">				createDataBase();</span>
<span class="nc" id="L54">				close();</span>
				try {
<span class="nc" id="L56">					openDataBase();</span>
<span class="nc" id="L57">				} catch (SQLException sqle2) {</span>
<span class="nc" id="L58">					Log.e(TAG, sqle2.getMessage());</span>
<span class="nc" id="L59">				}</span>
<span class="nc" id="L60">			} catch (IOException e) {</span>
<span class="nc" id="L61">				Log.e(TAG, &quot;Unable to create database&quot;);</span>
<span class="nc" id="L62">			}</span>
<span class="fc" id="L63">		}</span>
<span class="fc" id="L64">	}</span>

	public void createDataBase() throws IOException {
<span class="nc" id="L67">		boolean dbExist = checkDataBase();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">		if (!dbExist) {</span>
<span class="nc" id="L69">			this.getWritableDatabase();</span>
		}
<span class="nc" id="L71">	}</span>

	private boolean checkDataBase() {
<span class="nc" id="L74">		SQLiteDatabase checkDB = null;</span>
		try {
<span class="nc" id="L76">			String myPath = DB_PATH + DB_NAME;</span>
<span class="nc" id="L77">			checkDB = SQLiteDatabase.openDatabase(myPath, null, SQLiteDatabase.OPEN_READONLY);</span>
<span class="nc" id="L78">		} catch (SQLiteException e) {</span>
<span class="nc" id="L79">			Log.d(TAG, &quot;Database does't exist yet.&quot;);</span>
<span class="nc" id="L80">		}</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">		if (checkDB != null) {</span>
<span class="nc" id="L82">			checkDB.close();</span>
		}
<span class="nc bnc" id="L84" title="All 2 branches missed.">		return checkDB != null ? true : false;</span>
	}

	@SuppressLint(&quot;NewApi&quot;)
	public void openDataBase() throws SQLException {
		// Open the database
<span class="fc" id="L90">		String myPath = DB_PATH + DB_NAME;</span>
<span class="fc" id="L91">		db = SQLiteDatabase.openDatabase(myPath, null, SQLiteDatabase.OPEN_READWRITE);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">		if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN)</span>
<span class="fc" id="L93">			db.disableWriteAheadLogging();</span>
<span class="fc" id="L94">	}</span>

	/* Insert Methods */
	public boolean execQuery(String query) {
		try {
<span class="fc" id="L99">			db.execSQL(query);</span>
<span class="nc" id="L100">		} catch (SQLiteException e) {</span>
<span class="nc" id="L101">			e.printStackTrace();</span>
<span class="nc" id="L102">			return false;</span>
<span class="fc" id="L103">		}</span>
<span class="fc" id="L104">		return true;</span>
	}

	public Cursor Query(String query) {
<span class="fc" id="L108">		Cursor c = null;</span>
		try {
<span class="fc" id="L110">			c = db.rawQuery(query, null);</span>
<span class="nc" id="L111">		} catch (SQLiteException e) {</span>
<span class="nc" id="L112">			return null;</span>
<span class="fc" id="L113">		}</span>
<span class="fc" id="L114">		return c;</span>
	}

	/* Get Methods */
	public TVShowItem createTVShowItem(String serieId) {
<span class="fc" id="L119">		String name = &quot;&quot;, language = &quot;&quot;, tmpPoster = &quot;&quot;, showStatus = &quot;&quot;, tmpNextEpisode = &quot;&quot;, nextEpisode = &quot;&quot;, tmpNextAir = &quot;&quot;, extResources = &quot;&quot;;</span>
<span class="fc" id="L120">		int tmpStatus = 0, seasonCount = 0, unwatched = 0, unwatchedAired = 0;</span>
<span class="fc" id="L121">		boolean dvdOrder = false;</span>
<span class="fc" id="L122">		Date nextAir = null;</span>
<span class="fc" id="L123">		Cursor c = Query(&quot;SELECT serieName, language, posterThumb, status, passiveStatus, seasonCount, unwatchedAired, unwatched, nextEpisode, nextAir, extResources, dvdOrder FROM series WHERE id = '&quot; + serieId + &quot;'&quot;);</span>
		try {
<span class="fc" id="L125">			c.moveToFirst();</span>
<span class="pc bpc" id="L126" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L127">				name = c.getString(c.getColumnIndex(&quot;serieName&quot;));</span>
<span class="fc" id="L128">				language = c.getString(c.getColumnIndex(&quot;language&quot;));</span>
<span class="fc" id="L129">				tmpPoster = c.getString(c.getColumnIndex(&quot;posterThumb&quot;));</span>
<span class="fc" id="L130">				showStatus = c.getString(c.getColumnIndex(&quot;status&quot;));</span>
<span class="fc" id="L131">				tmpStatus = c.getInt(c.getColumnIndex(&quot;passiveStatus&quot;));</span>
<span class="fc" id="L132">				seasonCount = c.getInt(c.getColumnIndex(&quot;seasonCount&quot;));</span>
<span class="fc" id="L133">				unwatchedAired = c.getInt(c.getColumnIndex(&quot;unwatchedAired&quot;));</span>
<span class="fc" id="L134">				unwatched = c.getInt(c.getColumnIndex(&quot;unwatched&quot;));</span>
<span class="fc" id="L135">				tmpNextEpisode = c.getString(c.getColumnIndex(&quot;nextEpisode&quot;));</span>
<span class="fc" id="L136">				tmpNextAir = c.getString(c.getColumnIndex(&quot;nextAir&quot;));</span>
<span class="fc" id="L137">				extResources = c.getString(c.getColumnIndex(&quot;extResources&quot;));</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">				dvdOrder = c.getInt(c.getColumnIndex(&quot;dvdOrder&quot;)) == 1;</span>
			}
<span class="nc" id="L140">		} catch (SQLiteException e) {</span>
<span class="nc" id="L141">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L142">		}</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if (!tmpNextEpisode.equals(&quot;-1&quot;))</span>
<span class="fc" id="L145">			nextEpisode = tmpNextEpisode;</span>
<span class="pc bpc" id="L146" title="2 of 4 branches missed.">		if (!tmpNextAir.isEmpty() &amp;&amp; !tmpNextAir.equals(&quot;null&quot;)) {</span>
			try {
<span class="fc" id="L148">				nextAir = SQLiteStore.dateFormat.parse(tmpNextAir);</span>
<span class="nc" id="L149">			} catch (ParseException e) {</span>
<span class="nc" id="L150">				e.printStackTrace();</span>
<span class="fc" id="L151">			}</span>
		}
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">		boolean status = (tmpStatus == 1);</span>
<span class="fc" id="L154">		TVShowItem tvsi = new TVShowItem(serieId, language, tmpPoster, null, name, seasonCount, nextEpisode, nextAir, unwatchedAired, unwatched, status, showStatus, extResources, dvdOrder);</span>
<span class="fc" id="L155">		return tvsi;</span>
	}

	
	public List&lt;Episode&gt; getEpisodes(String serieId) {
<span class="nc" id="L160">		List&lt;Episode&gt; episodes = null;</span>
<span class="nc" id="L161">		episodes = new ArrayList&lt;Episode&gt;();</span>
<span class="nc" id="L162">		Cursor c = Query(&quot;SELECT * FROM episodes WHERE serieId = '&quot;+ serieId +&quot;'&quot;);</span>
		try {
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if (c != null) {</span>
<span class="nc" id="L165">				int idCol = c.getColumnIndex(&quot;id&quot;);</span>
<span class="nc" id="L166">				int combinedEpisodeNumberCol = c.getColumnIndex(&quot;combinedEpisodeNumber&quot;);</span>
<span class="nc" id="L167">				int combinedSeasonCol = c.getColumnIndex(&quot;combinedSeason&quot;);</span>
<span class="nc" id="L168">				int dvdChapterCol = c.getColumnIndex(&quot;dvdChapter&quot;);</span>
<span class="nc" id="L169">				int dvdDiscIdCol = c.getColumnIndex(&quot;dvdDiscId&quot;);</span>
<span class="nc" id="L170">				int dvdEpisodeNumberCol = c.getColumnIndex(&quot;dvdEpisodeNumber&quot;);</span>
<span class="nc" id="L171">				int dvdSeasonCol = c.getColumnIndex(&quot;dvdSeason&quot;);</span>
<span class="nc" id="L172">				int epImgFlagCol = c.getColumnIndex(&quot;epImgFlag&quot;);</span>
<span class="nc" id="L173">				int episodeNameCol = c.getColumnIndex(&quot;episodeName&quot;);</span>
<span class="nc" id="L174">				int episodeNumberCol = c.getColumnIndex(&quot;episodeNumber&quot;);</span>
<span class="nc" id="L175">				int firstAiredCol = c.getColumnIndex(&quot;firstAired&quot;);</span>
<span class="nc" id="L176">				int imdbIdCol = c.getColumnIndex(&quot;imdbId&quot;);</span>
<span class="nc" id="L177">				int languageCol = c.getColumnIndex(&quot;language&quot;);</span>
<span class="nc" id="L178">				int overviewCol = c.getColumnIndex(&quot;overview&quot;);</span>
<span class="nc" id="L179">				int productionCodeCol = c.getColumnIndex(&quot;productionCode&quot;);</span>
<span class="nc" id="L180">				int ratingCol = c.getColumnIndex(&quot;rating&quot;);</span>
<span class="nc" id="L181">				int seasonNumberCol = c.getColumnIndex(&quot;seasonNumber&quot;);</span>
<span class="nc" id="L182">				int absoluteNumberCol = c.getColumnIndex(&quot;absoluteNumber&quot;);</span>
<span class="nc" id="L183">				int filenameCol = c.getColumnIndex(&quot;filename&quot;);</span>
<span class="nc" id="L184">				int lastUpdatedCol = c.getColumnIndex(&quot;lastUpdated&quot;);</span>
<span class="nc" id="L185">				int seriesIdCol = c.getColumnIndex(&quot;serieId&quot;);</span>
<span class="nc" id="L186">				int seasonIdCol = c.getColumnIndex(&quot;seasonId&quot;);</span>
<span class="nc" id="L187">				int seenCol = c.getColumnIndex(&quot;seen&quot;);</span>
<span class="nc" id="L188">				c.moveToFirst();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">				if (c.isFirst()) {</span>
					do {
<span class="nc" id="L191">						Episode eTmp = new Episode();</span>
<span class="nc" id="L192">						List&lt;String&gt; directors = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L193">						Cursor cdirectors = Query(&quot;SELECT director FROM directors WHERE serieId='&quot;+ serieId</span>
<span class="nc" id="L194">							+&quot;' AND episodeId='&quot;+ c.getString(idCol) +&quot;'&quot;);</span>
<span class="nc" id="L195">						cdirectors.moveToFirst();</span>
<span class="nc" id="L196">						int directorCol = cdirectors.getColumnIndex(&quot;director&quot;);</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">						if (cdirectors != null &amp;&amp; cdirectors.isFirst()) {</span>
							do {
<span class="nc" id="L199">								directors.add(cdirectors.getString(directorCol));</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">							} while (cdirectors.moveToNext());</span>
						}
<span class="nc" id="L202">						cdirectors.close();</span>
<span class="nc" id="L203">						List&lt;String&gt; guestStars = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L204">						Cursor cguestStars = Query(&quot;SELECT guestStar FROM guestStars WHERE serieId='&quot;+ serieId</span>
<span class="nc" id="L205">							+&quot;' AND episodeId='&quot;+ c.getString(idCol) +&quot;'&quot;);</span>
<span class="nc" id="L206">						cguestStars.moveToFirst();</span>
<span class="nc" id="L207">						int guestStarCol = cguestStars.getColumnIndex(&quot;guestStar&quot;);</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">						if (cguestStars != null &amp;&amp; cguestStars.isFirst()) {</span>
							do {
<span class="nc" id="L210">								guestStars.add(cguestStars.getString(guestStarCol));</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">							} while (cguestStars.moveToNext());</span>
						}
<span class="nc" id="L213">						cguestStars.close();</span>
<span class="nc" id="L214">						List&lt;String&gt; writers = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L215">						Cursor cwriters = Query(&quot;SELECT writer FROM writers WHERE serieId='&quot;+ serieId</span>
<span class="nc" id="L216">							+&quot;' AND episodeId='&quot;+ c.getString(idCol) +&quot;'&quot;);</span>
<span class="nc" id="L217">						cwriters.moveToFirst();</span>
<span class="nc" id="L218">						int writersCol = cwriters.getColumnIndex(&quot;writer&quot;);</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">						if (cwriters != null &amp;&amp; cwriters.isFirst()) {</span>
							do {
<span class="nc" id="L221">								writers.add(cwriters.getString(writersCol));</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">							} while (cwriters.moveToNext());</span>
						}
<span class="nc" id="L224">						cwriters.close();</span>
<span class="nc" id="L225">						eTmp.setDirectors(directors);</span>
<span class="nc" id="L226">						eTmp.setGuestStars(guestStars);</span>
<span class="nc" id="L227">						eTmp.setWriters(writers);</span>
<span class="nc" id="L228">						eTmp.setId(c.getString(idCol));</span>
<span class="nc" id="L229">						eTmp.setCombinedEpisodeNumber(c.getString(combinedEpisodeNumberCol));</span>
<span class="nc" id="L230">						eTmp.setCombinedSeason(c.getString(combinedSeasonCol));</span>
<span class="nc" id="L231">						eTmp.setDvdChapter(c.getString(dvdChapterCol));</span>
<span class="nc" id="L232">						eTmp.setDvdDiscId(c.getString(dvdDiscIdCol));</span>
<span class="nc" id="L233">						eTmp.setDvdEpisodeNumber(c.getString(dvdEpisodeNumberCol));</span>
<span class="nc" id="L234">						eTmp.setDvdSeason(c.getString(dvdSeasonCol));</span>
<span class="nc" id="L235">						eTmp.setEpImgFlag(c.getString(epImgFlagCol));</span>
<span class="nc" id="L236">						eTmp.setEpisodeName(c.getString(episodeNameCol));</span>
<span class="nc" id="L237">						eTmp.setEpisodeNumber(c.getInt(episodeNumberCol));</span>
<span class="nc" id="L238">						eTmp.setFirstAired(c.getString(firstAiredCol));</span>
<span class="nc" id="L239">						eTmp.setImdbId(c.getString(imdbIdCol));</span>
<span class="nc" id="L240">						eTmp.setLanguage(c.getString(languageCol));</span>
<span class="nc" id="L241">						eTmp.setOverview(c.getString(overviewCol));</span>
<span class="nc" id="L242">						eTmp.setProductionCode(c.getString(productionCodeCol));</span>
<span class="nc" id="L243">						eTmp.setRating(c.getString(ratingCol));</span>
<span class="nc" id="L244">						eTmp.setSeasonNumber(c.getInt(seasonNumberCol));</span>
<span class="nc" id="L245">						eTmp.setAbsoluteNumber(c.getString(absoluteNumberCol));</span>
<span class="nc" id="L246">						eTmp.setFilename(c.getString(filenameCol));</span>
<span class="nc" id="L247">						eTmp.setLastUpdated(c.getString(lastUpdatedCol));</span>
<span class="nc" id="L248">						eTmp.setSeriesId(c.getString(seriesIdCol));</span>
<span class="nc" id="L249">						eTmp.setSeasonId(c.getString(seasonIdCol));</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">						if (c.getInt(seenCol) == 0) {</span>
<span class="nc" id="L251">							eTmp.setSeen(false);</span>
						} else {
<span class="nc" id="L253">							eTmp.setSeen(true);</span>
						}
<span class="nc" id="L255">						episodes.add(eTmp);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">					} while (c.moveToNext());</span>
				}
			}
<span class="nc" id="L259">		} catch (SQLiteException e) {</span>
<span class="nc" id="L260">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L261">		}</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L263">		return episodes;</span>
	}

	public List&lt;String&gt; getSeries(int showArchive, boolean filterNetworks, List&lt;String&gt; showNetworks) {
<span class="fc" id="L267">		String networks = null;</span>
<span class="pc bpc" id="L268" title="5 of 6 branches missed.">		if (filterNetworks &amp;&amp; showNetworks != null &amp;&amp; !showNetworks.isEmpty()) {</span>
<span class="nc" id="L269">			networks = &quot;(&quot;;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">			for (String network : showNetworks) {</span>
<span class="nc" id="L271">				networks += &quot;'&quot;+ network +&quot;', &quot;;</span>
<span class="nc" id="L272">			}</span>
<span class="nc" id="L273">			networks = networks.substring(0, networks.length()-2) +&quot;)&quot;;</span>
<span class="nc" id="L274">			Log.d(TAG, &quot;showNetworksStr = &quot;+ networks);</span>
		}
<span class="fc" id="L276">		List&lt;String&gt; series = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">		String showArchiveString = (showArchive &lt; 2 ? &quot; WHERE (passiveStatus&quot;</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">			+ (showArchive == 0 ? &quot;=0 OR passiveStatus IS NULL)&quot; : &quot;&gt;=1)&quot;) : &quot;&quot;);	// Solves issue with former bug when adding show directly after restoring backup</span>
<span class="pc bpc" id="L279" title="3 of 4 branches missed.">		String showNetworksString = (networks != null ? (showArchiveString == null ? &quot; WHERE &quot; : &quot; AND &quot;)</span>
<span class="pc" id="L280">			+&quot;network IN &quot;+ networks : &quot;&quot;);</span>
//		Log.d(TAG, &quot;SELECT id FROM series&quot;+ showArchiveString + showNetworksString);
<span class="fc" id="L282">		Cursor cseries = Query(&quot;SELECT id FROM series&quot;+ showArchiveString + showNetworksString);</span>
		try {
<span class="fc" id="L284">			cseries.moveToFirst();</span>
<span class="pc bpc" id="L285" title="2 of 4 branches missed.">			if (cseries != null &amp;&amp; cseries.isFirst()) {</span>
				do {
<span class="nc" id="L287">					series.add(cseries.getString(0));</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">				} while (cseries.moveToNext());</span>
			}
<span class="fc" id="L290">			cseries.close();</span>
<span class="nc" id="L291">		} catch (SQLiteException e) {</span>
<span class="nc" id="L292">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L293">			cseries.close();</span>
<span class="fc" id="L294">		}</span>
<span class="fc" id="L295">		return series;</span>
	}
	
	public List&lt;String&gt; getNetworks() {
<span class="nc" id="L299">		List&lt;String&gt; networks = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L300">		Cursor c = Query(&quot;SELECT DISTINCT network FROM series&quot;);</span>
		try {
<span class="nc" id="L302">			c.moveToFirst();</span>
<span class="nc bnc" id="L303" title="All 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
				do {
<span class="nc" id="L305">					networks.add(c.getString(0));</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">				} while (c.moveToNext());</span>
			}
<span class="nc" id="L308">		} catch (SQLiteException e) {</span>
<span class="nc" id="L309">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L310">		}</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L312">		Collections.sort(networks, String.CASE_INSENSITIVE_ORDER);</span>
<span class="nc" id="L313">		return networks;</span>
	}

	public List&lt;TVShowItem&gt; getLog() {
<span class="nc" id="L317">		return getLog(0);</span>
	}

	public List&lt;TVShowItem&gt; getLog(int offset) {
<span class="nc" id="L321">		List&lt;TVShowItem&gt; episodes = new ArrayList&lt;TVShowItem&gt;();</span>
<span class="nc" id="L322">		String serieId = &quot;&quot;, episodeId = &quot;&quot;, episodeName = &quot;&quot;;</span>
		long seen;
<span class="nc" id="L324">		int seasonNumber = -1, episodeNumber = -1;</span>
<span class="nc" id="L325">		Cursor c = Query(&quot;SELECT serieId, id, seasonNumber, episodeNumber, dvdSeason, dvdEpisodeNumber, episodeName, seen&quot;</span>
								+&quot; FROM episodes WHERE seen&gt;1 ORDER BY seen DESC, serieId DESC, episodeNumber&quot;
								+&quot; DESC LIMIT 25 OFFSET &quot;+ offset);
<span class="nc" id="L328">		c.moveToFirst();</span>
<span class="nc bnc" id="L329" title="All 4 branches missed.">		if (c != null &amp;&amp; c.isFirst()) {</span>
			do {
<span class="nc" id="L331">				serieId = c.getString(c.getColumnIndex(&quot;serieId&quot;));</span>
<span class="nc" id="L332">				episodeId = c.getString(c.getColumnIndex(&quot;id&quot;));</span>
<span class="nc" id="L333">				seen = c.getInt(c.getColumnIndex(&quot;seen&quot;));</span>
				
<span class="nc" id="L335">				Cursor o = Query(&quot;SELECT dvdOrder FROM series WHERE id = '&quot; + serieId +&quot;'&quot;);</span>
<span class="nc bnc" id="L336" title="All 6 branches missed.">				if (o != null &amp;&amp; o.isFirst() &amp;&amp; o.getInt(0) == 1) {</span>
<span class="nc" id="L337">					seasonNumber = c.getInt(c.getColumnIndex(&quot;dvdSeason&quot;));</span>
<span class="nc" id="L338">					episodeNumber = c.getInt(c.getColumnIndex(&quot;dvdEpisodeNumber&quot;));</span>
				} else {
<span class="nc" id="L340">					episodeNumber = c.getInt(c.getColumnIndex(&quot;episodeNumber&quot;));</span>
<span class="nc" id="L341">					episodeName = c.getString(c.getColumnIndex(&quot;episodeName&quot;));</span>
				}
				
<span class="nc" id="L344">				TVShowItem episode = createTVShowItem(serieId);</span>

<span class="nc" id="L346">				episode.setEpisodeId(episodeId);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">				episode.setEpisodeName(seasonNumber + (episodeNumber &lt; 10 ? &quot;x0&quot; : &quot;x&quot;) + episodeNumber +&quot; &quot;+ episodeName);</span>
<span class="nc" id="L348">				Date epSeen = new Date(seen * 1000);</span>
<span class="nc" id="L349">				episode.setEpisodeSeen(SimpleDateFormat.getDateTimeInstance().format(epSeen));</span>
				
<span class="nc" id="L351">				episodes.add(episode);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">			} while (c.moveToNext());</span>
		}
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L355">		return episodes;</span>
	}

	public EpisodeRow getEpisodeRow(String serieId, int seasonNumber, String episodeId, boolean dvdOrder) {
<span class="fc" id="L359">		return getEpisodeRows(serieId, seasonNumber, episodeId, dvdOrder).get(0);</span>
	}

	public List&lt;EpisodeRow&gt; getEpisodeRows(String serieId, int seasonNumber, boolean dvdOrder) {
<span class="fc" id="L363">		return getEpisodeRows(serieId, seasonNumber, &quot;&quot;, dvdOrder);</span>
	}
	
	private List&lt;EpisodeRow&gt; getEpisodeRows(String serieId, int seasonNumber, String episodeId, boolean dvdOrder) {
<span class="fc" id="L367">		List&lt;EpisodeRow&gt; episodes = new ArrayList&lt;EpisodeRow&gt;();</span>
<span class="fc" id="L368">		Cursor c = Query(&quot;SELECT id, episodeName, episodeNumber, dvdEpisodeNumber, seen, firstAired FROM episodes WHERE &quot;</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">			+ (episodeId.isEmpty() ? &quot;&quot; : &quot;id=&quot;+ episodeId +&quot; AND &quot;)</span>
			+ &quot;serieId='&quot;+ serieId +&quot;' AND &quot;
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">			+ (dvdOrder ? &quot;dvdSeason=&quot; : &quot;seasonNumber=&quot;) + seasonNumber</span>
			+&quot; ORDER BY episodeNumber ASC&quot;);
		try {
<span class="fc" id="L374">			c.moveToFirst();</span>
<span class="pc bpc" id="L375" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
				do {
<span class="fc" id="L377">					String id = c.getString(c.getColumnIndex(&quot;id&quot;));</span>
<span class="fc" id="L378">					String name = c.getInt(c.getColumnIndex(&quot;episodeNumber&quot;)) +&quot;. &quot;</span>
<span class="fc" id="L379">							+ c.getString(c.getColumnIndex(&quot;episodeName&quot;));</span>
<span class="fc" id="L380">					String aired = c.getString(c.getColumnIndex(&quot;firstAired&quot;));</span>
<span class="fc" id="L381">					Date airedDate = null;</span>
<span class="pc bpc" id="L382" title="2 of 4 branches missed.">					if (!aired.isEmpty() &amp;&amp; !aired.equals(&quot;null&quot;)) {</span>
							try { 
<span class="fc" id="L384">								airedDate = dateFormat.parse(aired);</span>
<span class="fc" id="L385">								aired = SimpleDateFormat.getDateInstance().format(airedDate);</span>
<span class="pc" id="L386">							} catch (ParseException e) { e.printStackTrace(); }</span>
					} else
<span class="nc" id="L388">						aired = &quot;&quot;;</span>
<span class="fc" id="L389">					long seen = c.getInt(c.getColumnIndex(&quot;seen&quot;));</span>
					
<span class="fc" id="L391">					episodes.add(new EpisodeRow(id, name, aired, airedDate, seen));</span>
<span class="fc bfc" id="L392" title="All 2 branches covered.">				} while (c.moveToNext());</span>
			}
<span class="nc" id="L394">		} catch (SQLiteException e) {</span>
<span class="nc" id="L395">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L396">		}</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L398">		return episodes;</span>
	}

	private List&lt;EpisodeSeen&gt; getSeen(String serieId, int max_season, boolean dvdOrder) {
<span class="nc" id="L402">		List&lt;EpisodeSeen&gt; episodesSeen = new ArrayList&lt;EpisodeSeen&gt;();</span>
<span class="nc" id="L403">		Cursor c = Query(&quot;SELECT seasonNumber, episodeNumber, dvdSeason, dvdEpisodeNumber, seen FROM episodes WHERE serieId='&quot;+ serieId +&quot;'&quot;</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">			+ (max_season != -1 ? &quot; AND (seasonNumber=&quot;+ max_season +&quot; OR seasonNumber=0)&quot;: &quot;&quot;)</span>
			+&quot; AND seen&gt;0&quot;);
		try {
<span class="nc" id="L407">			c.moveToFirst();</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
				do {
<span class="nc bnc" id="L410" title="All 2 branches missed.">					int  season = c.getInt(dvdOrder ? 2 : 0),</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">						episode = c.getInt(dvdOrder ? 3 : 1);</span>
<span class="nc" id="L412">					episodesSeen.add(new EpisodeSeen(season +&quot;x&quot;+ episode, c.getInt(4)));</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">				} while (c.moveToNext());</span>
			}
<span class="nc" id="L415">		} catch (SQLiteException e) {</span>
<span class="nc" id="L416">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L417">		}</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L419">		return episodesSeen;</span>
	}

	public boolean convertSeenTimestamps() {
<span class="nc" id="L423">		boolean result = true;</span>
<span class="nc" id="L424">		int converted = 0;</span>
<span class="nc" id="L425">		List&lt;EpisodeSeen&gt; episodesSeen = new ArrayList&lt;EpisodeSeen&gt;();</span>
<span class="nc" id="L426">		Cursor c = Query(&quot;SELECT id, seen FROM episodes WHERE seen&gt;1&quot;);</span>
		try {
<span class="nc" id="L428">			db.beginTransaction();</span>
<span class="nc" id="L429">			c.moveToFirst();</span>
<span class="nc bnc" id="L430" title="All 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
				do {
<span class="nc" id="L432">					episodesSeen.add(new EpisodeSeen(c.getString(0), c.getInt(1)));</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">				} while (c.moveToNext());</span>
			}
			Date seenTimestamp;
<span class="nc bnc" id="L436" title="All 2 branches missed.">			for (EpisodeSeen ep : episodesSeen) {</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">				if (ep.seen &gt; 1) {</span>
					try {
<span class="nc" id="L439">						seenTimestamp = SQLiteStore.dateFormatSeen.parse(&quot;&quot;+ ep.seen);</span>
<span class="nc" id="L440">						long seen = seenTimestamp.getTime() / 1000;</span>
//						Log.d(TAG, &quot;Converting seen from\n&quot;+ ep.seen +&quot; to\n&quot;+ SQLiteStore.dateFormatSeen.format(new Date(seen * 1000))  +&quot;(db-value =&quot;+ seen +&quot;)&quot;);
<span class="nc" id="L442">						execQuery(&quot;UPDATE episodes SET seen =&quot;+ seen +&quot; WHERE id='&quot;+ ep.episode +&quot;'&quot;);</span>
<span class="nc" id="L443">						converted++;</span>
<span class="nc" id="L444">					} catch (ParseException e) {</span>
<span class="nc" id="L445">						e.printStackTrace();</span>
<span class="nc" id="L446">						return false;</span>
<span class="nc" id="L447">					}</span>
				}
<span class="nc" id="L449">			}</span>
<span class="nc" id="L450">			db.setTransactionSuccessful();</span>
<span class="nc" id="L451">			Log.d(TAG, &quot;Converted seen dates (done) = &quot;+ converted);</span>
<span class="nc" id="L452">		} catch (SQLiteException e) {</span>
<span class="nc" id="L453">			Log.d(TAG, &quot;Converted seen dates (error!) = &quot;+ converted);</span>
<span class="nc" id="L454">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L455">			result = false;</span>
		} finally {
<span class="nc" id="L457">			db.endTransaction();</span>
		}
<span class="nc bnc" id="L459" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L460">		return result;</span>
	}

	public String getSerieIMDbId(String serieId) {
<span class="nc" id="L464">		String imdbId = &quot;&quot;;</span>
<span class="nc" id="L465">		Cursor c = Query(&quot;SELECT imdbId, serieName FROM series WHERE id = '&quot; + serieId + &quot;'&quot;);</span>
		try {
<span class="nc" id="L467">			c.moveToFirst();</span>
<span class="nc bnc" id="L468" title="All 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="nc" id="L469">				imdbId = c.getString(0);</span>
			}
<span class="nc" id="L471">		} catch (SQLiteException e) {</span>
<span class="nc" id="L472">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L473">			imdbId = null;</span>
<span class="nc" id="L474">		}</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L476">		return imdbId;</span>
	}

	public String getSerieName(String serieId) {
<span class="fc" id="L480">		String sname = &quot;&quot;;</span>
<span class="fc" id="L481">		Cursor c = Query(&quot;SELECT serieName FROM series WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
		try {
<span class="fc" id="L483">			c.moveToFirst();</span>
<span class="pc bpc" id="L484" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L485">				sname = c.getString(0);</span>
			}
<span class="nc" id="L487">		} catch (SQLiteException e) {</span>
<span class="nc" id="L488">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L489">			sname = null;</span>
<span class="fc" id="L490">		}</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L492">		return sname;</span>
	}
	
	public int getEpsWatched(String serieId) {
<span class="nc" id="L496">		int watched = 0;</span>
<span class="nc" id="L497">		Cursor c = Query(&quot;SELECT count(*) FROM episodes WHERE serieId='&quot;+ serieId</span>
			+&quot;' AND seen&gt;0&quot;
<span class="nc bnc" id="L499" title="All 2 branches missed.">			+ (DroidShows.includeSpecialsOption ? &quot;&quot; : &quot; AND seasonNumber &lt;&gt; 0&quot;));</span>
		try {
<span class="nc" id="L501">			c.moveToFirst();</span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="nc" id="L503">				watched = c.getInt(0);</span>
			}
<span class="nc" id="L505">		} catch (SQLiteException e) {</span>
<span class="nc" id="L506">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L507">		}</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">		if (c != null) c.close();</span>
//		Log.d(TAG, &quot;serie=&quot;+serieId+&quot; getEpsWatched=&quot;+ watched);
<span class="nc" id="L510">		return watched;</span>
	}

	public int getEpsUnwatchedAired(String serieId, boolean dvdOrder) {
<span class="fc" id="L514">		int unwatchedAired = 0;</span>
<span class="fc" id="L515">		Cursor c = Query(&quot;SELECT COUNT(*) FROM episodes WHERE serieId='&quot;+ serieId</span>
			+&quot;' AND seen=0 AND firstAired &lt; '&quot;+ today +&quot;' AND firstAired &lt;&gt; ''&quot;
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">			+ (DroidShows.includeSpecialsOption ? &quot;&quot; : &quot; AND &quot;</span>
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">			+ (dvdOrder ? &quot;dvdSeason&quot; : &quot;seasonNumber&quot;) +&quot; &lt;&gt; 0&quot;));</span>
		try {
<span class="fc" id="L520">			c.moveToFirst();</span>
<span class="pc bpc" id="L521" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L522">				unwatchedAired = c.getInt(0);</span>
			}
<span class="nc" id="L524">		} catch (SQLiteException e) {</span>
<span class="nc" id="L525">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L526">		}</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
//		Log.d(TAG, &quot;serie=&quot;+serieId+&quot; getEpsUnwatchedAired&quot;+&quot; today=&quot;+today+&quot; | unwatchedAired=&quot;+unwatchedAired);
<span class="fc" id="L529">		return unwatchedAired;</span>
	}

	public int getEpsUnwatchedAired(String serieId, int snumber, boolean dvdOrder) {
<span class="fc" id="L533">		int unwatched = -1;</span>
<span class="fc" id="L534">		Cursor c = Query(&quot;SELECT count(*) FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND &quot;</span>
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">				+ (dvdOrder ? &quot;dvdSeason=&quot; : &quot;seasonNumber=&quot;) + snumber</span>
				+&quot; AND seen=0 AND firstAired &lt; '&quot;+ today +&quot;' AND firstAired &lt;&gt; ''&quot;);
		try {
<span class="fc" id="L538">			c.moveToFirst();</span>
<span class="pc bpc" id="L539" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L540">				unwatched = c.getInt(0);</span>
			}
<span class="nc" id="L542">		} catch (SQLiteException e) {</span>
<span class="nc" id="L543">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L544">		}</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
//		Log.d(TAG, &quot;serie=&quot;+serieId+&quot; getSeasonEpsUnwatchedAired&quot;+&quot; today=&quot;+today+&quot; | season =&quot;+snumber+&quot; | unwatchedAired=&quot;+unwatched);
<span class="fc" id="L547">		return unwatched;</span>
	}

	public int getEpsUnwatched(String serieId, boolean dvdOrder) {
<span class="fc" id="L551">		int unwatched = -1;</span>
<span class="fc" id="L552">		Cursor c = Query(&quot;SELECT count(*) FROM episodes WHERE serieId='&quot;+ serieId</span>
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">			+&quot;' AND seen=0 &quot;+ (DroidShows.includeSpecialsOption ? &quot;&quot; : &quot; AND &quot;</span>
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">			+ (dvdOrder ? &quot;dvdSeason&quot;: &quot;seasonNumber&quot;) +&quot; &lt;&gt; 0&quot;));</span>
		try {
<span class="fc" id="L556">			c.moveToFirst();</span>
<span class="pc bpc" id="L557" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L558">				unwatched = c.getInt(0);</span>
			}
<span class="nc" id="L560">		} catch (SQLiteException e) {</span>
<span class="nc" id="L561">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L562">		}</span>
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L564">		return unwatched;</span>
	}

	public int getEpsUnwatched(String serieId, int snumber, boolean dvdOrder) {
<span class="fc" id="L568">		int unwatched = 0;</span>
<span class="fc" id="L569">		Cursor c = Query(&quot;SELECT count(*) FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND &quot;</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">			+ (dvdOrder ? &quot;dvdSeason=&quot; : &quot;seasonNumber=&quot;) + snumber +&quot; AND seen=0&quot;);</span>
		try {
<span class="fc" id="L572">			c.moveToFirst();</span>
<span class="pc bpc" id="L573" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L574">				unwatched = c.getInt(0);</span>
			}
<span class="nc" id="L576">		} catch (SQLiteException e) {</span>
<span class="nc" id="L577">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L578">		}</span>
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L580">		return unwatched;</span>
	}

	public String getNextEpisodeId(String serieId, boolean dvdOrder) {
<span class="nc" id="L584">		return getNextEpisodeId(serieId, false, dvdOrder);</span>
	}

	public String getNextEpisodeId(String serieId, boolean noFutureEp, boolean dvdOrder) {
<span class="nc bnc" id="L588" title="All 2 branches missed.">		int[] lastWatched = (DroidShows.markFromLastWatched ? getLastWatchedEpisode(serieId, dvdOrder) : null);</span>
<span class="nc" id="L589">		int id = -1;</span>
<span class="nc" id="L590">		Cursor c = null;</span>
		try {
<span class="nc" id="L592">				c = Query(&quot;SELECT id, seasonNumber, episodeNumber FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND seen=0&quot;</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">						+ (lastWatched != null ? &quot; AND &quot;</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">						+ (dvdOrder ? &quot;dvdSeason&quot; : &quot;seasonNumber&quot;) +&quot; &gt;= &quot;+ lastWatched[0] +&quot; AND &quot;</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">						+ (dvdOrder ? &quot;dvdEpisodeNumber&quot; : &quot;episodeNumber&quot;) +&quot; &gt; &quot;+ lastWatched[1] : &quot;&quot;)</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">						+ (DroidShows.includeSpecialsOption ? &quot;&quot; : &quot; AND seasonNumber &lt;&gt; 0&quot;)</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">						+ (noFutureEp ? &quot; AND firstAired &lt;= '&quot;+ today +&quot;' AND firstAired &lt;&gt; ''&quot; : &quot;&quot;)</span>
						+&quot; ORDER BY seasonNumber, episodeNumber ASC LIMIT 1&quot;);
<span class="nc" id="L599">			c.moveToFirst();</span>
<span class="nc bnc" id="L600" title="All 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="nc" id="L601">				int index = c.getColumnIndex(&quot;id&quot;);</span>
<span class="nc" id="L602">				id = c.getInt(index);</span>
			}
<span class="nc" id="L604">		} catch (SQLiteException e) {</span>
<span class="nc" id="L605">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L606">		}</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">		if (c != null) c.close();</span>
<span class="nc" id="L608">		return &quot;&quot;+ id;</span>
	}

	private int[] getLastWatchedEpisode(String serieId, boolean dvdOrder) {
<span class="nc" id="L612">		int[] lastSeen = new int[2];</span>
<span class="nc" id="L613">		Cursor c = Query(&quot;SELECT seasonNumber, episodeNumber FROM episodes WHERE serieId='&quot;+ serieId</span>
				+&quot;' AND seen&gt;=1 ORDER BY seen DESC, &quot;
<span class="nc bnc" id="L615" title="All 2 branches missed.">				+ (dvdOrder ? &quot;dvdSeason&quot; : &quot;seasonNumber&quot;) +&quot; DESC, &quot;</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">				+ (dvdOrder ? &quot;dvdEpisodeNumber&quot; : &quot;episodeNumber&quot;) +&quot; DESC LIMIT 1&quot;);</span>
			try {
<span class="nc" id="L618">				c.moveToFirst();</span>
<span class="nc bnc" id="L619" title="All 4 branches missed.">				if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="nc" id="L620">					lastSeen[0] = c.getInt(0);</span>
<span class="nc" id="L621">					lastSeen[1] = c.getInt(1);</span>
<span class="nc" id="L622">				} else lastSeen = null;</span>
<span class="nc" id="L623">			} catch (SQLiteException e) {</span>
<span class="nc" id="L624">				lastSeen = null;</span>
<span class="nc" id="L625">				Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L626">			}</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">			if (c != null) c.close();</span>
<span class="nc" id="L628">			return lastSeen;</span>
	}

	public NextEpisode getNextEpisode(String serieId, boolean dvdOrder) {
<span class="fc" id="L632">		return getNextEpisode(serieId, -1, false, dvdOrder);</span>
	}
		
	public NextEpisode getNextEpisode(String serieId, boolean showNextAiring, boolean dvdOrder) {
<span class="nc" id="L636">		return getNextEpisode(serieId, -1, showNextAiring, dvdOrder);</span>
	}

	public NextEpisode getNextEpisode(String serieId, int snumber, boolean dvdOrder) {
<span class="fc" id="L640">		return getNextEpisode(serieId, snumber, false, dvdOrder);</span>
	}

	private NextEpisode getNextEpisode(String serieId, int snumber, boolean showNextAiring, boolean dvdOrder) {
<span class="pc bpc" id="L644" title="2 of 4 branches missed.">		int[] lastWatched = (!showNextAiring &amp;&amp; DroidShows.markFromLastWatched ? getLastWatchedEpisode(serieId, dvdOrder) : null);</span>
<span class="fc" id="L645">		NextEpisode nextEpisode = null;</span>
<span class="fc" id="L646">		Cursor c = null;</span>
		try {
<span class="fc bfc" id="L648" title="All 2 branches covered.">			if (snumber == -1) {</span>
<span class="fc" id="L649">				c = Query(&quot;SELECT seasonNumber, episodeNumber, firstAired FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND seen=0&quot;</span>
<span class="pc bpc" id="L650" title="1 of 2 branches missed.">					+ (lastWatched != null ? &quot; AND &quot;</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">					+ (dvdOrder ? &quot;dvdSeason&quot; : &quot;seasonNumber&quot;) +&quot; &gt;= &quot;+ lastWatched[0] +&quot; AND &quot;</span>
<span class="pc bnc" id="L652" title="All 2 branches missed.">					+ (dvdOrder ? &quot;dvdEpisodeNumber&quot; : &quot;episodeNumber&quot;) +&quot; &gt; &quot;+ lastWatched[1] : &quot;&quot;)</span>
<span class="pc bpc" id="L653" title="1 of 2 branches missed.">					+ (DroidShows.includeSpecialsOption ? &quot;&quot; : &quot; AND seasonNumber &lt;&gt; 0&quot;)</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">					+ (showNextAiring ? &quot; AND firstAired &gt;= '&quot;+ today +&quot;'&quot; : &quot;&quot;)</span>
					+&quot; ORDER BY seasonNumber, episodeNumber ASC LIMIT 1&quot;);
			} else {
<span class="fc" id="L657">				c = Query(&quot;SELECT seasonNumber, episodeNumber, firstAired FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND &quot;</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">					+ (dvdOrder ? &quot;dvdSeason=&quot; : &quot;seasonNumber=&quot;) + snumber +&quot; AND seen=0 ORDER BY &quot;</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">					+ (dvdOrder ? &quot;dvdEpisodeNumber&quot; : &quot;episodeNumber&quot;) +&quot; ASC LIMIT 1&quot;);</span>
			}
<span class="fc" id="L661">			c.moveToFirst();</span>
<span class="pc bpc" id="L662" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst())</span>
<span class="fc" id="L663">				nextEpisode = new NextEpisode(serieId, c.getInt(0), c.getInt(1), c.getString(2));</span>
<span class="nc" id="L664">		} catch (SQLiteException e) {</span>
<span class="nc" id="L665">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L666">		}</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="pc bpc" id="L668" title="5 of 6 branches missed.">		if (showNextAiring &amp;&amp; (nextEpisode == null || nextEpisode.firstAired.equals(&quot;null&quot;)))</span>
<span class="nc" id="L669">			return null;</span>
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">		if (nextEpisode == null)</span>
<span class="nc" id="L671">			return new NextEpisode(serieId, -1, -1, &quot;&quot;);</span>
<span class="fc" id="L672">		return nextEpisode;</span>
	}
	
	public String getNextEpisodeString(NextEpisode nextEpisode) {
<span class="fc" id="L676">		return getNextEpisodeString(nextEpisode, false);</span>
	}

	public String getNextEpisodeString(NextEpisode nextEpisode, boolean showNextAiring) {
<span class="pc bpc" id="L680" title="1 of 2 branches missed.">		if (nextEpisode.episode == -1)</span>
<span class="nc" id="L681">			return &quot;&quot;;</span>
		
<span class="fc" id="L683">		String nextEpisodeString = nextEpisode.season</span>
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">			+ (nextEpisode.episode &lt; 10 ? &quot;x0&quot; : &quot;x&quot;) + nextEpisode.episode;</span>

<span class="pc bpc" id="L686" title="1 of 2 branches missed.">		if (showNextAiring) {</span>
<span class="nc" id="L687">			NextEpisode nextEpisodeAiring = getNextEpisode(nextEpisode.serieId, true);</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">			if (nextEpisodeAiring != null)</span>
<span class="nc" id="L689">				return nextEpisodeString + &quot; | [na] &quot;+ nextEpisodeAiring.season</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">					+ (nextEpisodeAiring.episode &lt; 10 ? &quot;x0&quot; : &quot;x&quot;) + nextEpisodeAiring.episode</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">					+ (nextEpisode.firstAiredDate != null ? &quot; [on] &quot;</span>
<span class="nc" id="L692">						+ SimpleDateFormat.getDateInstance().format(nextEpisodeAiring.firstAiredDate) : &quot;&quot;);</span>
		} 
		
<span class="fc" id="L695">		return &quot;[ne] &quot;+ nextEpisodeString</span>
<span class="pc bpc" id="L696" title="1 of 2 branches missed.">				+ (nextEpisode.firstAiredDate != null ? &quot; [on] &quot;</span>
<span class="pc" id="L697">					+ SimpleDateFormat.getDateInstance().format(nextEpisode.firstAiredDate) : &quot;&quot;);</span>
	}

	public int getSeasonCount(String serieId) {
<span class="fc" id="L701">		int count = 0;</span>
<span class="fc" id="L702">		Cursor c = Query(&quot;SELECT count(season) FROM serie_seasons WHERE serieId = '&quot;+ serieId +&quot;' AND season &lt;&gt; 0&quot;);</span>
		try {
<span class="fc" id="L704">			c.moveToFirst();</span>
<span class="pc bpc" id="L705" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L706">				count = c.getInt(0);</span>
			}
<span class="nc" id="L708">		} catch (SQLiteException e) {</span>
<span class="nc" id="L709">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L710">		}</span>
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L712">		return count;</span>
	}

	public int getSeasonEpisodeCount(String serieId, int sNumber, boolean dvdOrder) {
<span class="fc" id="L716">		int count = -1;</span>
<span class="fc" id="L717">		Cursor c = Query(&quot;SELECT count(*) FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND &quot;</span>
<span class="pc bpc" id="L718" title="1 of 2 branches missed.">			+ (dvdOrder ? &quot;dvdSeason=&quot; : &quot;seasonNumber=&quot;) + sNumber);</span>
		try {
<span class="fc" id="L720">			c.moveToFirst();</span>
<span class="pc bpc" id="L721" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L722">				count = c.getInt(0);</span>
			}
<span class="nc" id="L724">		} catch (SQLiteException e) {</span>
<span class="nc" id="L725">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L726">		}</span>
<span class="pc bpc" id="L727" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L728">		return count;</span>
	}
	
	/* Update Methods */
	public void updateUnwatchedSeason(String serieId, int nseason) {
		try {
<span class="nc" id="L734">			long seen = System.currentTimeMillis() / 1000;</span>
<span class="nc" id="L735">			db.execSQL(&quot;UPDATE episodes SET seen=&quot;+ seen +&quot; WHERE serieId='&quot;+ serieId +&quot;' AND seasonNumber=&quot;+ nseason</span>
			+&quot; AND firstAired &lt; '&quot;+ today +&quot;' AND firstAired &lt;&gt; '' AND seen &lt; 1&quot;);
<span class="nc" id="L737">		} catch (SQLiteException e) {</span>
<span class="nc" id="L738">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L739">		}</span>
<span class="nc" id="L740">		updateShowStats(serieId);</span>
<span class="nc" id="L741">	}</span>

	public void updateWatchedSeason(String serieId, int nseason) {
		try {
<span class="nc" id="L745">			db.execSQL(&quot;UPDATE episodes SET seen=0 WHERE serieId='&quot;+ serieId +&quot;' AND seasonNumber=&quot;</span>
				+ nseason);
<span class="nc" id="L747">		} catch (SQLiteException e) {</span>
<span class="nc" id="L748">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L749">		}</span>
<span class="nc" id="L750">		updateShowStats(serieId);</span>
<span class="nc" id="L751">	}</span>

	public String updateUnwatchedEpisode(String serieId, String episodeId) {
<span class="nc" id="L754">		return updateUnwatchedEpisode(serieId, episodeId, -1);</span>
	}

	public String updateUnwatchedEpisode(String serieId, String episodeId, long newSeen) {
<span class="fc" id="L758">		boolean dvdOrder = false;</span>
<span class="fc" id="L759">		Cursor c = Query(&quot;SELECT dvdOrder FROM series WHERE serieID=&quot;+ serieId);</span>
		try {
<span class="fc" id="L761">			c.moveToFirst();</span>
<span class="pc bpc" id="L762" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst())</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">				dvdOrder = c.getInt(0) == 1;</span>
<span class="nc" id="L764">		} catch (SQLiteException e) {</span>
<span class="nc" id="L765">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L766">		}</span>

<span class="fc" id="L768">		c = null;</span>
<span class="fc" id="L769">		String episodeMarked = &quot;&quot;;</span>
		try {
<span class="fc" id="L771">			c = Query(&quot;SELECT seen, seasonNumber, episodeNumber, dvdSeason, dvdEpisodeNumber FROM episodes WHERE serieId='&quot;+ serieId+&quot;' AND id='&quot;+ episodeId +&quot;'&quot;);</span>
<span class="fc" id="L772">			c.moveToFirst();</span>
<span class="pc bpc" id="L773" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L774">				long seen = c.getInt(0);</span>
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">				int season = dvdOrder ? c.getInt(3) : c.getInt(1);</span>
<span class="pc bpc" id="L776" title="1 of 2 branches missed.">				int episode = dvdOrder ? c.getInt(4) : c.getInt(2);</span>
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">				episodeMarked =  season + (episode &lt; 10 ? &quot;x0&quot; : &quot;x&quot;) + episode;</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">				if (newSeen &gt; -1) {</span>
<span class="fc" id="L779">					seen = newSeen;</span>
				} else {
<span class="nc bnc" id="L781" title="All 2 branches missed.">					if (seen &gt; 0)</span>
<span class="nc" id="L782">						seen = 0;</span>
					else
<span class="nc" id="L784">						seen = System.currentTimeMillis() / 1000;</span>
				}
<span class="fc" id="L786">				db.execSQL(&quot;UPDATE episodes SET seen=&quot;+ seen +&quot; WHERE serieId='&quot;+ serieId +&quot;' AND id='&quot;+ episodeId +&quot;'&quot;);</span>
			}
<span class="nc" id="L788">		} catch (SQLiteException e) {</span>
<span class="nc" id="L789">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L790">		}</span>
<span class="pc bpc" id="L791" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L792">		updateShowStats(serieId);</span>
<span class="fc" id="L793">		return episodeMarked;</span>
	}

	public void updateSerieStatus(String serieId, int passiveStatus) {
		try {
<span class="nc" id="L798">			db.execSQL(&quot;UPDATE series SET passiveStatus=&quot;+ passiveStatus +&quot; WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
<span class="nc" id="L799">		} catch (SQLiteException e) {</span>
<span class="nc" id="L800">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L801">		}</span>
<span class="nc" id="L802">	}</span>
	
	public void updateExtResources(String serieId, String extResources) {
		try {
<span class="nc" id="L806">			db.execSQL(&quot;UPDATE series SET extResources='&quot;+ extResources +&quot;' WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
<span class="nc" id="L807">		} catch (SQLiteException e) {</span>
<span class="nc" id="L808">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L809">		}</span>
<span class="nc" id="L810">	}</span>
	
	public void setDvdOrder(String serieId, boolean dvdOrder) {
		try {
<span class="nc bnc" id="L814" title="All 2 branches missed.">			db.execSQL(&quot;UPDATE series SET dvdOrder=&quot;+ (dvdOrder ? 1 : 0) +&quot; WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
<span class="nc" id="L815">			updateShowStats(serieId);</span>
<span class="nc" id="L816">		} catch (SQLiteException e) {</span>
<span class="nc" id="L817">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L818">		}</span>
<span class="nc" id="L819">	}</span>

	public boolean updateSerie(Serie s, boolean last_season) {
<span class="nc" id="L822">		boolean dvdOrder = s.getDvdOrder();</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">		if (s == null) {</span>
<span class="nc" id="L824">			Log.e(TAG, &quot;Error: Serie is null&quot;);</span>
<span class="nc" id="L825">			return false;</span>
		}
<span class="nc" id="L827">		String tmpSOverview = &quot;&quot;;</span>
<span class="nc bnc" id="L828" title="All 4 branches missed.">		if (s.getOverview() != null &amp;&amp; !TextUtils.isEmpty(s.getOverview())) {</span>
<span class="nc" id="L829">			tmpSOverview = s.getOverview();</span>
		}
<span class="nc" id="L831">		String tmpSName = &quot;&quot;;</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">		if (!TextUtils.isEmpty(s.getSerieName())) {</span>
<span class="nc" id="L833">			tmpSName = s.getSerieName();</span>
		}
<span class="nc" id="L835">		Cursor cms = null;</span>
<span class="nc" id="L836">		int max_season = -1;</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">		if (last_season) {</span>
			try {
<span class="nc" id="L839">				cms = Query(&quot;SELECT &quot;</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">					+ (dvdOrder ? &quot;dvdSeason&quot; : &quot;season&quot;)</span>
<span class="nc" id="L841">					+&quot;FROM serie_seasons WHERE serieID='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc" id="L842">				cms.moveToFirst();</span>
<span class="nc bnc" id="L843" title="All 4 branches missed.">				if (cms != null &amp;&amp; cms.isFirst()) {</span>
					do {
<span class="nc bnc" id="L845" title="All 2 branches missed.">						if (max_season &lt; cms.getInt(0)) {</span>
<span class="nc" id="L846">							max_season = cms.getInt(0);</span>
						}
<span class="nc bnc" id="L848" title="All 2 branches missed.">					} while (cms.moveToNext());</span>
				}
<span class="nc" id="L850">				cms.close();</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">				Log.d(TAG, &quot;Updating only last&quot;+ (dvdOrder ? &quot; DVD &quot; : &quot;&quot;) +&quot;season &quot;+ max_season +&quot; and specials of &quot;+ tmpSName);</span>
<span class="nc" id="L852">			} catch (SQLiteException e) {</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">				if (cms != null) {</span>
<span class="nc" id="L854">					cms.close();</span>
				}
<span class="nc" id="L856">				Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L857">			}</span>
		} else {
<span class="nc bnc" id="L859" title="All 2 branches missed.">			Log.d(TAG, &quot;Updating all&quot;+ (dvdOrder ? &quot; DVD &quot; : &quot;&quot;) +&quot; seasons of &quot;+ tmpSName);</span>
		}
		// Log.d(TAG, &quot;MAX SEASON: &quot;+ max_season);
		try {
<span class="nc" id="L863">			db.beginTransaction();</span>
<span class="nc" id="L864">			db.execSQL(&quot;UPDATE series SET language='&quot;+ s.getLanguage() +&quot;', serieName=&quot;+ DatabaseUtils.sqlEscapeString(tmpSName)</span>
<span class="nc" id="L865">				+&quot;, overview=&quot;+ DatabaseUtils.sqlEscapeString(tmpSOverview) +&quot;, &quot;+&quot;firstAired='&quot;+ s.getFirstAired()</span>
<span class="nc" id="L866">				+&quot;', imdbId='&quot;+ s.getImdbId() +&quot;', zap2ItId='&quot;+ s.getZap2ItId()</span>
<span class="nc" id="L867">				+&quot;', airsDayOfWeek='&quot;+ s.getAirsDayOfWeek() +&quot;', airsTime='&quot;+ s.getAirsTime()</span>
<span class="nc" id="L868">				+&quot;', contentRating='&quot;+ s.getContentRating() +&quot;', &quot;+&quot;network='&quot;+ s.getNetwork()</span>
<span class="nc" id="L869">				+&quot;', rating='&quot;+ s.getRating() +&quot;', runtime='&quot;+ s.getRuntime() +&quot;', &quot;+&quot;status='&quot;</span>
<span class="nc" id="L870">				+ s.getStatus() +&quot;', lastUpdated='&quot;+ s.getLastUpdated() +&quot;' WHERE id='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc" id="L871">			db.execSQL(&quot;DELETE FROM serie_seasons WHERE serieId='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">			for (int n = 0; n &lt; s.getNSeasons().size(); n++) {</span>
<span class="nc" id="L873">				execQuery(&quot;INSERT INTO serie_seasons (serieId, season) &quot;+&quot;VALUES ('&quot;+ s.getId() +&quot;', '&quot;</span>
<span class="nc" id="L874">					+ s.getNSeasons().get(n) +&quot;');&quot;);</span>
			}
<span class="nc" id="L876">			db.execSQL(&quot;DELETE FROM actors WHERE serieId='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">			for (int a = 0; a &lt; s.getActors().size(); a++) {</span>
<span class="nc" id="L878">				execQuery(&quot;INSERT INTO actors (serieId, actor) &quot;+&quot;VALUES ('&quot;+ s.getId()</span>
<span class="nc" id="L879">				+&quot;',&quot;+ DatabaseUtils.sqlEscapeString(s.getActors().get(a)) +&quot;);&quot;);</span>
			}
<span class="nc" id="L881">			db.execSQL(&quot;DELETE FROM genres WHERE serieId='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">			for (int g = 0; g &lt; s.getGenres().size(); g++) {</span>
<span class="nc" id="L883">				execQuery(&quot;INSERT INTO genres (serieId, genre) &quot;+&quot;VALUES ('&quot;+ s.getId()</span>
<span class="nc" id="L884">				+&quot;',&quot;+ DatabaseUtils.sqlEscapeString(s.getGenres().get(g)) +&quot;);&quot;);</span>
			}
			
<span class="nc bnc" id="L887" title="All 2 branches missed.">			String seasonType = dvdOrder ? &quot;dvdSeason&quot; : &quot;seasonNumber&quot;;</span>
			
<span class="nc bnc" id="L889" title="All 2 branches missed.">			if (max_season != -1) {</span>
<span class="nc" id="L890">				String episodes = &quot;&quot;;</span>
<span class="nc" id="L891">				cms = Query(&quot;SELECT id FROM episodes WHERE serieId='&quot;+ s.getId() +&quot;' AND (&quot;</span>
					+ seasonType +&quot;=&quot;+ max_season +&quot; OR &quot;+ seasonType +&quot;=0)&quot;);
<span class="nc" id="L893">				cms.moveToFirst();</span>
<span class="nc bnc" id="L894" title="All 4 branches missed.">				if (cms != null &amp;&amp; cms.isFirst()) {</span>
					do {
<span class="nc" id="L896">						episodes += &quot;'&quot;+ cms.getString(0) +&quot;', &quot;;</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">					} while (cms.moveToNext());</span>
				}
<span class="nc" id="L899">				cms.close();</span>
<span class="nc" id="L900">				episodes = episodes.substring(0, episodes.length() - 2);</span>
<span class="nc" id="L901">				db.execSQL(&quot;DELETE FROM directors WHERE serieId='&quot;+ s.getId() +&quot;' AND episodeId IN (&quot;+ episodes +&quot;)&quot;);</span>
<span class="nc" id="L902">				db.execSQL(&quot;DELETE FROM guestStars WHERE serieId='&quot;+ s.getId() +&quot;' AND episodeId IN (&quot;+ episodes +&quot;)&quot;);</span>
<span class="nc" id="L903">				db.execSQL(&quot;DELETE FROM writers WHERE serieId='&quot;+ s.getId() +&quot;' AND episodeId IN (&quot;+ episodes +&quot;)&quot;);</span>
<span class="nc" id="L904">			} else {</span>
<span class="nc" id="L905">				db.execSQL(&quot;DELETE FROM directors WHERE serieId='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc" id="L906">				db.execSQL(&quot;DELETE FROM guestStars WHERE serieId='&quot;+ s.getId() +&quot;'&quot;);</span>
<span class="nc" id="L907">				db.execSQL(&quot;DELETE FROM writers WHERE serieId='&quot;+ s.getId() +&quot;'&quot;);</span>
			}

<span class="nc" id="L910">			List&lt;EpisodeSeen&gt; seenEpisodes = getSeen(s.getId(), max_season, dvdOrder);</span>
<span class="nc" id="L911">			db.execSQL(&quot;DELETE FROM episodes WHERE serieId='&quot;+ s.getId() +&quot;'&quot;</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">				+ (max_season != -1 ? &quot; AND (&quot;+ seasonType +&quot;=&quot;+ max_season +&quot; OR &quot;+ seasonType +&quot;=0)&quot; : &quot;&quot;));</span>
			
<span class="nc bnc" id="L914" title="All 2 branches missed.">			for (int e = 0; e &lt; s.getEpisodes().size(); e++) {</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">				if (max_season != -1) {</span>
<span class="nc" id="L916">					int season = s.getEpisodes().get(e).getSeasonNumber();</span>
<span class="nc bnc" id="L917" title="All 4 branches missed.">					if (season &lt; max_season &amp;&amp; season != 0) {	// include specials in update</span>
<span class="nc" id="L918">						continue;</span>
					}
				}
				
<span class="nc" id="L922">				Episode ep = s.getEpisodes().get(e); </span>
				
<span class="nc bnc" id="L924" title="All 6 branches missed.">				if (ep.getEpisodeNumber() == 0 &amp;&amp; ep.getEpisodeName().equals(&quot; &quot;) &amp;&amp; ep.getOverview() == null) {</span>
<span class="nc" id="L925">					continue;</span>
				}
								
<span class="nc bnc" id="L928" title="All 2 branches missed.">				for (int d = 0; d &lt; ep.getDirectors().size(); d++) {</span>
<span class="nc" id="L929">					execQuery(&quot;INSERT INTO directors (serieId, episodeId, director) &quot;+&quot;VALUES ('&quot;</span>
<span class="nc" id="L930">						+ s.getId() +&quot;', '&quot;+ ep.getId()</span>
<span class="nc" id="L931">						+&quot;',&quot;+ DatabaseUtils.sqlEscapeString(ep.getDirectors().get(d)) +&quot;);&quot;);</span>
				}
<span class="nc bnc" id="L933" title="All 2 branches missed.">				for (int g = 0; g &lt; ep.getGuestStars().size(); g++) {</span>
<span class="nc" id="L934">					execQuery(&quot;INSERT INTO guestStars (serieId, episodeId, guestStar) &quot;+&quot;VALUES ('&quot;</span>
<span class="nc" id="L935">						+ s.getId() +&quot;', '&quot;+ ep.getId()</span>
<span class="nc" id="L936">						+&quot;',&quot;+ DatabaseUtils.sqlEscapeString(ep.getGuestStars().get(g)) +&quot;);&quot;);</span>
				}
<span class="nc bnc" id="L938" title="All 2 branches missed.">				for (int w = 0; w &lt; ep.getWriters().size(); w++) {</span>
<span class="nc" id="L939">					execQuery(&quot;INSERT INTO writers (serieId, episodeId, writer) &quot;+&quot;VALUES ('&quot;+ s.getId()</span>
<span class="nc" id="L940">						+&quot;', '&quot;+ ep.getId()</span>
<span class="nc" id="L941">						+&quot;',&quot;+ DatabaseUtils.sqlEscapeString(ep.getWriters().get(w)) +&quot;);&quot;);</span>
				}
<span class="nc" id="L943">				String tmpOverview = &quot;&quot;;</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">				if (ep.getOverview() != null) {</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">					if (!TextUtils.isEmpty(ep.getOverview())) {</span>
<span class="nc" id="L946">						tmpOverview = ep.getOverview();</span>
					}
				}
<span class="nc" id="L949">				String tmpName = &quot;&quot;;</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">				if (ep.getEpisodeName() != null) {</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">					if (!TextUtils.isEmpty(ep.getEpisodeName())) {</span>
<span class="nc" id="L952">						tmpName = ep.getEpisodeName();</span>
					}
				}
				
<span class="nc" id="L956">				long iseen = 0;</span>
<span class="nc" id="L957">				String epCode = ep.getSeasonNumber() +&quot;x&quot;+ ep.getEpisodeNumber();</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">				for (EpisodeSeen es : seenEpisodes) {</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">					if (epCode.equals(es.episode)) {</span>
<span class="nc" id="L960">						iseen = es.seen;</span>
<span class="nc" id="L961">						break;</span>
					}
<span class="nc" id="L963">				}</span>
								
<span class="nc bnc" id="L965" title="All 2 branches missed.">				if (!tmpName.equals(&quot;&quot;)) {</span>
<span class="nc" id="L966">					execQuery(&quot;INSERT INTO episodes (serieId, id, combinedEpisodeNumber, combinedSeason, &quot;</span>
						+&quot;dvdChapter, dvdDiscId, dvdEpisodeNumber, dvdSeason, epImgFlag, episodeName, &quot;
						+&quot;episodeNumber, firstAired, imdbId, language, overview, productionCode, rating, seasonNumber, &quot;
						+&quot;absoluteNumber, filename, lastUpdated, seasonId, seen) VALUES ('&quot;
<span class="nc" id="L970">						+ s.getId()</span>
						+&quot;', '&quot;
<span class="nc" id="L972">						+ ep.getId()</span>
						+&quot;', '&quot;
<span class="nc" id="L974">						+ ep.getCombinedEpisodeNumber()</span>
						+&quot;', '&quot;
<span class="nc" id="L976">						+ ep.getCombinedSeason()</span>
						+&quot;', '&quot;
<span class="nc" id="L978">						+ ep.getDvdChapter()</span>
						+&quot;', '&quot;
<span class="nc" id="L980">						+ ep.getDvdDiscId()</span>
						+&quot;', '&quot;
<span class="nc" id="L982">						+ ep.getEpisodeNumber()</span>
						+&quot;', '&quot;
<span class="nc" id="L984">						+ ep.getDvdSeason()</span>
						+&quot;', '&quot;
<span class="nc" id="L986">						+ ep.getEpImgFlag()</span>
						+&quot;',&quot;
<span class="nc" id="L988">						+ DatabaseUtils.sqlEscapeString(tmpName)</span>
						+&quot;, &quot;
<span class="nc" id="L990">						+ ep.getEpisodeNumber()</span>
						+&quot;, '&quot;
<span class="nc" id="L992">						+ ep.getFirstAired()</span>
						+&quot;', '&quot;
<span class="nc" id="L994">						+ ep.getImdbId()</span>
						+&quot;', '&quot;
<span class="nc" id="L996">						+ ep.getLanguage()</span>
						+&quot;',&quot;
<span class="nc" id="L998">						+ DatabaseUtils.sqlEscapeString(tmpOverview)</span>
						+&quot;, '&quot;
<span class="nc" id="L1000">						+ ep.getProductionCode()</span>
						+&quot;', '&quot;
<span class="nc" id="L1002">						+ ep.getRating()</span>
						+&quot;', &quot;
<span class="nc" id="L1004">						+ ep.getSeasonNumber()</span>
						+&quot;, '&quot;
<span class="nc" id="L1006">						+ ep.getAbsoluteNumber()</span>
						+&quot;', '&quot;
<span class="nc" id="L1008">						+ ep.getFilename()</span>
						+&quot;', '&quot;
<span class="nc" id="L1010">						+ ep.getLastUpdated()</span>
						+&quot;', '&quot;
<span class="nc" id="L1012">						+ ep.getSeasonId() +&quot;', &quot;+ iseen +&quot;);&quot;);</span>
				}
			}
<span class="nc" id="L1015">			db.setTransactionSuccessful();</span>
<span class="nc" id="L1016">		} catch (SQLiteException e) {</span>
<span class="nc" id="L1017">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L1018">			return false;</span>
		} finally {
<span class="nc" id="L1020">			db.endTransaction();</span>
		}
<span class="nc" id="L1022">		updateShowStats(s.getId());</span>
<span class="nc" id="L1023">		return true;</span>
	}

	/* Delete Methods */
	// DELETE FROM table_name WHERE some_column=some_value
	public boolean deleteSerie(String serieId) {
<span class="fc" id="L1029">		boolean result = true;</span>
<span class="fc" id="L1030">		Cursor c = Query(&quot;SELECT posterThumb FROM series WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
		try {
<span class="fc" id="L1032">			db.beginTransaction();</span>
<span class="fc" id="L1033">			db.execSQL(&quot;DELETE FROM directors WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1034">			db.execSQL(&quot;DELETE FROM guestStars WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1035">			db.execSQL(&quot;DELETE FROM writers WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1036">			db.execSQL(&quot;DELETE FROM episodes WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1037">			db.execSQL(&quot;DELETE FROM actors WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1038">			db.execSQL(&quot;DELETE FROM genres WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1039">			db.execSQL(&quot;DELETE FROM serie_seasons WHERE serieId='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1040">			c.moveToFirst();</span>
<span class="pc bpc" id="L1041" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst()) {</span>
<span class="fc" id="L1042">				File thumbImage = new File(c.getString(0));</span>
<span class="fc" id="L1043">				thumbImage.delete();</span>
			}
<span class="fc" id="L1045">			db.execSQL(&quot;DELETE FROM series WHERE id='&quot;+ serieId +&quot;'&quot;);</span>
<span class="fc" id="L1046">			db.setTransactionSuccessful();</span>
<span class="nc" id="L1047">		} catch (SQLiteException e) {</span>
<span class="nc" id="L1048">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L1049">			result = false;</span>
		} finally {
<span class="fc" id="L1051">			db.endTransaction();</span>
		}
<span class="pc bpc" id="L1053" title="1 of 2 branches missed.">		if (c != null) c.close();</span>
<span class="fc" id="L1054">		return result;</span>
	}
	
	public boolean deleteEpisode(String serieId, String episodeId) {
		try {
<span class="nc" id="L1059">			db.beginTransaction();</span>
<span class="nc" id="L1060">			db.execSQL(&quot;DELETE FROM directors WHERE serieId='&quot;+ serieId +&quot;' AND episodeId='&quot;+ episodeId +&quot;'&quot;);</span>
<span class="nc" id="L1061">			db.execSQL(&quot;DELETE FROM guestStars WHERE serieId='&quot;+ serieId +&quot;' AND episodeId='&quot;+ episodeId +&quot;'&quot;);</span>
<span class="nc" id="L1062">			db.execSQL(&quot;DELETE FROM writers WHERE serieId='&quot;+ serieId +&quot;' AND episodeId='&quot;+ episodeId +&quot;'&quot;);</span>
<span class="nc" id="L1063">			db.execSQL(&quot;DELETE FROM episodes WHERE serieId='&quot;+ serieId +&quot;' AND id='&quot;+ episodeId +&quot;'&quot;);</span>
<span class="nc" id="L1064">			db.setTransactionSuccessful();</span>
<span class="nc" id="L1065">		} catch (SQLiteException e) {</span>
<span class="nc" id="L1066">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L1067">			return false;</span>
		} finally {
<span class="nc" id="L1069">			db.endTransaction();</span>
		}
<span class="nc" id="L1071">		updateShowStats(serieId);</span>
<span class="nc" id="L1072">		return true;</span>
	}

	/* *********************************************************************************** */
	@Override
	public synchronized void close() {
<span class="nc bnc" id="L1078" title="All 2 branches missed.">		if (db != null) db.close();</span>
<span class="nc" id="L1079">		super.close();</span>
<span class="nc" id="L1080">	}</span>

	@Override
	public void onCreate(SQLiteDatabase dbase) {
		try {
<span class="nc" id="L1085">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS droidseries (version VARCHAR);&quot;);</span>
<span class="nc" id="L1086">			dbase.execSQL(&quot;INSERT INTO droidseries (version) VALUES ('0.1.5-7G4');&quot;);</span>
			// tabela dos directors
<span class="nc" id="L1088">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS directors (serieId VARCHAR, episodeId VARCHAR, director VARCHAR);&quot;);</span>
			// tabela dos guestStars
<span class="nc" id="L1090">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS guestStars (serieId VARCHAR, episodeId VARCHAR, guestStar VARCHAR);&quot;);</span>
			// tabela dos writers
<span class="nc" id="L1092">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS writers (serieId VARCHAR, episodeId VARCHAR, writer VARCHAR);&quot;);</span>
			// tabela dos episodios
<span class="nc" id="L1094">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS episodes (serieId VARCHAR, id VARCHAR, &quot;</span>
				+&quot;combinedEpisodeNumber VARCHAR, combinedSeason VARCHAR, dvdChapter VARCHAR, &quot;
				+&quot;dvdDiscId VARCHAR, dvdEpisodeNumber VARCHAR, dvdSeason VARCHAR, &quot;
				+&quot;epImgFlag VARCHAR, episodeName VARCHAR, episodeNumber INT, &quot;
				+&quot;firstAired VARCHAR, imdbId VARCHAR, language VARCHAR, overview TEXT, &quot;
				+&quot;productionCode VARCHAR, rating VARCHAR, seasonNumber INT, &quot;
				+&quot;absoluteNumber VARCHAR, filename VARCHAR,lastUpdated VARCHAR, &quot;
				+&quot;seasonId VARCHAR, seen INT);&quot;);
			// tabela dos actores
<span class="nc" id="L1103">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS actors (serieId VARCHAR, actor VARCHAR);&quot;);</span>
			// tabela dos genres
<span class="nc" id="L1105">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS genres (serieId VARCHAR, genre VARCHAR);&quot;);</span>
			// tabela das seasons
<span class="nc" id="L1107">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS serie_seasons (serieId VARCHAR, season VARCHAR);&quot;);</span>
			// create tables
<span class="nc" id="L1109">			dbase.execSQL(&quot;CREATE TABLE IF NOT EXISTS series (id VARCHAR PRIMARY KEY, &quot;</span>
				+&quot;serieId VARCHAR, language VARCHAR, serieName VARCHAR, banner VARCHAR, &quot;
				+&quot;overview TEXT, firstAired VARCHAR, imdbId VARCHAR, zap2ItId VARCHAR, &quot;
				+&quot;airsDayOfWeek VARCHAR, airsTime VARCHAR, contentRating VARCHAR, &quot;
				+&quot;network VARCHAR, rating VARCHAR, runtime VARCHAR, status VARCHAR, &quot;
				+&quot;fanart VARCHAR, lastUpdated VARCHAR, passiveStatus INTEGER DEFAULT 0, poster VARCHAR, &quot;
				+&quot;posterInCache VARCHAR, posterThumb VARCHAR, &quot;
				+&quot;seasonCount INTEGER, unwatchedAired INTEGER, unwatched INTEGER, nextEpisode VARCHAR, nextAir VARCHAR, &quot;
				+&quot;extResources VARCHAR NOT NULL DEFAULT '', &quot;
				+&quot;dvdOrder TINYINT NOT NULL DEFAULT 0);&quot;);
<span class="nc" id="L1119">		} catch (SQLiteException e) {</span>
<span class="nc" id="L1120">			Log.e(TAG, e.getMessage());</span>
<span class="nc" id="L1121">		}</span>
<span class="nc" id="L1122">	}</span>

	@Override
	public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		// TODO Auto-generated method stub
<span class="nc" id="L1127">	}</span>
	
	public void updateShowStats() {
<span class="nc" id="L1130">		List&lt;String&gt; series = getSeries(2, false, null);	// 2 = archive and current shows, false = don't filter networks, null = ignore networks filter</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">		for (int i = 0; i &lt; series.size(); i += 1)</span>
<span class="nc" id="L1132">			updateShowStats(series.get(i));</span>
<span class="nc" id="L1133">	}</span>
	
	public void updateShowStats(String serieId) {
<span class="fc" id="L1136">		boolean dvdOrder = false;</span>
<span class="fc" id="L1137">		Cursor c = Query(&quot;SELECT dvdOrder FROM series WHERE serieID=&quot;+ serieId);</span>
		try {
<span class="fc" id="L1139">			c.moveToFirst();</span>
<span class="pc bpc" id="L1140" title="2 of 4 branches missed.">			if (c != null &amp;&amp; c.isFirst())</span>
<span class="nc bnc" id="L1141" title="All 2 branches missed.">				dvdOrder = c.getInt(0) == 1;</span>
<span class="nc" id="L1142">		} catch (SQLiteException e) {</span>
<span class="nc" id="L1143">			Log.e(TAG, e.getMessage());</span>
<span class="fc" id="L1144">		}</span>
		
<span class="fc" id="L1146">		int seasonCount = getSeasonCount(serieId);</span>
<span class="fc" id="L1147">		int unwatchedAired = getEpsUnwatchedAired(serieId, dvdOrder);</span>
<span class="fc" id="L1148">		int unwatched = getEpsUnwatched(serieId, dvdOrder);</span>
<span class="fc" id="L1149">		NextEpisode nextEpisode = getNextEpisode(serieId, dvdOrder);</span>
<span class="pc bpc" id="L1150" title="5 of 6 branches missed.">		String nextEpisodeString = getNextEpisodeString(nextEpisode, DroidShows.showNextAiring &amp;&amp; 0 &lt; unwatchedAired &amp;&amp; unwatchedAired &lt; unwatched);</span>
<span class="fc" id="L1151">		execQuery(&quot;UPDATE series SET seasonCount=&quot;+ seasonCount +&quot;, unwatchedAired=&quot;+ unwatchedAired +&quot;, unwatched=&quot;+ unwatched +&quot;, nextEpisode='&quot;+ nextEpisodeString +&quot;', nextAir='&quot;+ nextEpisode.firstAired +&quot;' WHERE id=&quot;+ serieId);</span>
<span class="fc" id="L1152">	}</span>
	
	public void updateToday(String newToday) {
<span class="nc" id="L1155">		today = newToday;</span>
<span class="nc" id="L1156">	}</span>
	
	private class EpisodeSeen {
		public String episode;
		public long seen;
		
<span class="nc" id="L1162">		public EpisodeSeen(String episode, long seen) {</span>
<span class="nc" id="L1163">			this.episode = episode;</span>
<span class="nc" id="L1164">			this.seen = seen;</span>
<span class="nc" id="L1165">		}</span>
	}
	
	public class EpisodeRow {
		public String id;
		public String name;
		public String aired;
		public Date airedDate;
		public long seen;
		
<span class="fc" id="L1175">		public EpisodeRow(String id, String name, String aired, Date airedDate, long seen2) {</span>
<span class="fc" id="L1176">			this.id = id;</span>
<span class="fc" id="L1177">			this.name = name;</span>
<span class="fc" id="L1178">			this.aired = aired;</span>
<span class="fc" id="L1179">			this.airedDate = airedDate;</span>
<span class="fc" id="L1180">			this.seen = seen2;</span>
<span class="fc" id="L1181">		}</span>
	}
	
	public class NextEpisode {
		public String serieId;
		public int season;
		public int episode;
		public String firstAired;
<span class="fc" id="L1189">		public Date firstAiredDate = null;</span>
		
<span class="fc" id="L1191">		public NextEpisode(String serieId, int season, int episode, String firstAired) {</span>
<span class="fc" id="L1192">			this.serieId = serieId;</span>
<span class="fc" id="L1193">			this.season = season;</span>
<span class="fc" id="L1194">			this.episode = episode;</span>
<span class="fc" id="L1195">			this.firstAired = firstAired;</span>
<span class="pc bpc" id="L1196" title="2 of 4 branches missed.">			if (!firstAired.equals(&quot;&quot;) &amp;&amp; !firstAired.equals(&quot;null&quot;)) {</span>
<span class="fc" id="L1197">				try { this.firstAiredDate = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(firstAired);	// used by seasons AsyncTask, so shouldn't use dateFormat</span>
<span class="pc" id="L1198">				} catch (ParseException e) { e.printStackTrace(); }</span>
			}
<span class="fc" id="L1200">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>Generated by the Android Gradle plugin 7.3.0</div></body></html>